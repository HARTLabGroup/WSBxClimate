---
title: "Supplemental Information for: Drought may initiate western spruce budworm outbreaks, but multi-year periods of increased moisture availability promote widespread defoliation"
author: "Sarah J. Hart, Olivia Santiago, Josh Carrell, and Thomas T. Veblen"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
  bookdown::word_document2: 
    reference_docx: Template.docx
    fig_caption: yes
    number_sections: no
    toc: no
    df_print: kable
editor_options: 
  chunk_output_type: inline
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}

knitr::opts_chunk$set(
  echo = FALSE,
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*30) # timeout downloads that last longer than 30 minutes

### Import libraries
if (!require("remotes"))  install.packages("remotes")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, # modeling 
  ggplot2, # figures
  patchwork, # combining figures
  ggsci, # color palettes
  dplR, # basic dendrochronology
  dfoliatR, # dendroecology 
  zoo, # time series
  factoextra, # multivariate analyses
  forcats, # categorical data
  GGally, # easy data exploration
  colorspace, # color palettes
  RColorBrewer, # color palettes
  knitr, # markdown documents
  kableExtra, # tables in markdown
  flextable, # other table options
  bookdown, # figure numbering in markdown
  sf, # spatial data (new pkg)
  terra, # raster data (new pkg)
  raster, # raster data (old pkg)
  ncdf4, #import ncdf files
  tmap, # easy plotting of maps
  ncf, # spatial covariance
  RCurl, # downloading data via curl
  MASS, # mixed effect modelling
  nlme, # mixed effect modelling
  synchrony,
  remotes,
  readxl, # read excel files
  terrainr # dem
) 

# Set plotting options
options(scipen=999)
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')
```

# Supplemental Information

## Appendix A

```{r hostmeta, results="show"}
host.meta <- read.csv(here("Data", "TreeRing", "Processed", "host-keymeta.csv"))


nonhost.meta <- read.csv(here("Data", "TreeRing", "Processed", "nonhost-keymeta.csv"))
hostxnonhost <-read.csv(here("Results/hostXnonhost-subset.csv"))
host.meta.sub <- host.meta %>% filter(SeriesCode %in% hostxnonhost$host)
host.meta.sub$SeriesCode <- factor(host.meta.sub$SeriesCode, level=c("TI", "SP", "NI", "LJ", "WB", "B19", "B18", "SS", "WW", "SR", "WR","JP"), ordered = T)
#host.meta.sub <- host.meta.sub[!host.meta.sub$SeriesCode=="TI",]


select.nonhost.sites <- unique(c(hostxnonhost$nonhost1,hostxnonhost$nonhost2,hostxnonhost$nonhost3))
nonhost.meta.sub <- nonhost.meta[nonhost.meta$SeriesCode %in% select.nonhost.sites, ]


host.meta.sub.print <- host.meta.sub[,c("SeriesCode", "SiteName", "nseries", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd", "Citation")]
host.meta.sub.print <- host.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
host.meta.sub.print$"Interseries r" <- paste0(host.meta.sub.print$"Interseries r" , ")")

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
host.meta.sub.print$"Autocorrelation" <- paste0(host.meta.sub.print$"Autocorrelation" , ")")

host.meta.sub.print <- host.meta.sub.print[,c("SeriesCode", "SiteName", "nseries", "Interseries r", "Autocorrelation")]

colnames(host.meta.sub.print)<- c("Site ID", "Site Name", "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation")

ft <- flextable(host.meta.sub.print) 
ft <- set_caption(ft, caption="Chronology statistics for host sites.")
ft %>% autofit() %>% fit_to_width(7.5)
```

\pagebreak

```{r nonhostmeta}
nonhost.meta.sub.print <- nonhost.meta.sub[,c("SeriesCode", "SiteName", "Lat", "Lon", "EarliestYr", "LatestYr", "nseries", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd", "Citation")]
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(Lat:Lon), ~round(., 3))
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Years", EarliestYr:LatestYr, sep="-")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Interseries r" <- paste0(nonhost.meta.sub.print$"Interseries r" , ")")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Autocorrelation" <- paste0(nonhost.meta.sub.print$"Autocorrelation" , ")")

nonhost.meta.sub.print <- nonhost.meta.sub.print[,c("SeriesCode", "SiteName", "Lat", "Lon", "Years", "nseries", "Interseries r", "Autocorrelation")]

colnames(nonhost.meta.sub.print)<- c("Site ID", "Site Name", "Latitude\n(degrees)", "Longitude\n(degrees)", "Chronology\nlength\n(years)" , "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation")
nonhost.meta.sub.print$Citation <- c("Woodhouse and Brown (2002)","Woodhouse and Losleben (2005)", "Woodhouse et al. (2015)", "Woodhouse et al. (2006a)", "Woodhouse et al. (2006b)", "Woodhouse et al. (2010)", "Woodhouse et al. (2019a)", "Graybill (2002a); Woodhouse et al. (2006c)", "Veblen et al. (2001); Smith et al. (unpublished)", "Graybill (2002b); Smith et al. (unpublished)", "Graybill (2002c); Woodhouse et al. (2019b)", "Graybill (1997); Woodhouse and Lukas (2010); Smith et al. (unpublished)")

ft <- flextable(nonhost.meta.sub.print) 
ft <- set_caption(ft, caption="Site and chronology statistics for nonhost sites.")
ft %>% autofit() %>% fit_to_width(7.5)
```

[@woodhouse2002NOAAWDSPaleoclimatology; @woodhouse2006NOAAWDSPaleoclimatologyb; @woodhouse2015NOAAWDSPaleoclimatology; @woodhouse2006NOAAWDSPaleoclimatology; @woodhouse2006NOAAWDSPaleoclimatologya; @woodhouse2010NOAAWDSPaleoclimatology; @woodhouse2019NOAAWDSPaleoclimatology; @graybill2002NOAAWDSPaleoclimatology; @woodhouse2006NOAAWDSPaleoclimatologyc; @veblen2000; @graybill2002NOAAWDSPaleoclimatologyc; @woodhouse2019NOAAWDSPaleoclimatologya; @graybill1997NOAAWDSPaleoclimatology; @woodhouse2010NOAAWDSPaleoclimatologya]

\pagebreak

```{r FigPercDefol, fig.cap="Site-level outbreak records expressed as the percent of trees recording an infestation.", out.width="4.48in", results="show"}
knitr::include_graphics(here("Results", "Figures", "Fig-PercentDefoliated.jpg"))
```

\pagebreak

```{r colonizationtab, results='show'}
colonization.results <- read.csv(here("Results", "colonization.csv"))[,-1]
colnames(colonization.results) <- c("Response", "Coefficient", "p value")
ft <- flextable(colonization.results) 
ft <- set_caption(ft, caption="Summary of modelling results testing the effect of Euro-Americans on WSB outbreak dynamics and ecological effects .")
ft %>% autofit() %>% fit_to_width(7.5)
```

```{r FigPairwiseCor,  fig.cap="Pairwise Spearman's correlation between time series of the percent of trees defoliated at each site.", out.width = "4.48in", out.height="3in", results="show"}
knitr::include_graphics(here("Results", "Figures", "Fig-PairwiseCorrelation.jpg"))
```

```{r FigCovarianceSCPDSI, fig.cap="Nonparametric spatial covariance function describing the covarinace among times series SC-PDSI at all 12 sites across study area. SC-PDSI time series are derived from 4 x 4 km PRISM data for the period 1895-2022. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-SCPDSI.jpg"))
```

```{r FigCovarianceNonHost, fig.cap="Nonparametric spatial covariance function describing the covarinace among the 12 drought-sensitive ponderosa pine chronologies used to reconstruct WSB histories. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Nonhost.jpg"))
```

```{r FigCovarianceTime, fig.cap="Nonparametric spatial covariance function describing the covarinace among time series of the percent of trees defoliated at site for the 1730-1998 and the centuries prior to and following  extensive Euro-American settlement (1750-1848 and 1890-1989, respectively). Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "7in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Multi.jpg"))
```

```{r FigSEASiteInitiation, fig.cap="Superposed epoch analyses results illustrating the departure from the mean SC-PDSI for the years prior, during, and following outbreak initiation by site for the 1730-1998 period. Descending bars illustrate a negative association with SC-PDSI (i.e., drier conditions), ascending bars show a positive association with SC-PDSI (i.e., wetter conditions). Black bars indicate statistically significance at the 95% confidence interval.", out.width = "504pt", results="show"}
knitr::include_graphics(here("Results", "Figures", "SEA-initation-site.jpg"))
```

```{r FigSEASiteCessation, fig.cap="Superposed epoch analysis results illustrating the departure from the mean SC-PDSI for the years prior, during, and following outbreak cessation by site for the 1730-1998 period. Descending bars illustrate a negative association with SC-PDSI (i.e., drier conditions), ascending bars show a positive association with SC-PDSI (i.e., wetter conditions). Black bars indicate statistically significance at the 95% confidence interval.", out.width = "504pt", results="show"}
knitr::include_graphics(here("Results", "Figures", "SEA-cessation-site.jpg"))
```

\pagebreak

```{r PDSIperiodtab, results="show"}
results.timeperiod <-read.csv(here("Results", "results-timeperiod.csv"))[,-1]
results.timeperiod %>% as.data.frame() %>%  flextable() %>% set_caption(caption="Results of t-tests comparing the climate conditions in the dry period prior and wet period coincident outbreak initaiton with all periods of above average moisture availability.") %>%  autofit() %>% set_table_properties(layout = "autofit")
```

\pagebreak

## Appendix C

```{r historytab, results='show'}
history.tab <- read_excel(here("Documents", "PublishedOutbreakHistory.xlsx"), sheet=1)
colnames(history.tab) <- c("Start", "End", "Duration\n(years)", "Study area", "Source")

history.tab %>% as.data.frame() %>%  flextable() %>% set_caption(caption="Published periods of WSB outbreak in Colorado.") %>%  autofit() %>% set_table_properties(layout = "autofit")
```

[@ryerson2003TreeringReconstructionWestern; @weber1995DendroecologicalReconstructionWestern; @swetnam1989TreeringReconstructionWestern; @hadleyStandResponseWestern1993]

# References

::: {#refs}
:::
