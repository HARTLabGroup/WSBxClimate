---
title: "Spatial data for: Drought may initiate western spruce budworm outbreaks, but multi-year periods of increased moisture availability promote widespread defoliation"
author: "Sarah J. Hart, Olivia Santiago, Josh Carrell, and Thomas T. Veblen"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
   officedown::rdocx_document:
     reference_docx: Template.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
  echo = FALSE,
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300,
  fig.align = 'center'
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*30) # timeout downloads that last longer than 30 minutes

### Import libraries
if (!require("remotes"))  install.packages("remotes")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  rmarkdown, # 
  flextable, # tables
  officer, # word documents
  bookdown, # word documents
  tidyverse, # data manipulation
  ggplot2, # figures
  RColorBrewer, # color palettes
  patchwork, # combining figures
  sf, # spatial data
  terra, # raster data (new pkg)
  raster, # raster data (old pkg)
  ncdf4, #import ncdf files
  tmap, # easy plotting of maps
  tmaptools, # helper library for tmap
  grid, # useful for plotting inset map
  terrainr, # dem
  prism # prism data
) 

proj.proj <- 4629

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')

# Set directory structure for project
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Overview

The following code will download the necessary spatial data for the study.

# Spatial data

## Basic Geographic data

We obtained spatial data describing state boundaries from the US Census Bureau (<https://www.census.gov/geographies/mapping-files.html>).

```{r DL_States, echo=T}
# states
dir.create(here("Data", "Spatial", "States"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "States", "cb_2018_us_state_20m.zip")
if(!file.exists(temp)){
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "States"))
}
```

We obtained point data describing the location of Colorado cities and towns from the Colorado Department of Health and Environment Open Data Portal (<https://data-cdphe.opendata.arcgis.com/>).

```{r DL_Cites, echo=T}
# Colorado cities
dir.create(here("Data", "Spatial", "Cities"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Cities", "Colorado_City_Point_Locations.zip")
if(!file.exists(temp)){
  download.file("https://hub.arcgis.com/api/v3/datasets/b20b5c04576145be9428b4b4f28490c2_0/downloads/data?format=shp&spatialRefId=4269&where=1%3D1", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Cities"))
}
```

### Ecoregions

We obtained Level III Ecoregion data for the United States from the US Environmental Protection Agency (<https://www.epa.gov/eco-research/ecoregions-north-america>).

```{r DL_EcoRegions, echo=T}
#EcoRegions
dir.create(here("Data","Spatial", "EcoRegions"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "EcoRegions","us_eco_l3.zip")
if(!file.exists(temp)){
  download.file("https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l3.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "EcoRegions"))
}
```

### Digital Elevation Model

We obtained a 250 m resolution Digital Elevation Model (DEM) for the study area from the National Elevation Dataset (NED) using the terrainr package [@terrainr2021].

```{r DEM, echo=T}
if(!file.exists(here("Data", "Spatial", "DEM", "DEM250.tif"))){
  # Southern Rockies
  srm <- st_read(here("Data", "Spatial", "EcoRegions", "us_eco_l3", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs=5071) %>% st_buffer(20000)
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)

 # 250 m 
  dem <- get_tiles(data=srm, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- rast(dem$elevation)
  writeRaster(dem.rast, here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
}
```

## Douglas fir distribution

## Disturbance data

We acquired polygon data describing the extent of burned areas for the 1984-2023 period from the Monitoring Trends in Burn Severity Project [-@mtbsprojectMTBSDataAccess2022] (mtbs.gov).

```{r DL_MTBS, echo=T}
# MTBS 
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_perimeter_data.zip")
if(!file.exists(temp)){
  download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}
```

### Aerial Detection Survey Data

To characterize recent history of WSB outbreaks across the study area, we acquired Aerial Detection Survey data for Region 2 from the USFS [-@usfsanditspartners2020USDAForestService] (<https://www.fs.usda.gov/science-technology/data-tools-products/fhp-mapping-reporting/detection-surveys>).

```{r DL_ADS, echo=T}
dir.create(here("Data", "Spatial", "ADS"), showWarnings = FALSE)

temp <- here("Data", "Spatial", "ADS", "CONUS_Region2_AllYears.gdb.zip")
if(!file.exists(temp)){
  download.file("https://www.fs.usda.gov/foresthealth/docs/IDS_Data_for_Download/CONUS_Region2_AllYears.gdb.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "ADS"))
}
```

To characterize the distribution of Douglas fir across the study area, we acquired a 240 x 240 m raster describing tree presence intensity for Douglas fir in ca. 2002 from the USFS's Individual Tree Species Parameter Maps [@ellenwood2015]. Intensity was calculated by summing the number of a possible sixty four 30-meter pixels within a 240-meter pixel with presence of Douglas fir.

## Climate data

### North American Drought Atlas

We obtained multi-century (i.e., AD 1650-2005) records of the self-calibrating Palmer Drought Severity Index (SC-PDSI; [@wellsSelfCalibratingPalmerDrought2004, @palmer1965]) from the North American Drought Atlas (NADA), which provides tree-ring based reconstructions of June-August SC-PDSI on a 0.5Â° resolution grid [@cook2010].

```{r DL_NADA, echo=T}
if(!file.exists(here("Data", "Spatial", "NADA"))){
  dir.create(here("Data", "Spatial", "NADA"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "NADA", "nada_hd2_cl.nc")
  download.file("https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/nada_hd2_cl.nc", temp)
}
```

### PRISM

To characterize the study area's climate, we obtained monthly precipitation totals, minimum temperatures, and maximum temperature 30-year normals from PRISM [@prismclimategroup2021] using the prism package [@prism2021]. In addition to monthly climate data, we also obtained gridded June-August SC-PDSI data from the West Wide Drought Tracker [@abatzoglouWestWideDrought2017].

```{r DL_PRISM, echo=T}
if(!dir.exists(here("Data", "Spatial", "PRISM"))){
  dir.create(here("Data", "Spatial", "PRISM"), showWarnings = FALSE)
  prism_set_dl_dir(here("Data", "Spatial", "PRISM"))
  
  # Climate normals
  get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
  get_prism_normals("tmin", "800m", mon=1, keepZip = FALSE)
  get_prism_normals("tmax", "800m", mon=7, keepZip = FALSE)
  
  # Monthly climate data
  get_prism_monthlys(type = "tmean", year = 1895:2023, mon = 1:12, keepZip = FALSE)
  get_prism_monthlys(type = "ppt", year = 1895:2023, mon = 1:12, keepZip = FALSE)
  get_prism_monthlys(type = "vpdmax", year = 1895:2023, mon = 1:12, keepZip = FALSE)
  
  temp <- here("Data", "Spatial", "PRISM", "scpdsi_6_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_6_PRISM.nc", temp)

  temp <- here("Data", "Spatial", "PRISM", "scpdsi_7_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_7_PRISM.nc", temp)

  temp <- here("Data", "Spatial", "PRISM", "scpdsi_8_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_8_PRISM.nc", temp)
}
```

# Characterize study area

```{r Import_TreeRingSiteData}
host.meta <- read.csv(here("Data", "TreeRing", "Processed", "Host", "host-metadata.csv")) # import host metadata
nonhost.meta <- read.csv(here("Data", "TreeRing", "Processed", "Nonhost", "nonhost-metadata.csv")) # import nonhost metadata

hostXnonhost <- read.csv(here("Results", "hostXnonhost-subset.csv")) # import data describing the nonhost sites matched to each host site

host.meta.sub <- host.meta %>% filter(SeriesCode %in% hostXnonhost$host) # select only host sites 
  
select.nonhost.sites <- hostXnonhost[,c('nonhost1', 'nonhost2','nonhost3')] %>% unlist() %>% unique()
nonhost.meta.sub <- nonhost.meta[nonhost.meta$SeriesCode %in% select.nonhost.sites, ]
  
nonhost.sites <- st_as_sf(x = nonhost.meta.sub,  coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)

host.sites.sub <- st_as_sf(x = host.meta.sub, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)

host.sites <- st_as_sf(x = host.meta, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)
```

```{r CharacterizeClimate}
if(!file.exists(here("Results", "climate-norms-studyarea.csv"))){

  # Douglas fir
  if(!file.exists(here("Data", "Spatial", "ITSPM","f202.shp"))){
    df.rast <- rast(here("Data", "Spatial", "ITSPM","f202"))
    srm <- st_read(here("Data", "Spatial", "EcoRegions", "us_eco_l3", "us_eco_l3.shp"), quiet=T) %>% filter(US_L3NAME=="Southern Rockies") %>% st_transform(crs=st_crs(df.rast)) %>% vect()
    df.rast <- crop(df.rast, srm)
    df.rast[df.rast<10] <- NA
    df.rast[df.rast>=10] <- 1

    df.poly <- as.polygons(df.rast, aggregate=TRUE, values=TRUE, na.rm=TRUE) 
 
    writeVector(df.poly, here("Data", "Spatial", "ITSPM","f202.shp"), overwrite=T)
  }
  df.poly <-vect(here("Data", "Spatial", "ITSPM","f202.shp"))
  host.sites <- st_as_sf(x = host.meta, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(st_crs(df.poly)) %>% st_buffer(1000)
  df.poly <- crop(df.poly, host.sites)
  
  prism_set_dl_dir(here("Data", "Spatial", "PRISM"))
  
  ppt.normal <- prism_archive_subset("ppt", "annual normals", resolution="800m") %>% pd_to_file() %>% rast()
  tmin1.normal <- prism_archive_subset("tmin", "monthly normals", mon=1, resolution="800m") %>% pd_to_file() %>% rast()
  tmax7.normal <- prism_archive_subset("tmax", "monthly normals", mon=7, resolution="800m") %>% pd_to_file() %>% rast()
  
  dem <- rast(here( here("Data", "Spatial", "DEM", "DEM250.tif")))
  
  df.poly <- df.poly %>% project(ppt.normal)
  climate.normals <- data.frame(metric=c("mean", "min", "max"))
  
  climate.normals$PPT <- NA
  climate.normals[climate.normals$metric=="mean", ]$PPT <- terra::zonal(z=df.poly, x=ppt.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$PPT <- quantile(terra::extract(y=df.poly, x=tmin1.normal)[,2], 0.1)
  climate.normals[climate.normals$metric=="max", ]$PPT <- quantile(terra::extract(y=df.poly, x=tmin1.normal)[,2], 0.9)
  
  climate.normals$TMIN <- NA
  climate.normals[climate.normals$metric=="mean", ]$TMIN <- terra::zonal(z=df.poly, x=tmin1.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$TMIN <-  quantile(terra::extract(y=df.poly, x=tmin1.normal)[,2], 0.1)
  climate.normals[climate.normals$metric=="max", ]$TMIN <- quantile(terra::extract(y=df.poly, x=tmin1.normal)[,2], 0.9)
  
  climate.normals$TMAX <- NA
  climate.normals[climate.normals$metric=="mean", ]$TMAX <- terra::zonal(z=df.poly, x=tmax7.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$TMAX <-  quantile(terra::extract(y=df.poly, x=tmax7.normal)[,2], 0.1)
  climate.normals[climate.normals$metric=="max", ]$TMAX <- quantile(terra::extract(y=df.poly, x=tmax7.normal)[,2], 0.9)
  
  df.poly <- df.poly %>% project(dem)
  climate.normals$Elev <- NA
  climate.normals[climate.normals$metric=="mean", ]$Elev <- terra::zonal(z=df.poly, x=dem, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$Elev <-  quantile(terra::extract(y=df.poly, x=dem)$DEM250_3DEPElevation_1_1, 0.1)
  climate.normals[climate.normals$metric=="max", ]$Elev <- quantile(terra::extract(y=df.poly, x=dem)$DEM250_3DEPElevation_1_1, 0.9)

  write.csv(climate.normals, file=here("Results", "climate-norms-studyarea.csv"), row.names = F)
}
```

```{r FigStudyArea, results=F}
if(!file.exists(here("Results", "Figures", "FigStudyArea.jpg"))){
  states <- st_read(here("Data", "Spatial", "States", "cb_2018_us_state_20m.shp")) %>% st_transform(proj.proj)

  #Denver
  denver <- st_read(here("Data", "Spatial", "Cities", "Colorado_City_Point_Locations.shp")) %>% filter(NAME=="DENVER") %>% st_transform(proj.proj)


  douglasfir <- vect(here("Data", "Spatial", "ITSPM","f202.shp")) %>% project(nonhost.sites) %>% st_as_sf()
  
  x <- tmaptools::bb(nonhost.sites)
  x[1] <- -107; x[2] <- 38.1; x[3] <- -104; x[4] <- 41.25
  asp1 <- (x$ymax - x$ymin)/(x$xmax - x$xmin)
  sg <- bb_poly(nonhost.sites, projection = st_crs(nonhost.sites))

  
  studyarea <- tm_shape(douglasfir, bbox=x) +  tm_fill(col="#5ab4ac") + tm_shape(nonhost.sites) +tm_symbols(size=0.25, shape=21,col="darkgray", alpha=1) + tm_shape(host.sites.sub) +tm_symbols(size=0.25, shape=17, col="black") + tm_shape(denver) +tm_symbols(shape=8, size=0.5, col="black") + tm_text("NAME", just=c(-0.25,0), size=0.7, remove.overlap=T) +  tm_scale_bar(position = c(0.95,0.005), text.size=0.75, just="right", breaks=c(0,50), bg.color="white", bg.alpha = 0.8)+tm_compass(position=c("right", "top"), text.size=0.75, size=2, type="4star")+tm_graticules(lines=F)

  wus <- states %>% filter(STUSPS %in% c("WA", "OR", "CA", "ID", "NV", "AZ", "MT", "UT", "NM", "CO", "WY")) %>% st_transform(st_crs(douglasfir))
  xy <- st_bbox(wus)
  asp2 <- (xy$xmax - xy$xmin)/(xy$ymax - xy$ymin)
  
  insetmap = tm_shape(wus) + tm_fill(col="lightgrey") +
  tm_shape(wus) + tm_borders(lwd = 1, col="grey") +
  tm_shape(sg) + tm_borders(lw=2, col="black") +
  tm_layout(inner.margins = c(0.04,0.04,0.04,0.04), outer.margins=c(0,0,0,0))
  
  w <- 0.3
  h <- asp2 * w
  vp <- viewport(x=0.15, y=0.009, width = w, height=h, just=c("left", "bottom"))
  
  tmap_save(studyarea,filename=here("Results", "Figures", "FigStudyArea.jpg"),
          dpi=300, insets_tm=insetmap, insets_vp=vp,
          height=4.5, width=3.5, units="in")
}
```

# References
