---
title: "Drought may initiate western spruce budworm outbreaks, but multi-year periods of increased moisture availability promote widespread defoliation"
author: "Sarah J. Hart, Olivia Santiago, Josh D. Carrell, and Thomas T. Veblen"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
   officedown::rdocx_document:
     reference_docx: FEMTemplate.docx
bibliography: references.bib
csl: "`r here::here('citationstyle.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
  echo = FALSE,
	message = FALSE,
	warning = FALSE,
	progress = FALSE,
	cache = FALSE,
	dpi = 300,
  fig.align = 'center'
)

set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*30) # timeout downloads that last longer than 30 minutes

### Import libraries
if (!require("pacman")) install.packages("pacman")
if (!require("devtools")) install.packages("devtools")
#devtools::install_github("teunbrand/ggh4x") # commented out so that I can run code offline
pacman::p_load(
  rmarkdown, # 
  flextable, # tables
  officer, # word documents
  bookdown, # word documents
  here, # easy file structure
  tidyverse, # data manipulation
  data.table, # quickly reorder rows
  tidymodels, # modeling 
  ggplot2, # figures
  ggh4x, # ggplot hacks --> facet_grid and labels on both facets
  GGally, # cross-correlation plot
  RColorBrewer, # color palettes
  patchwork, # combining figures
  dplR, # basic dendrochronology
  dfoliatR, # dendroecology 
  zoo, # time series
  sf, # spatial data
  terra, # raster data (new pkg)
  raster, # raster data (old pkg)
  ncdf4, #import ncdf files
  ncf, # spatial covariance
  MASS, # mixed effect modelling
  nlme, # mixed effect modelling
  synchrony, # non-parametric spatial covariance 
  readxl # read excel files 
) 

proj.proj <- 4629

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9),
      plot.title=element_text(size=9)
      
    )
}
theme_set(theme_new())

set_flextable_defaults(
  font.family="Times", 
  font.size=12,
  line_spacing=1,
  padding.bottom=1,
  padding.top=1,
  text.align='center')

# Set directory structure for project
dir.create(here("Data"), showWarnings = FALSE)
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

\pagebreak

# Abstract

The western spruce budworm (*Choristoneura occidentalis*) is one of the most widely distributed native defoliators of coniferous forests in North America, where it plays an important role in shaping ecosystem function. In this study, we use tree-ring and geospatial data to reconstruct periods of past WSB outbreak at 12 sites across central to northern Colorado during the period 1650-2023. We use this record data to quantify: (1) temporal synchrony in outbreak history, (2) differences in the dynamics of western spruce budworm outbreaks before and after Euro-American colonization, and (3) the association between climate and outbreak initiation and cessation. We identified eight periods of regionally-synchronous outbreak between 1666 and 2023. In the first several decades following Euro-American colonization, outbreaks were shorter, more severe, and less synchronous across the region, likely due to changes in regional host availability that occurred due to widespread burning from 1850-1890. In addition to land-use practices being associated with regional outbreaks, we found outbreaks were often initiated by drought events and sustained by periods of above average moisture availability, consistent with the pulsed stress hypothesis. Collectively, our work highlights the role of broad-scale drivers, including climate and land-use practices, in influencing stand-level disturbance processes.

# Keywords

western spruce budworm; *Choristoneura occidentalis;* drought; tree ring; dendroecology; insect outbreak; synchrony; land-use practices

# Highlights

-   Western spruce budworm outbreaks were often proceeded by periods of drought

-   Outbreaks were sustained by periods of above average moisture availability

-   Euro-American colonization was initially linked with lower susceptibility to outbreak

# Introduction

Changes in climate, human population density, and land-use are altering ecosystems around the world [@weiskopf2020ClimateChangeEffects]. In forested ecosystems of western North America, these changes are altering plant-insect interactions, leading to changes in in ecosystem structure, composition, and function [@bale2002]. Such changes may be particularly dramatic when insect herbivores increase consumption in response to elevated temperatures, CO~2~ concentrations, drought stress, and/or nutrient conditions [@hamann2021ClimateChangeAlters]. Predicting the effects of global change on the structure, composition, and function of forest ecosystems requires a better understanding of the effects of global change on interactions between plants and insects.

The western spruce budworm (WSB; *Choristoneura occidentalis*) is one of the most widely distributed native defoliators of coniferous forests in North America, where it plays an important role in shaping ecosystem function [@johnson1975OutbreaksWesternSpruce; @brookesWesternSpruceBudworm1987]. The WSB is a specialist herbivore that preferentially feeds upon young buds and new foliage of their host trees, which include Douglas-fir (*Pseudotsuga menziesii*), true firs (*Abies* spp.) and spruce (*Picea spp.*). Typically, WSBs exist at low population levels and defoliation is minimal [@brookesWesternSpruceBudworm1987]. However, periodically WSB populations may erupt, leading to severe defoliation. These outbreaks occur when several thresholds in the host-WSB system are crossed and negative feedbacks among the WSB populations, host trees, and natural enemies no longer constrain WSB population dynamics [@meigs2015; @senf2017MultiscaleAnalysisWestern; @nealis2021EcologyOutbreakPopulations]. During outbreaks, affected trees may experience severe reductions in growth and seed production or even death [@alfaroTreeMortalityRadial1982], leading to reduced host species regeneration and altered successional trajectories [@wulf1987SiteStandCharacteristics; @hadleyStandResponseWestern1993], changes in carbon cycling [@dymond2010FutureSpruceBudworm], and reductions in timber volume [@alfaro1992]. Importantly, outbreaks often occur synchronously across broad spatial extents (*i.e.*, 1000s of kilometers) [@flower2016], leading to considerable fluctuation in the provisioning of ecosystem services at a subcontinental scale [@wilcox2017AsynchronyLocalCommunities; @patrick2021MultiscaleBiodiversityDrives].

Disjunct populations of forest insects often fluctuate synchronously [@liebhold2012]. For example, analyses of the spatial patterning of recent (ca. 1996-2011) WSB outbreaks in interior southern British Columbia revealed that 90% of patches newly infested by WSB were within 5 km of an existing patch [@senf2017MultiscaleAnalysisWestern]. While dispersal may explain spatiotemporal synchrony at fine scales, WSB populations may also fluctuate synchronously at subcontinental scales [@flower2016]. At least part of this pattern has been attributed to *"the Moran effect"*, where spatial autocorrelation in exogenous drivers leads to synchrony [@moran1953StatisticalAnalsisCanadian]. For the WSB, Moran effects may occur if climate affects WSB population rates by altering insect survival or fecundity [@brookesWesternSpruceBudworm1987; @swetnam1993] and/or if regionally-synchronized stand development affects forage quantity and quality [@brookesWesternSpruceBudworm1987; @hadleyStandResponseWestern1993; @swetnam1993].

Outbreaks of WSB are most likely to occur in host-dominated multistoried stands that provide favorable microenvironments for egg development as well as feeding and downward dispersal of larvae [@wulf1987SiteStandCharacteristics]. These stands are particularly susceptible when the surrounding landscape is also characterized by abundant hosts [@brookesWesternSpruceBudworm1987; @senf2017MultiscaleAnalysisWestern]. At the stand and landscape scale, patterns of host abundance and size reflect past disturbances and land-use history [@hadleyStandResponseWestern1993; @maclauchlan2009InfluenceForestryPractices]. Notably, the forcible displacement of native peoples by Euro-American settlers and the ensuing changes in land management practices altered forest composition, structure, and disturbance regimes across much of the Western US [@hessburg2019ClimateEnvironmentDisturbance]. Early Euro-American settlers often heavily logged forests near settlements and ignited fires, often burning extensive areas [@veblen1991ColoradoFrontRange]. For example, in the Southern Rocky Mountains logging and burning left a legacy of widespread even-aged forests that established in the late 19th to early 20th century [@veblen1991ColoradoFrontRange; @smith2000ForestryPracticesForest].

Both logging practices that emphasize the selective harvesting of large trees and severe wildfires can reduce host abundance and quality, thereby limiting the susceptibility of stands to outbreaks in the near-term [@hadleyStandResponseWestern1993; @swetnam1993; @howe2024BudwormsBeetlesWildfire]. While initially logged and burned stands may be less susceptible to WSB outbreaks, after several decades stands may again become susceptible to WSB outbreaks as trees regenerate and grow, eventually developing into multistoried structures [@hadleyStandResponseWestern1993; @swetnam1993]. Additionally in many forests formerly characterized by a low-severity, frequent fire regime, reduced fire frequency resulting from livestock grazing and modern fire exclusion practices in the early 1900s resulted in denser stands and in some cases increased abundance of the more shade-tolerant Douglas-fir [@kaufmann2000HeterogeneityPonderosaPine; @huckaby2001LandscapePatternsMontane; @sherriff2006EcologicalEffectsChanges; @schoennagel2011FireHistoryTree]. Collectively, similar changes in effects of Euro-American land-use practices have been hypothesized to make stands more susceptible to WSB outbreaks and lead to increases in the severity and synchrony of WSB outbreaks [@swetnam1989]. However, evidence for this effect appears to vary regionally [@alfaroPeriodicityWesternSpruce2014; @swetnam1993; @hadleyStandResponseWestern1993; @flower2014; @ryerson2003TreeringReconstructionWestern; @ellisMulticenturyDendrochronologicalReconstruction2017].

Given susceptible stand conditions, interannual variability in drought severity may synchronize irruptions of folivorous insect populations [@gely2020HowHerbivorousInsects]. For instance, droughts may increase available foliar nitrogen content, thereby triggering population irruptions (*plant stress hypothesis*) [@whiteAbundanceInvertebrateHerbivores1984]. Alternatively, insect population growth rates may increase in response to periods of above average moisture that increase forage digestibility and availability (*plant vigor hypothesis*) ([Price 1991](#ref-price1991PlantVigorHypothesis)). For the WSB-Douglas fir system, outbreak occurrence has been linked with both periods of drought and above average moisture availability [@swetnam1993; @flower2014]. This apparent contradiction may arise for several reasons. First, tree resource partitioning may respond non-linearly to drought. For instance, carbon allocation to defenses is expected to be greatest at moderate drought severity because fewer carbohydrates are used for growth, leaving more resources available for the production of defense compounds (*growth-differentiation balance hypothesis)* [@herms1992DilemmaPlantsGrow]. Further, multi-year drought events may have particularly large effects because trees often rely on carbon fixed in prior years [@gao2018DynamicResponsesTreering; @kannenberg2019DroughtLegaciesAre; @lv2022ProlongedDroughtDuration]. Finally, drought events that are followed by increased moisture availability may be the most favorable to outbreak if drought increases forage quality thereby triggering outbreak initiation, but above average moisture availability sustains forage production necessary for sustaining high population levels (*pulsed stress hypothesis*) [@huberty2004PlantWaterStress; @flower2014].

Once WSB populations have irrupted, they may persist at high levels for several years but eventually collapse [@brookesWesternSpruceBudworm1987]. Several factors have been suggested to drive outbreak cessation [@nealis2021EcologyOutbreakPopulations]. As WSB populations grow, populations of parasitoids and pathogens of the WSB often increase, although this response is lagged. While increases in natural enemies have been suggested as a key driver of outbreak collapse [@royama1984; @campbell1987PopulationDynamics], recent research has documented outbreak cessation in stands without elevated populations of natural enemies [@nealis2021EcologyOutbreakPopulations]. Increasing WSB populations can also lead to foliage depletion, thereby decreasing the survival rates of WSBs because dispersing larvae cannot find suitable forage [@nealis2009RiskDispersalWestern; @nealis2021EcologyOutbreakPopulations]. Warm and dry conditions may deplete the glycogen stores that WSB larvae initially feed upon and decrease forage production, collectively increasing WSB mortality rates[@nealis2016WhyWesternSpruce; @senf2016UsingLandsatAssess; @senf2017MultiscaleAnalysisWestern; @nealis2021EcologyOutbreakPopulations].

This study relies upon a multiproxy approach to reconstruct periods of past WSB outbreak across central to northern Colorado. We combine tree-ring records and geospatial to produce a multi-centennial record, necessary for understanding the dynamics of WSB outbreaks [@swetnam1989]. We use this record data to quantify: (1) temporal synchrony in outbreak history, (2) differences in the dynamics of WSB outbreaks before and after Euro-American colonization, and (3) the association between climate and outbreak initiation and cessation.

# Materials and Methods

## Study area

```{r Import_TreeRingSiteData}
host.meta <- read.csv(here("Data", "TreeRing", "Processed", "Host", "host-metadata.csv")) # read in metadata for hosts
nonhost.meta <- read.csv(here("Data", "TreeRing", "Processed", "Nonhost", "nonhost-metadata.csv")) # read in metadata for control sites
hostXnonhost <- read.csv(here("Results", "hostXnonhost-subset.csv")) # read in data tht pairs host with control sites

host.meta.sub <- host.meta %>% filter(SeriesCode %in% hostXnonhost$host) # remove sites that didn't match with a control site
  
select.nonhost.sites <- hostXnonhost[,c('nonhost1', 'nonhost2','nonhost3')] %>% unlist() %>% unique() # determine which control sites were matched with a host site
nonhost.meta.sub <- nonhost.meta[nonhost.meta$SeriesCode %in% select.nonhost.sites, ] # remove sites that did not match with host site
  
#nonhost.sites <- st_as_sf(x = nonhost.meta.sub,  coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj) # convert to sf object

#host.sites.sub <- st_as_sf(x = host.meta.sub, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj) # convert to sf object

host.sites <- st_as_sf(x = host.meta, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj) # convert to sf object

host.sites.sub <- host.sites %>% filter(SeriesCode %in% hostXnonhost$host) # remove sites that didn't match with a control site
```

```{r Import_ClimateData}
climate.normals <- read.csv(here("Results", "climate-norms-studyarea.csv")) # read in climate data

if(!file.exists(here("Results", "AETCWD-hostsite.csv"))){
  AET <- rast(here('Data', 'Spatial', 'Rodman', 'AET and CWD', 'AET_1981-2010.tif'))
  CWD <- rast(here('Data', 'Spatial', 'Rodman', 'AET and CWD', 'CWD_1981-2010.tif'))
  host.sites.climate <- extract(AET, host.sites, bind=T)
  host.sites.climate <- extract(CWD, host.sites.climate, bind=T)
  host.sites.climate <- host.sites.climate %>% as.data.frame() %>% dplyr::select(SeriesCode, AET_1981.2010, CWD_1981.2010)
  colnames(host.sites.climate) <- c("SeriesCode", "AET", "CWD")
  write.csv(host.sites.climate, here("Results", "AETCWD-hostsite.csv"), row.names=F)
}
host.sites.climate <- read.csv(here("Results", "AETCWD-hostsite.csv"))
```

The study area consists of forested areas in central to northern Colorado (`r round(min(host.meta$Lat),1)`°N to `r round(max(host.meta$Lat),1)`°N latitude) where Douglas fir is commonly found (Fig. \@ref(fig:FigStudyArea)). This zone extends from about `r climate.normals %>% filter(metric=="min") %>% pull(Elev) %>% signif(2)` to `r climate.normals %>% filter(metric=="max") %>% pull(Elev) %>% signif(2)` meters in elevation and includes areas both east and west of the Continental Divide. Typically, this region experiences warm summers (1991-2020 mean July daily maximum temperature: `r climate.normals %>% filter(metric=="mean") %>% pull(TMAX) %>% round(1)`°C), cold winters (1991-2020 mean January daily minimum temperature: `r climate.normals %>% filter(metric=="mean") %>% pull(TMIN) %>% round(1)`°C), and moderate amounts of precipitation (1991-2020 mean total annual precipitation: `r climate.normals %>% filter(metric=="mean") %>% pull(PPT) %>% round(0)` mm) [@prismclimategroup2021]. At local scales, the climate is driven by elevation gradients, the prevailing westerly winds, and the north-south orientation of the mountains. Temperatures are warmer at lower elevations, while more precipitation falls at higher elevations, particularly on the windward side of the Rockies [@lukas2014ClimateChangeColorado]. Summer precipitation patterns exhibit a distinct latitudinal gradient, where more southern locations often receive more precipitation due to the North American Monsoon system [@lukas2014ClimateChangeColorado].

Montane forests across the region are dominated by ponderosa pine (*Pinus ponderosa*) and Douglas fir (*Pseudotsuga menziesii)*, with lesser components of aspen (*Populus tremuloides*), lodgepole pine (*Pinus contorta*), and limber pine (*Pinus flexilis*) [@veblen2005]. Prior to Euro-American colonization, lower montane forests across the study area were characterized by frequent, low-severity fire, while higher elevation montane forests were characterized by a more variable fire regime [@sherriff2007SpatiallyExplicitReconstructionHistorical].

```{r FigStudyArea, fig.cap="The study area and WSB reconstruction (triangles) and non-host control (circles) sample sites. The green shading illustrates the distribution of Douglas fir. The inset map display's the study area's location relative to the contiguous western United States.", fig.height=4.5, fig.width=3.5}
knitr::include_graphics(here("Results", "Figures", "FigStudyArea.jpg"))
```

## Data

### Dendroecological data

Ring-width data for reconstructing periods of WSB outbreak were collected from Douglas fir in the 1990s, but unpublished (Table S\@ref(tab:hostmeta)). Sample sites were selected based on the availability of large, old Douglas fir and the absence of evidence of recent (i.e., since c. 1940) fire or logging to minimize the potential effects of other disturbances on radial growth. At each site, tree-ring data were collected by preferentially sampling at least 20 large Douglas fir using an increment borer. Cores were transferred back to the lab, where they were dried, mounted, and sanded to a fine polish, following standard dendrochronological methods [@stokes1996]. Ring widths were then measured to a 0.01 mm precision using a Velmex UniSlide digital encoded traversing table paired with a standard light microscope. To ensure accurate dating, ring-width series were visually cross-dated using the maker year approach [@yamaguchi1991]. Cross-dating was then verified statistically using the *dplR* package [@bunn2024DplRDendrochronologyProgram] in R [@rcoreteam2022].

### Geospatial disturbance data

To characterize recent history of WSB outbreaks across the study area, we acquired ADS data from the USFS [@usfsanditspartners2020USDAForestService]. ADS data are collected annually via aerial sketch mapping by trained experts who record the disturbance agent, host species, and estimated outbreak severity across broad landscapes. Additionally, given young post-fire stands are not expected to be susceptible to WSB, we acquired data describing wildfire extent for the 1984-2023 period from the Monitoring Trends in Burn Severity Project [-@mtbsprojectMTBSDataAccess2022]. In the subsequent analyses of outbreaks with climate data, these recent fire history data allowed us to eliminate periods when stands would have been too young to be susceptible to WSB outbreak.

### Climate data

To characterize temporal variation in drought severity, we obtained multi-century (i.e., AD 1600-2005) records of the self-calibrating Palmer Drought Severity Index (SC-PDSI) [@wellsSelfCalibratingPalmerDrought2004, @palmer1965] from the North American Drought Atlas (NADA), which provides tree-ring based reconstructions of June-August SC-PDSI on a 0.5° resolution grid [@cook2010]. While WSB population dynamics are also sensitive to climate conditions in winter, spring, and fall [@nealis2021EcologyOutbreakPopulations], June-August SC-PDSI is the only available multi-century and spatially-explicit reconstruction of interannual climate variability for the study region. Further it has been used in prior research to test hypotheses similar to those posed herein about the effects of drought on WSB outbreak dynamics [e.g., @flower2014].

Because the NADA reconstruction extends only to 2005, we also obtained gridded June-August SC-PDSI data from the West Wide Drought Tracker [@abatzoglouWestWideDrought2017]. This dataset is based on PRISM climate data [@prismclimategroup2021], which characterizes monthly precipitation and temperature, among other variables, at a 4 km resolution for the period 1895-present. PRISM datasets are constructed using data from weather stations and a digital elevation model to adjust for the complex effects of topography on weather and climate [@dalyKnowledgebasedApproachStatistical2002].

For each site, we created time series of 1600-2005 SC-PDSI using the NADA product and 1981-2023 SC-PDSI values using the PRISM-based product by extracting the values for the cell the site fell within. We extended the SC-PDSI time series from the PRISM-based dataset back to 1700 using the following procedure. First, we scaled the mean and standard deviation of the NADA reconstruction to the mean of the detrended PRISM-based dataset, where the detrended values are the residuals from a linear regression of SC-PDSI vs. time during the common period between the two datasets (i.e., 1981-2005). We then spliced the two datasets, using the PRISM-based dataset to represent PDSI values from 1981-2023 and the adjusted NADA dataset to represent values from 1600-1980 [@schoennagelMultidecadalClimateVariability2007].

```{r import_NADA}
nada.hosts <- read.csv(here("Data", "nada-hosts.csv"))
```

```{r PRISM}
if(!file.exists(here("Data", "prism-JJA.csv"))){

  prism6_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_6_PRISM.nc"))
  prism7_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_7_PRISM.nc"))
  prism8_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_8_PRISM.nc"))
  
  prism6.hosts <- t(terra::extract(prism6_data, host.sites)[,-1 ])
  colnames(prism6.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism6.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism6.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism6.hosts) <- startx:endx
  
  prism7.hosts <- t(terra::extract(prism7_data, host.sites)[,-1])
  colnames(prism7.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism7.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism7.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism7.hosts) <- startx:endx
  
  prism8.hosts <- t(terra::extract(prism8_data, host.sites)[,-1])
  colnames(prism8.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism8.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism8.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism8.hosts) <- startx:endx
  prism8.hosts <- prism8.hosts[-nrow(prism8.hosts),]
  
  prism678.hosts <- prism8.hosts %>% as.data.frame()
  for(j in 1:ncol(prism678.hosts)){
    prism678.hosts[,1] <- (prism6.hosts[,j][-130] + prism7.hosts[,j][-130] + prism8.hosts[,j])/3
  }
  prism678.hosts$year <- row.names(prism678.hosts) %>% as.numeric()
  prism678.hosts %>% write.csv(here("Data", "prism-JJA.csv"),row.names=F)
  
}
prism.JJA <- read.csv(here("Data", "prism-JJA.csv"))
```

```{r join_NADAxPRISM}
  pdsi.out <-data.frame(matrix(nrow=length(min(nada.hosts$X):max(prism.JJA$year)), ncol=length(host.sites$SeriesCode)+1))
  colnames(pdsi.out) <- c("year",host.sites$SeriesCode)
  pdsi.out$year <- min(nada.hosts$X):max(prism.JJA$year)
  for(j in host.sites$SeriesCode){
    nadaj <- ts(nada.hosts[,j],start=min(nada.hosts$X))
    prismj <- ts(prism.JJA[,j],start=min(prism.JJA$year))
    pdsi.combo <- cbind(prismj, nadaj)
    yearz <- time(pdsi.combo)
    pdsi.combo <- pdsi.combo %>% as.data.frame()
    pdsi.combo$year <- yearz
    lmx <- lm(prismj~year, data=na.omit(pdsi.combo[pdsi.combo$year>=1981,]))$residuals
    mean.lmx <- lmx %>% mean()
    sd.lmx <- lmx %>% sd()
    pdsi.combo$nadaj <- (scale(pdsi.combo$nadaj) + mean.lmx) * sd.lmx
    pdsi.out[,j] <- c(pdsi.combo[pdsi.combo$year <1981,]$nadaj, pdsi.combo[pdsi.combo$year >=1981,]$prismj)
  }
  pdsi.out$AVG <- pdsi.out %>% dplyr::select(-year) %>% rowMeans()
  pdsi.out %>% write.csv(here("Results", "pdsi-out.csv"), row.names=F)

pdsi.out <- read.csv(here("Results", "pdsi-out.csv"))
```

## Reconstructing periods of past outbreak

### Dendroecological approach

A common strategy for detecting periods of WSB outbreak from tree-ring data is to compare the radial growth of the host species, here Douglas-fir, with the radial growth of a non-host species [@swetnam1989]. When the non-host species responds similarly to climate, host ring-width series can then be 'corrected' to remove the effects of interannual climate variability on the radial growth. This allows for the detection of periods of reduced radial growth that may attributed to non-climate factors, such as defoliation by WSB. Across our study area, both ponderosa pine and Douglas-fir have been known to respond negatively to periods of drought [@woodhouse2006], allowing for this method to be applied here.

To follow this general approach, we first obtained all available ponderosa pine chronologies collected in the state of Colorado from the International Tree Ring Databank (ITRDB), as well as previously published chronologies from @veblen2000 (Table S\@ref(tab:nonhostmeta)). We then matched each Douglas-fir site with three non-host chronologies by identifying all non-host chronologies that were within 150 km of the sample site. We further limited this subset to the ponderosa pine chronologies that were collected in the mid-1990s or later, to ensure our records could be linked with geospatial data. Of this subset, we then selected the three chronologies that showed the greatest similarity in radial growth patterns. This was achieved by first detrending host and non-host ring width series with a negative exponential curve that was fit to the ring-width data using non-linear least squares. The raw ring widths were then divided by the best fitting curve to produce a time series of dimensionless ring-width index (RWI) values. RWI values were further detrended using a 30-year 50% frequency response cubic smoothing spline. This double detrending approach was selected to first remove long-term age-growth related trends and second remove interdecadal patterns that may occur due to disturbance, while preserving high-frequency interannual variation due to climate. Next, we built mean value chronologies from the detrended ring-width series by first pre-whitening each series using an autoregressive time series model. Mean values were then calculated from the residuals of the autoregressive model using a robust mean approach that minimizes the effect of extreme outliers [@speer2010]. We then identified the three non-host chronologies that best correlated with each host chronology using pairwise Pearson correlation coefficients. All detrending and chronology building was performed using the *dplR* package [@bunn2008] in R [@rcoreteam2022].

After identifying the three non-host sites that best represented interannual climate variability at each host site, we reprocessed the tree-ring data to better isolate the effects of WSB defoliation on radial growth. Because WSB outbreaks may persist for a decade or more [@swetnam1993; @flower2016], we detrended both the host and non-host tree-ring data using a 100-year cubic smoothing spline to preserve variability at the interdecadal scale [@swetnam1985; @flower2014]. We then constructed mean value chronologies for the non-host sites by first removing serial autocorrelation and then calculating a robust estimate of the mean, as above. To create a single climate-sensitive record for each host site, we performed principal components analysis on the three non-host chronologies and extracted the first principal component to serve as the control series [@flower2014].

```{r RWLS, results='hide'}
# Host data
host.rwls <- list.files(here("Data", "TreeRing", "Processed", "Host"), pattern=".rwl", full.names=T)
names(host.rwls) <- gsub(".rwl", "", unlist(list.files(here("Data", "TreeRing", "Processed", "Host"), pattern=".rwl", full.names=F)))
host.rwls <- lapply(host.rwls, read.rwl)
  
# Nonhost data
nonhost.rwls <- list.files(here("Data", "TreeRing", "Processed", "NonHost"), full.names = T, pattern=".rwl")
names(nonhost.rwls) <- gsub(".rwl", "", unlist(list.files(here("Data", "TreeRing", "Processed", "NonHost"), pattern=".rwl", full.names=F)))
nonhost.rwls <- lapply(nonhost.rwls, read.rwl)
```

```{r Detrend, results='hide'}
host.rwis <- lapply(host.rwls, detrend, method = "Spline", nyrs = 100)
nonhost.rwis <- lapply(nonhost.rwls, detrend, method = "Spline", nyrs = 100)
```

```{r nonhost.crns, results='hide'}
nonhost.crns <- lapply(nonhost.rwis, chron, biweight=T, prewhiten = TRUE)
```

To determine if individual trees experienced reductions in growth consistent with defoliation by WSB, we compared the detrended Douglas fir RWI with the control time series [@swetnam1985]. Specifically, we calculated the growth suppression index (GSI) using the following equation:

$GSI_{i} =I_{ht} - (SD_{h}/SD_{n})*(I_{nt}-\bar{I}_{n})$

where $I_{ht}$ is the host RWI value for host tree $h$ at year $t$, $SD_{h}$ is the standard deviation of the RWI series for host tree $h$, $SD_{n}$ is the standard deviation of nonhost control series, $I_{nt}$ is the nonhost control series value for year $t$, and $\bar{I}_{n}$ is mean value of the nonhost control series. GSI values less than one indicate periods of reduced radial growth relative to potential growth. For each tree, we then defined defoliation events when: (1) at least eight consecutive years of negative GSI and (2) at least one year exhibited a GSI value that was at least 1.28 standard deviations below the mean [@swetnam1985; @harvey2018]. We then defined stand-level periods of outbreak as periods where: (1) at least 40% of the host trees recorded a defoliation event for 4 or more years and (2) the sample depth was greater than 4 trees [@flower2014]. We performed the correction of host tree-ring series and determination of potential WSB defoliation events and outbreak events in R [@rcoreteam2022] using the *dfoliatR* package [@guiterman2020].

```{r Defoliate}
host.defol <- NULL # create empty object to hold defoliation objects
host.outbreak <- NULL # create empty object to hold outbreak objects
host.outbreak.stats <- NULL # create empty object to hold outbreak statistics objects

for(j in host.meta.sub$SeriesCode){
  host.rwis.j <- host.rwis[[j]]
  
  ## Create control series
  nonhost.j <- hostXnonhost[hostXnonhost$host==j,c("nonhost1", "nonhost2", "nonhost3")] # get names of best correlated nonhost chronologies 
  nonhost.crns.j<- list(nonhost.crns[[hostXnonhost[hostXnonhost$host==j,"nonhost1"]]], nonhost.crns[[hostXnonhost[hostXnonhost$host==j,"nonhost2"]]], nonhost.crns[[hostXnonhost[hostXnonhost$host==j,"nonhost3"]]]) # put best correlated nonhost chronologies in a list
  nonhost.crns.j.ts <- lapply(nonhost.crns.j, FUN=function(x){return( ts(x, start=min(as.numeric(row.names(x)))) )}) # convert to timeseries 
  nonhost.crns.j.mts<- do.call(cbind, nonhost.crns.j.ts) [,c(-3,-6,-9)] # create dataframe with all three time series and drop sample depth column
  colnames(nonhost.crns.j.mts) <- c(paste0(nonhost.j[1], c("std", "res")),paste0(nonhost.j[2], c("std", "res")),paste0(nonhost.j[3], c("std", "res"))) 
  nonhost.crns.j.mts <- na.omit(nonhost.crns.j.mts) # select only period where all three records overlap
  nonhost.crns.j.pca <- prcomp(nonhost.crns.j.mts , retx=T) # perform principle component analysis
  nonhost.crns.j.pca.df <- as.data.frame(nonhost.crns.j.pca$x[,1]) # extract first component
  row.names(nonhost.crns.j.pca.df) <- time(nonhost.crns.j.mts) # set row names to years of common period
  
  host.ts <- ts(rowMeans(host.rwis.j, na.rm=T), start=min(as.numeric(row.names(host.rwis.j))))
  pca.ts <- ts(nonhost.crns.j.pca.df[,1], start=min(as.numeric(row.names(nonhost.crns.j.pca.df))))
  x <- cor(cbind(host.ts, pca.ts), use="pairwise.complete.obs")[1,2]
  if(x<0){
    nonhost.crns.j.pca.df[,1] <- nonhost.crns.j.pca.df[,1]  * -1
  }

  # determine when trees were defoliated
  host.defol[[j]] <- defoliate_trees(host_tree=host.rwis.j, nonhost_chron = nonhost.crns.j.pca.df, duration_years = 8, max_reduction = -1.28, bridge_events = T, series_end_event = F) 
  
  # determine when outbreaks occurred
  host.outbreak[[j]] <- outbreak(host.defol[[j]], filter_perc =40, filter_min_series = 4) # determine when outbreak occurs
  host.outbreak[[j]]$SeriesCode <- j # add series code to outbreak object
  
  host.outbreak.stats[[j]] <- outbreak_stats(host.outbreak[[j]])
  host.outbreak.stats[[j]]$SeriesCode <- j # add series code to outbreak stats object
  
  host.outbreak.stats[[j]] <- host.outbreak.stats[[j]] %>% 
    filter(duration>4) # filter to only outbreaks that are at least 4 years in length

  # bridge outbreaks that are separated by less than 2 years
  k <- 1
  
  host.outbreak.stats[[j]]$cessation <-NA
  while(k < nrow(host.outbreak.stats[[j]])){
    dif <- host.outbreak.stats[[j]][k+1,]$start - host.outbreak.stats[[j]][k,]$end
    if(dif >=2){
      host.outbreak.stats[[j]][k,]$cessation <- host.outbreak.stats[[j]][k,]$end + 1
      k <- k+1
    }else{
      host.outbreak.stats[[j]][k,]$end <- host.outbreak.stats[[j]][k+1,]$end
      host.outbreak.stats[[j]][k,]$duration <- length(host.outbreak.stats[[j]][k,]$start:host.outbreak.stats[[j]][k,]$end)
      host.outbreak.stats[[j]][k,]$min_ngsi <- min(c(host.outbreak.stats[[j]][k,]$min_ngsi, host.outbreak.stats[[j]][k+1,]$min_ngsi))
      host.outbreak.stats[[j]][k,]$cessation <- host.outbreak.stats[[j]][k,]$end + 1
      host.outbreak.stats[[j]] <- host.outbreak.stats[[j]][-1*(k+1),]
    }
  }
  
  host.outbreak.stats[[j]][nrow(host.outbreak.stats[[j]]),]$cessation <- host.outbreak.stats[[j]][nrow(host.outbreak.stats[[j]]),]$end + 1
  
  ## add in quiescent period length
  host.outbreak.stats[[j]]$q<- NA
  q <- host.outbreak.stats[[j]]$start[-1] - host.outbreak.stats[[j]]$end[-1*nrow(host.outbreak.stats[[j]])]
  host.outbreak.stats[[j]]$q <- c(NA, q)
}         

```

### Combining tree-ring and geospatial data

We extended tree-ring records of WSB outbreak by spatially joining point data describing the location of sample sites with ADS data describing the annual extent of WSB outbreak for the 1996-2023 period. Additionally, we joined sample site location with data describing wildfire extent [@mtbsprojectMTBSDataAccess2022] and the extent of Douglas-fir beetle (*Dendroctonus psuedotsugae*) outbreak, which both lead to mortality of Douglas fir and thereby may be limit the potential for outbreaks to occur. When sites were affected by either Douglas-fir beetle or fire, we truncated the record in the year prior to the disturbance.

```{r SpatialJoin_MTBS_ADS}
sf::sf_use_s2(FALSE)
if(!file.exists(here("Results", "burnedsites.csv"))){
  fires <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% st_transform(proj.proj)
  # find points within fire polygons
  points_in_fires <- st_join(host.sites.sub, fires, join = st_within)
  points_in_fires %>% as.data.frame() %>% dplyr::select(SeriesCode, Incid_Name, Ig_Date) %>% write.csv(here("Results", "burnedsites.csv"))
}
burnedsites <- read.csv(here("Results", "burnedsites.csv")) %>% mutate(Ig_Date=as.Date(Ig_Date), Ig_Year=lubridate::year(Ig_Date))
burnedsites <- burnedsites %>% mutate(Ig_Year=ifelse(Ig_Year <1990, NA, Ig_Year)) # remove any fires that predate the sampling 

if(!file.exists(here("Results", "ADS-WSB-sites.csv"))){
  #st_layers(here("Data", "Spatial", "ADS", "CONUS_Region2_AllYears.gdb", "CONUS_Region2_AllYears.gdb"))
  ADS.DFB <- st_read(here("Data", "Spatial", "ADS", "CONUS_Region2_AllYears.gdb", "CONUS_Region2_AllYears.gdb"), query="select * from DAMAGE_AREAS_FLAT_AllYears_CONUS_Rgn2 where DCA_COMMON_NAME = 'Douglas-fir beetle'") %>% st_transform(proj.proj)
  
  ADS.WSB <- st_read(here("Data", "Spatial", "ADS", "CONUS_Region2_AllYears.gdb","CONUS_Region2_AllYears.gdb"), query="select * from DAMAGE_AREAS_FLAT_AllYears_CONUS_Rgn2 where DCA_COMMON_NAME = 'western spruce budworm'") %>% st_transform(proj.proj)
  
  points <- host.sites.sub %>% st_transform(proj.proj)

   st_join(points, ADS.DFB, join = st_within) %>% as.data.frame() %>% dplyr::select(SeriesCode, DCA_COMMON_NAME, SURVEY_YEAR)  %>% write.csv(here("Results", "ADS-DFB-sites.csv"), row.names=F)
  st_join(points, ADS.WSB, join = st_within) %>% as.data.frame() %>% dplyr::select(SeriesCode, DCA_COMMON_NAME, SURVEY_YEAR) %>% write.csv(here("Results", "ADS-WSB-sites.csv"), row.names=F)

}
ADS.DFB.sites <- read.csv(here("Results", "ADS-DFB-sites.csv")) %>% mutate(SURVEY_YEAR=SURVEY_YEAR-1)
ADS.WSB.sites <- read.csv(here("Results", "ADS-WSB-sites.csv"))

geo.outbreak.dat <- left_join(burnedsites, ADS.DFB.sites, by="SeriesCode") %>% dplyr::select(SeriesCode, Ig_Year, SURVEY_YEAR) %>% mutate(Ig_Year=replace_na(Ig_Year, 2023), SURVEY_YEAR=replace_na(SURVEY_YEAR, 2023)) %>% rowwise() %>% mutate(Disturb.Year=min(c(Ig_Year,SURVEY_YEAR), na.rm=T))

geo.outbreak.dat <- data.frame(SeriesCode=geo.outbreak.dat$SeriesCode, start.yr = 1996, end.yr = geo.outbreak.dat$Disturb.Year)
```

### Defining periods of regional outbreak

Finally, we used the composite record to define periods of regional outbreak, defined here as two or more consecutive years where at least one third of the sites simultaneously recorded a WSB outbreak. Given not all records extend as far back in time, we limited the regional record to the period where at least four sites were recording (1665-2023). We defined years of regional outbreak initiation in two ways, (1) the first year where at least one third of the sites were recording an outbreak and (2) the first year where any site was recording an outbreak coincided with a period of regional outbreak. We calculated cessation dates in the same manner.

```{r regionalOutbreaks}
f.threshold <- 0.33 # threshold for defining regional outbreak
nsites.threshold <- 3 # minimum number of sites with data to consider regional outbreak
dur.threshold <- 2 # number of years
regional.outbreaks <- NULL
for(j in host.meta.sub$SeriesCode){
  x <- host.outbreak[[j]] %>% filter(samp_depth>=4)
  x.ts <- ts(x$outbreak_status, start=x$year[1])
  x.ts[x.ts==3] <- 0 # reclassify not outbreak to 0
  x.ts[x.ts==1] <- 1 # reclassify outbreak to 1 
  x.ts[x.ts==2] <- 0 # reclassify ongoing outbreaks to 0
  regional.outbreaks <- cbind(regional.outbreaks, x.ts)
}
colnames(regional.outbreaks) <- host.meta.sub$SeriesCode

years <- time(regional.outbreaks)
regional.outbreaks <- as.data.frame(regional.outbreaks)
regional.outbreaks$year <- years

# Calculate number of sites with data
regional.outbreaks$nsites <- apply(regional.outbreaks, MARGIN=1, FUN=function(x){length(na.omit(x))-1})

# Calculate number of sites experiencing an outbreak
regional.outbreaks$noutbreaks <- apply(regional.outbreaks, MARGIN=1, FUN=function(x){sum(x[1:(length(x)-2)], na.rm=T)})
regional.outbreaks$noutbreaks[is.na(regional.outbreaks$noutbreaks)]<-0 # replace NA value with zero

# Calculate fraction of sites experiencing an outbreak
regional.outbreaks$foutbreak <- regional.outbreaks$noutbreaks / regional.outbreaks$nsites

# Determine if outbreak is regional in extent
regional.outbreaks$outbreak <- ifelse(regional.outbreaks$foutbreak >= f.threshold & regional.outbreaks$noutbreak >=nsites.threshold , "outbreak", "no outbreak")

regional.outbreaks$local.outbreak <- ifelse(regional.outbreaks$foutbreak > 0 & regional.outbreaks$nsites >=nsites.threshold , "outbreak", "no outbreak")

# Summarize periods of regional outbreak
x <- cumsum(rle(regional.outbreaks$outbreak)$lengths)  # pulls out last year 
endz <- regional.outbreaks[x,] %>% filter(outbreak=="outbreak") %>% pull(year)
startz <- regional.outbreaks[x,] %>% filter(outbreak=="no outbreak") %>% pull(year) + 1
startz <- startz[-1*length(startz)]
regional.outbreak.summary <- data.frame(start=startz, end=endz) %>% mutate(duration = end-start+1)
regional.outbreak.summary$q <- c(NA,regional.outbreak.summary$start[-1] - regional.outbreak.summary$end[-nrow(regional.outbreak.summary)])  - 1 # calculate interval between outbreaks

# bridge periods of outbreak where interval between outbreaks is less than or equal to 2 years
while(regional.outbreak.summary %>% filter(q<=2) %>% nrow() >0){
  x <- which(regional.outbreak.summary$q <=2) %>% min()
  startz <- regional.outbreak.summary[x-1,]$start
  endz <- regional.outbreak.summary[x,]$end
  regional.outbreak.summary.bridge <- data.frame(start=startz, end=endz, duration=NA, q=NA)
  regional.outbreak.summary <- regional.outbreak.summary[-((x-1):x),]
  regional.outbreak.summary <- bind_rows(regional.outbreak.summary,regional.outbreak.summary.bridge) %>% arrange(start) %>% mutate(duration = end-start +1)
  regional.outbreak.summary$q <- c(NA,regional.outbreak.summary$start[-1] - regional.outbreak.summary$end[-nrow(regional.outbreak.summary)]) - 1# recalculate interval between outbreaks
}

# remove periods of outbreak < 2 years
regional.outbreak.summary  <- regional.outbreak.summary %>% filter(duration >=2)

# add in first and last year that any site was experiencing outbreak during periods of regional outbreak (>=33% of sites experiencing outbreak)
x <- cumsum(rle(regional.outbreaks$local.outbreak)$lengths)  # pulls out last year 
endz <- regional.outbreaks[x,] %>% filter(local.outbreak=="outbreak") %>% pull(year)
startz <- regional.outbreaks[x,] %>% filter(local.outbreak=="no outbreak") %>% pull(year) + 1
startz <- startz[-1*length(startz)]
regional.outbreak.summary.local <- data.frame(start=startz, end=endz) %>% mutate(duration = end-start +1)

regional.outbreak.summary$start2 <- NA
regional.outbreak.summary$end2 <- NA


for(j in 1:nrow(regional.outbreak.summary)){
 j.start <- regional.outbreak.summary[j,]$start
 regional.outbreak.summary[j, ]$start2 <- regional.outbreak.summary.local %>% filter(start <=j.start) %>% pull(start) %>% max()
 
 j.end <- regional.outbreak.summary[j,]$end
 regional.outbreak.summary[j, ]$end2 <-regional.outbreak.summary.local %>% filter(end >= j.end) %>% pull(end) %>% min()
}

regional.outbreak.summary <- regional.outbreak.summary %>% mutate(duration2 = end2-start2 +1)
regional.outbreak.summary$q2 <- c(NA,regional.outbreak.summary$start2[-1] - regional.outbreak.summary$end2[-nrow(regional.outbreak.summary)]) - 1 # calculate interval between outbreaks

```

```{r SummarizeOutbreakHistory}
outbreak.summary.tab <- host.meta.sub[,c("SeriesCode","Lat", "Lon", "FirstYear", "LastYear")]
outbreak.summary.tab$FirstYear <- sapply(host.outbreak, FUN=function(x){return(min(x[x$samp_depth>=4, ]$year))})
outbreak.summary.tab <- left_join(outbreak.summary.tab, geo.outbreak.dat, by="SeriesCode")
outbreak.summary.tab <- left_join(outbreak.summary.tab, host.sites.climate, by="SeriesCode") %>% dplyr::select(SeriesCode, Lat, Lon, AET, CWD, FirstYear, LastYear, start.yr, end.yr) %>% mutate(AET=round(AET), CWD=round(CWD))

host.outbreak.stats.df <- do.call(rbind, host.outbreak.stats)
x <- host.outbreak.stats.df %>% group_by(SeriesCode) %>% summarise(no.outbreaks=n(), dur = round(mean(duration),1), duration.sd =round(sd(duration, na.rm=T),2), q=round(mean(q,na.rm=T),1))
x$q.sd <- NA
for(j in host.meta.sub$SeriesCode){
  q<-  host.outbreak.stats.df %>% filter(SeriesCode==j) %>% pull(q) %>% sd(na.rm=T)
 x[x$SeriesCode==j,]$q.sd <- round(q,2)
}
                                                                   
outbreak.summary.tab <- left_join(outbreak.summary.tab , x)

outbreak.summary.tab <- outbreak.summary.tab %>% unite(TOTAL, c(FirstYear,end.yr), sep="-", remove=F)
outbreak.summary.tab <- outbreak.summary.tab %>% unite(DENDRO,FirstYear:LastYear, sep="-", remove=T)
outbreak.summary.tab <- outbreak.summary.tab %>% unite(GEO, start.yr:end.yr, sep="-", remove=T)
 
outbreak.summary.tab.print  <- outbreak.summary.tab %>% tidyr::unite(duration, dur:duration.sd, sep="\n(sd=")
outbreak.summary.tab.print$duration <- paste0(outbreak.summary.tab.print$duration , ")")

outbreak.summary.tab.print  <- outbreak.summary.tab.print %>% tidyr::unite(quiescent, q:q.sd, sep="\n(sd=")
outbreak.summary.tab.print$quiescent <- paste0(outbreak.summary.tab.print$quiescent , ")")
outbreak.summary.tab.print$Lat <- round(outbreak.summary.tab.print$Lat, 3)
outbreak.summary.tab.print$Lon <- round(outbreak.summary.tab.print$Lon, 3)

colnames(outbreak.summary.tab.print) <- c("Site", "Lat. \n(degrees)", "Lon. \n(degrees)", "AET\n(mm/year)", "CWD\n(mm/year)", "Combined\nrecord length\n(years)", "Tree-ring\nrecord length\n(years)", "Geospatial\nrecord length\n(years)", "No. of\noutbreaks", "Avg. outbreak\nduration\n(years)", "Avg. quiescent\nperiod\n(years)")
```

## Quantifying inter-site synchrony

We tested for synchrony in site-level outbreak histories using several approaches. First, to quantify the level of agreement among records of the percent of trees defoliated at each site we calculated Kendall's coefficient of concordance (W), a non-parametric statistic that quantifies the multivariate agreement in terms of rank [@kendall1970RankCorrelationMethods]. Because Kendall's W does not distinguish between asynchrony and synchrony, we also calculated the mean inter-site Spearman's rank correlation (r~s~), which is sensitive to sample size but indicates correlation direction [@loreau2008SpeciesSynchronyIts; @gouhier2014SynchronyQuantifyingVariability]. Additionally, we calculated concurrency (C), a measure of the proportion of peaks and troughs in agreement between two variables, which is useful for quantifying synchrony when the amplitude of two time series are uncorrelated but local maxima and minima co-occur [@gouhier2014SynchronyQuantifyingVariability]. For both approaches, we determined statistical significance using a bootstrap resampling approach with 1000 replications, where each column in the dataset was shifted a random amount thereby preserving the serial autocorrelation present but not the cross-correlation [@purvesFinescaleSpatialStructure2002]. We performed these analyses using the *synchrony* package [@gouhier2014SynchronyQuantifyingVariability] in R [@rcoreteam2022].

```{r percdefol.r}
percdefol.ts <- NULL

for(j in host.meta.sub$SeriesCode){
  x <- host.outbreak[[j]]
  x.ts <- ts(x$perc_defol, start=min(x$year))
  percdefol.ts <- cbind(percdefol.ts , x.ts)
}
colnames(percdefol.ts ) <- host.meta.sub$SeriesCode

percdefol.df <- data.frame(as.matrix(percdefol.ts), year=time(percdefol.ts))
percdefol.df <- percdefol.df %>% pivot_longer(cols=-year, values_to="percent")

Fig.file <- here("Results", "Figures", "Fig-PercentDefoliated.jpg")
jpeg(Fig.file, width=4.48, height=6.5, units="in", res=300)
ggplot(percdefol.df, aes(x=year, y=percent))+geom_bar(stat="identity", fill="grey25", col="grey25", width=.1)+facet_wrap(~name, nrow=12)+ylab("percent of trees defoliated")+ scale_y_continuous(breaks = c(0,50,100))
whatever <- dev.off()

upper.fun <- function(x){return(data.frame(rs=x[upper.tri(x)]))}

## SPEARMAN'S RANK CORRELATION ##
# calculate spearman's correlation for 1750-1995, 1750-1849, and 1890-1989 periods
listx <- list(cor(window(percdefol.ts, start=1750, end=1995),use="pairwise.complete.obs", method="spearman"),
cor(window(percdefol.ts, start=1750, end=1849), use="pairwise.complete.obs", method="spearman"),
cor(window(percdefol.ts, start=1890,1989), use="pairwise.complete.obs", method="spearman"))
cor.dat <- lapply(listx, upper.fun) # extract upper triangle of correlation matrix
cor.dat[[1]]$subset <- "1750-1995" # create new column with time period
cor.dat[[2]]$subset <- "1750-1849" # create new column with time period
cor.dat[[3]]$subset <- "1890-1989" # create new column with time period
cor.dat <- do.call(rbind, cor.dat) # combine into single data.frame
cor.dat$subset <- factor(cor.dat$subset, levels=c("1750-1995", "1750-1849", "1890-1989"), ordered=T)

# plot pairwise correlations
Fig.file <- here("Results", "Figures", "Fig-PairwiseCorrelation.jpg")
jpeg(Fig.file, width=4.48, height=3, units="in", res=300)
ggcorr(percdefol.ts, nbreaks = 7,  method = c("pairwise", "spearman"))
whatever <- dev.off()

# test if pairwise correlations differ in the century prior to and following extensive Euro-American colonization
spearmans.time <- t.test(cor.dat[cor.dat$subset=="1890-1989", "rs"], cor.dat[cor.dat$subset=="1750-1849", "rs"]) 

### KENDALL'S COEFFICIENT OF CONCORDANCE ###
# calculate Kendall's coefficient of concordance (W) for 1750-1995, 1750-1849, and 1890-1989 periods
listw <- list(kendall.w(window(percdefol.ts, start=1750, end=1995), nrands=1000, type=2, quiet=T),kendall.w(window(percdefol.ts, start=1750, end=1849), nrands=1000, type=2, quiet=T),kendall.w(window(percdefol.ts, start=1890,1989), nrands=1000, type=2, quiet=T))
# summarize results
kendalls.w <- data.frame(subset=c("1750-1995", "1750-1849", "1890-1989"), W = sapply(listw, FUN=function(x){return(round(x$w.corrected,2))}),  "p-value" = sapply(listw, FUN=function(x){return(round(x$pval,4))}), r.mean=round(sapply(lapply(listx, upper.fun), colMeans),2), r.max=sapply(lapply(listx, upper.fun), max), r.min=sapply(lapply(listx, upper.fun), min))
kendalls.w$subset <- factor(kendalls.w$subset, levels=c("1750-1995", "1750-1849", "1890-1989"), ordered=T)
kendalls.w$p.value[kendalls.w$p.value==0] <- "<0.001"
write.csv(kendalls.w, here("Results","kendallsw.csv" ), row.names=F)

### CONCURRENCE AMONG PEAKS ###
# This takes a long time to run, so this is set up to only run once
if(!file.exists(here("Results", "peakz-1750-1995.csv"))){
  
  # Calculate concurrence among peaks for 1750-1995 period
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <-  peakz
  peakz.max.lag <-  peakz
  peakz.max.val <- peakz
  for(j in  host.meta.sub$SeriesCode ){
    for(k in 1:nrow(peakz)){
       z <- NULL
        for(t in -5:5){
          percdefol.ts.win <- window(percdefol.ts, start=1750, end=1995) %>% na.omit()
          percdefol.ts.win <- cbind(stats::lag(percdefol.ts.win[,j], k=t), percdefol.ts.win[,k]) %>% na.omit()
          peakjk <- peaks(percdefol.ts.win[,1], percdefol.ts.win[,2])
          z <- c(z, peakjk$obs)
          if(t==0){
            peakjk <- peaks(percdefol.ts.win[,1], percdefol.ts.win[,2], nrands=1000, type=2, quiet=T)
            peakz[k,j] <- peakjk$obs
            peakz.p[k,j] <- peakjk$pval
          }
        }
      peakz.max.lag[k,j] <- paste0((-5:5)[which(z==max(z))][1], collapse=".")
      peakz.max.val[k,j] <- max(z)
      }
    }
  peakz %>% write.csv(here("Results", "peakz-1750-1995.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-p-1750-1995.csv"), row.names = T)
  peakz.max.lag %>% write.csv(here("Results", "peakz-maxlag-1750-1995.csv"), row.names = T)
  peakz.max.val %>% write.csv(here("Results", "peakz-maxvalue-1750-1995.csv"), row.names = T)
    
  # Calculate concordance among peaks for 1750-1849 period
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
    for(j in  host.meta.sub$SeriesCode ){
      for(k in 1:nrow(peakz)){
        peakjk <- peaks(window(percdefol.ts[,j],start=1750, end=1849), window(percdefol.ts[,k], start=1750, end=1849), nrands=1000, type=2, quiet=T)
        peakz[k,j] <- peakjk$obs
        peakz.p[k,j] <- peakjk$pval
      }
    }
  peakz %>% write.csv(here("Results", "peakz-1750-1849.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-p-1750-1849.csv"), row.names = T)
    
  # Calculate concordance among peaks for 1890-1989 period
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
    for(j in  host.meta.sub$SeriesCode ){
      for(k in 1:nrow(peakz)){
        peakjk <- peaks(window(percdefol.ts[,j],start=1890, end=1989), window(percdefol.ts[,k], start=1890, end=1989), nrands=1000, type=2, quiet=T)
        peakz[k,j] <- peakjk$obs
        peakz.p[k,j] <- peakjk$pval
      }
  }
  peakz %>% write.csv(here("Results", "peakz-1890-1989.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-1890-1989.csv"), row.names = T)
}

count.p <- function(x){return(length(x[x<0.05])/nrow(x))}
upper.fun <- function(x){return(data.frame(proportion=as.numeric(x[upper.tri(x)])))}

peakz <- list( read.csv(here("Results", "peakz-1750-1995.csv")),read.csv(here("Results", "peakz-1750-1849.csv")), read.csv(here("Results", "peakz-1890-1989.csv")))
names(peakz) <- c("1750-1995", "1750-1849", "1890-1989")
peakz.mean <- sapply(lapply(peakz, upper.fun), colMeans, na.rm=T)
peakz.time <- t.test(upper.fun(peakz$'1890-1989'), upper.fun(peakz$'1750-1849'))
```

We then quantified the spatial scale at which WSB outbreak occurs synchronously using a spline correlogram [@bjornstadNonparametricSpatialCovariance2001]. Here, time series of the percent of trees defoliated at each site were used to calculate cross correlations. Confidence intervals around the correlation function were calculated using a bootstrap resampling approach with 1000 replications. Calculations were performed using the *ncf* package [@bjornstadNcfSpatialNonparametric2020] in R [@rcoreteam2022].

```{r SNCF, results='hide'}
host.sites.sub <- st_as_sf(x = host.meta.sub, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(26913)
  
### quantify synchrony for 1750-1995 ###
z <- t(as.data.frame(window(percdefol.ts, start=1750, end=1995)))
sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T, quiet=T)
  
# reorganize data and plot
sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted $x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])

sncf.plot <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")
  
Regional.synch.1750.1995 <- summary(sncf.percdefol)$Regional.synch 

# save plot
Fig.file <- here("Results", "Figures", "FigCovariance.jpg")
ggsave(filename=Fig.file, plot=sncf.plot, width=3.5, height=2.4, units="in", dpi=300)

### quantify synchrony for 1750-1849 ###  
z <- t(as.data.frame(window(percdefol.ts,start=1750, end=1849)))
sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T)
  
# reorganize data
sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted$x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])

# make plot
sncf.plot.pre <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")

Regional.synch.1750.1849 <- summary(sncf.percdefol)$Regional.synch 

### quantify synchrony for 1890-1989 ###  
z <- t(as.data.frame(window(percdefol.ts,start=1890, end=1989)))
sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T)

# reorganize data
sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted$x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])
sncf.percdefol.res$sig <- sncf.percdefol.res$upper - sncf.percdefol.res$y

# make plot
sncf.plot.post <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")

Regional.synch.1890.1989 <- summary(sncf.percdefol)$Regional.synch
   
# save plot to file
Fig.file <- here("Results", "Figures", "FigCovariance-Multi.jpg")
jpeg(Fig.file, width=7, height=3, units="in", res=300)
sncf.plot+labs(title="A - 1750-1995") + sncf.plot.pre+labs(title="B - 1750-1849") + sncf.plot.post+labs(title="C - 1890-1989")
whatever <- dev.off()

### quantify synchrony for ponderosa pine chronologies used as control series ###
ts.crn <- function(x){return(ts(x$res, start=min(as.numeric(row.names(x))), end=max(as.numeric(row.names(x)))))}
nonhost.crns.ts <- do.call(cbind,lapply(nonhost.crns, ts.crn))
nonhost.crns.df <- as.data.frame(window(nonhost.crns.ts, start=1750, end=1995))
nonhost.crns.df <- nonhost.crns.df[,colnames(nonhost.crns.df)%in%nonhost.meta.sub$SeriesCode]

nonhost.crns.sites.sub <- st_as_sf(x = nonhost.meta.sub, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>%
  st_transform(26913)

z <- t(nonhost.crns.df)
sncf.nonhost <- Sncf(x=st_coordinates(nonhost.crns.sites.sub)[,1], y=st_coordinates(nonhost.crns.sites.sub)[,2], z, resamp = 1000, na.rm=T, quiet=T)
  
sncf.nonhost.res <- data.frame(x=sncf.nonhost$real$predicted$x[1,], y=sncf.nonhost$real$predicted$y[1,], upper=sncf.nonhost$boot$boot.summary$predicted$y[10,], lower=sncf.nonhost$boot$boot.summary$predicted$y[2,])

sncf.plot.nonhost <- ggplot(sncf.nonhost.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+xlim(0,100)+ylim(-0.5,1)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.nonhost)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")
  
Regional.synch.nonhost <- summary(sncf.nonhost)$Regional.synch

  
Fig.file <- here("Results", "Figures", "FigCovariance-Nonhost.jpg")
jpeg(Fig.file, width=3.5, height=2.4, units="in", res=300)
sncf.plot.nonhost
whatever <- dev.off()
  
Regional.synch <- data.frame(years=c("1750-1995", "1750-1849", "1890-1989", "1750-1995"), synchrony=c(Regional.synch.1750.1995, Regional.synch.1750.1849, Regional.synch.1890.1989, Regional.synch.nonhost), dataset=c(rep("defoliated", 3), "nonhost"))
Regional.synch %>% write.csv(here("Results", "Regional-sychrony.csv"), row.names=F)
```

Third, we used Multivariate Event Analysis to test for clustering among years of outbreak initiation and cessation. Multivariate Event Analysis is a modification of Ripley's K that identifies the synchrony of events in one dimension (time) within a defined window by comparing the timing of events within multiple records [@gavinWeakClimaticControl2006]. Multivariate Event Analyses were performed using the R implementation of the K1D software [@gavin2010K1DAnalysisSynchrony].

```{r MEA}
source(here("Code", "k1d.r"))
  
### INITIATION DATES
# get start dates for each outbreak
k1d.dat.initiation <- NULL
for(j in host.meta.sub$SeriesCode){
  x <- host.outbreak.stats[[j]] %>% filter(duration>=2 & start>=1750)  
  x <- x$start
  xx <- ADS.WSB.sites %>% filter(SeriesCode==j) %>% pull(SURVEY_YEAR)
  x <- c(x, xx)
  x <- ts(x, start=1)
 k1d.dat.initiation <- cbind(k1d.dat.initiation, x)
}  
k1d.dat.initiation[k1d.dat.initiation>1995] <- NA
colnames(k1d.dat.initiation) <- host.meta.sub$SeriesCode

# calculate temporal clustering
k1d.initiation.t<- k1d(k1d.dat.initiation, start=1750, end=1995, nstep=21,stepsize=1)

# simulation confidence intervals
k1d.initiation.s <- k1d.sim(k1d.initiation.t,scenario="random",nsim=100,perc=c(0.025,0.975))

# reshape data
x <- data.frame(h=k1d.initiation.t$h, Lhat=k1d.initiation.t$Lhat, lower=k1d.initiation.s[1,], upper=k1d.initiation.s[2,])
y <- reshape2::melt(x, id.var='h')

# pull out year where correlation falls within confidence interval
initiation.year <- x %>% mutate(dif=Lhat-upper) %>% filter(dif<0) %>% pull(h) %>% min()

# create plot
startk <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+geom_hline(yintercept=0)+labs(x = " ", y = "Temporal clustering") +theme(legend.position="none") +ylim(-7.5, 7.5)
  
### CESSATION DATES
# reorganize data
k1d.dat.cessation <- NULL
for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(start>=1750)
    x <- na.omit(x$cessation)
    xx <- ADS.WSB.sites %>% filter(SeriesCode==j) %>% pull(SURVEY_YEAR)
    x <- c(x, xx)
    x <- ts(x, start=1)
   k1d.dat.cessation <- cbind(k1d.dat.cessation, x)
} 
k1d.dat.cessation[k1d.dat.cessation>1995] <- NA
colnames(k1d.dat.cessation) <- host.meta.sub$SeriesCode

# calculate temporal clustering
k1d.cessation.t<- k1d(k1d.dat.cessation, start=1750, end=1995, nstep=21,stepsize=1)

# simulate confidence intervals
k1d.cessation.s <- k1d.sim(k1d.cessation.t,scenario="random",nsim=100,perc=c(0.025,0.975))

# reorganize data
x <- data.frame(h=k1d.cessation.t$h, Lhat=k1d.cessation.t$Lhat, lower=k1d.cessation.s[1,], upper=k1d.cessation.s[2,])
y <- reshape2::melt(x, id.var='h')

# pull out year where correlation falls within confidence interval
cessation.year <- x %>% mutate(dif=Lhat-upper) %>% filter(dif<0) %>% pull(h) %>% min()
  
# create plot
endk <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="#4F81BD")+geom_hline(yintercept=0)+labs(x = "lag (years)", y = "Temporal clustering") +theme(legend.position="none")  +ylim(-7.5, 7.5)

# combine plots and save to file
Fig.file <- here("Results", "Figures", "MEA.jpg")
jpeg(Fig.file, width=3.5, height=3.5, units="in", res=300)
startk+xlab("lag (years)")+labs(title="A - Initiation") +endk+labs(title="B - Cessation")  + plot_layout(nrow=2)
whatever <- dev.off() 
```

## Quantifying outbreak dynamics for periods before and after Euro-American colonization

To determine if changes in land-use practices associated with Euro-American colonization influenced the dynamics of WSB outbreaks, we split our dataset into two 100-yr periods: (1) 1750-1849 and (2) 1890-1989, or approximately the centuries before and after intensive colonization, respectively [@veblen2000; @huckaby2001LandscapePatternsMontane; @veblen2005]. We then compared site-level outbreak characteristics during these two periods. Specifically, we compared: (1) the probability of an outbreak occurring in an individual year, (2) outbreak duration, (3) the length the period of quiescence between outbreaks, (4) the minimum normalized GSI, and (5) the percent of trees defoliated. Using a generalized linear mixed effect modeling approach, we then modeled the response variable as a function of a categorically variable describing the period as either 1750-1849 or 1890-1989 and tested the statistical hypothesis that the intercept differed from zero using a Wald test. In all models we included a random effect of site identity to account for multiple outbreak events within each site. In the model of outbreak occurrence in a given year, we additionally included a first order autocorrelation structure to account for temporal autocorrelation. Models were fit using Penalized Quasi-Likelihood using the packages *MASS* [@MASS] and *nlme* [@nlme] in R [@rcoreteam2022]. Additionally, we used spline correlograms to determine if the Euro-American colonization affected the spatial scale at which WSB outbreak occurs synchronously. We performed separate analyses for the 1750-1849 and 1890-1989 periods and visually compared the results.

```{r ColonizationEffects}
for(j in names(host.outbreak)){
  last.tree.yr <- max(host.outbreak[[j]]$year)
  last.geo.yr <- geo.outbreak.dat[geo.outbreak.dat$SeriesCode==j, ]$end.yr
  supplement <- data.frame(year=(last.tree.yr+1):last.geo.yr, samp_depth=1, num_defol=NA, perc_defol=NA, num_max_defol=NA, perc_max_defol=NA, mean_gsi=NA, mean_ngsi=NA, outbreak_status="not_obr", SeriesCode=j)
  host.outbreak[[j]] <- rbind(host.outbreak[[j]], supplement)
}

host.outbreak.lag <- lapply(host.outbreak, FUN=function(x){x$outbreak <- ifelse(x$outbreak=="outbreak", 1, 0); return(x)})
host.outbreak.lag <- lapply(host.outbreak.lag, FUN=function(x){x$lag <- c(NA,x$outbreak[(-1*nrow(x))]); return(x)})
host.outbreak.df <- do.call(rbind, host.outbreak.lag)

host.outbreak.df.sub <- host.outbreak.df %>% filter(year %in% (1750:1989 )) %>% filter(!(year %in% (1850:1889)))
host.outbreak.df.sub$timeperiod <- ifelse(host.outbreak.df.sub$year <=1849, "1750-1849", "1890-1989")

host.outbreak.stats.df.sub <- host.outbreak.stats.df %>% filter(start %in% (1750:1989)) %>% filter(!(start %in% (1850:1889)))
host.outbreak.stats.df.sub$timeperiod <- ifelse(host.outbreak.stats.df.sub$start <=1849, "1750-1849", "1890-1989")
host.outbreak.stats.df.sub$n <- round(host.outbreak.stats.df.sub$n_df_start/(host.outbreak.stats.df.sub$perc_df_start/100))

mod.ngsi <- glmmPQL(min_ngsi~timeperiod, random=~1|SeriesCode, family=gaussian, data=host.outbreak.stats.df.sub)
mod.n_df_start <- glmmPQL(cbind(n_df_start,n)~timeperiod, random=~1|SeriesCode, family=binomial, data=host.outbreak.stats.df.sub)
mod.duration <- glmmPQL(duration~timeperiod, random=~1|SeriesCode, family=poisson, data=host.outbreak.stats.df.sub)
mod.q <- glmmPQL(q~timeperiod, random=~1|SeriesCode, family=poisson, data=host.outbreak.stats.df.sub)
mod.outbreak <- glmmPQL(outbreak~timeperiod+lag, random=~1|SeriesCode, family=binomial(link="logit"), data=host.outbreak.df.sub)

modz <- list(mod.outbreak,mod.duration, mod.q, mod.ngsi, mod.n_df_start)
colonization.results <- data.frame(response=c("occurrence of years of outbreak", "duration of outbreak", "length of quiescent period", "minimum normalized GSI during outbreak events", "percent of trees defoliated at start of outbreak"))
colonization.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})

colonization.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})

colonization.results %>% write.csv(here("Results", "colonization.csv"))

host.outbreak.df.sub$outbreak_status <- factor(host.outbreak.df.sub$outbreak_status, levels=c("not_obr","outbreak" ),labels=c("no outbreak","outbreak"), ordered=T)


p1.dat <- host.outbreak.df.sub %>%
  group_by(outbreak_status, timeperiod) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>% 
  filter(outbreak_status=="outbreak") %>% 
  mutate(colz=factor(ifelse(colonization.results[colonization.results$response=="occurrence of years of outbreak",]$p.value<=0.05,c(1,1), c(1,0)))) %>% 
  mutate(label=paste0("n = ", table(host.outbreak.stats.df.sub$timeperiod)))

p1 <- ggplot(p1.dat, aes(x=timeperiod, y=freq, fill=colz))+geom_bar(stat="identity")+ylab("proportion of years\naffected by WSB outbreak")+ theme(axis.title.x=element_blank())+theme(legend.position = "none")+geom_text(aes(label = label, x = timeperiod, y=freq+0.03), size=3)+scale_fill_manual(values=c("darkgray", "#4F81BD")) 

if(colonization.results %>% filter(response=="duration of outbreak") %>% pull(p.value)>=0.05){
  host.outbreak.stats.df.sub$dur.col <- "equal"}else{
  host.outbreak.stats.df.sub$dur.col <- host.outbreak.stats.df.sub$timeperiod
}
    
p2 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=duration, fill=dur.col))+geom_boxplot()+ylab("outbreak duration (years)")+ theme(axis.title.x=element_blank()) +scale_fill_manual(values=c("darkgray", "#4F81BD")) + theme(legend.position="none")

if(colonization.results %>% filter(response=="minimum normalized GSI during outbreak events") %>% pull(p.value)>=0.05){
  host.outbreak.stats.df.sub$min_ngsi.col <- "equal"}else{
  host.outbreak.stats.df.sub$min_ngsi.col <- host.outbreak.stats.df.sub$timeperiod
}

p3 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=min_ngsi, fill=min_ngsi.col))+geom_boxplot()+ylab("Minimum normalized\ngrowth suppression index")+ theme(axis.title.x=element_blank())+scale_fill_manual(values=c("darkgray", "#4F81BD")) + theme(legend.position="none")+xlab("time period")


if(colonization.results %>% filter(response=="percent of trees defoliated at start of outbreak") %>% pull(p.value)>=0.05){
  host.outbreak.stats.df.sub$pdefol.col <- "equal"}else{
  host.outbreak.stats.df.sub$pdefol.col <- host.outbreak.stats.df.sub$timeperiod
}
p4 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=perc_df_start, fill=pdefol.col))+geom_boxplot()+ylab("percent of trees defoliated\nat start of outbreak")+ theme(axis.title.x=element_blank())+scale_fill_manual(values=c("darkgray", "#4F81BD")) + theme(legend.position="none")

if(colonization.results %>% filter(response=="length of quiescent period") %>% pull(p.value)>=0.05){
  host.outbreak.stats.df.sub$q.col <- "equal"}else{
  host.outbreak.stats.df.sub$q.col <- host.outbreak.stats.df.sub$timeperiod
}
p5 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=q, fill=q.col))+geom_boxplot()+ylab("length of quiescent\nperiod (years)") +scale_fill_manual(values=c("darkgray", "#4F81BD")) + theme(legend.position="none")

Fig.file <- here("Results", "Figures", "Colonization.jpg")
jpeg(Fig.file, width=7, height=2.5, units="in", res=300)
p1+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p2+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p5+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p3+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p4+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+plot_layout(nrow=1)+plot_annotation(tag_levels = "A")
whatever <- dev.off()
```

## Quantifying associations between climate and outbreaks of the WSB

To quantify the association between climate variability and WSB outbreak, we used several approaches. First, we used a t-test to determine if SC-PDSI differed during periods of regional outbreak and non-outbreak periods. To quantify SC-PDSI across the region, we averaged SC-PDSI across all sites. Given the assumption of independence of observations and strong serial autocorrelation in the regional SC-PDSI time series, we first fit an autoregressive model to the regional SC-PDSI time series. We used AIC [@akaikeInformationTheoryExtension1973] to select the level of complexity. We fit the autoregressive model using the R package *stats* [@rcoreteam2022] and then performed the t-test on the model residuals.

```{r ttest}
pdsi.out <- na.omit(pdsi.out) # remove missing values
pdsi.out$AVG.resid <- ar(ts(pdsi.out$AVG, start=min(pdsi.out$year)))$resid # fit autoregressive model and get residuals

regional.outbreaks.ex <- data.frame(B18=NA, B19=NA, LJ=NA, SS=NA, WR=NA, JP=NA, WW=NA, SR=NA, NI=NA, SP=NA, WB=NA, TI=NA, year=2000:2020, nsites=NA, noutbreaks=NA, foutbreak=NA, outbreak="no outbreak")

regional.outbreaks$year <- as.numeric(regional.outbreaks$year)
regional.outbreaks.ex  <- rbind(regional.outbreaks[,-ncol(regional.outbreaks)], regional.outbreaks.ex)

all.outbreak.yrs <- host.outbreak.df %>% filter(outbreak_status=="outbreak") %>% pull(year) %>% unique()
regional.outbreaks.ex$all.outbreak <- ifelse(regional.outbreaks.ex$year %in% all.outbreak.yrs, "outbreak", "no outbreak")

x <- full_join(pdsi.out, regional.outbreaks.ex, by="year")
x <- x[x$year>=1750,]
x <- na.omit(x[,c("year", "AVG.resid", "AVG", "outbreak", "all.outbreak")])

x.total <- x[x$year %in% 1750:2020, ]
xt <- t.test(x.total[x.total$outbreak=="outbreak", "AVG.resid"],x.total[x.total$outbreak=="no outbreak", "AVG.resid"] )

pdsi.t <- t.test(x[x$year %in% 1750:1849, "AVG.resid"], x[x$year %in% 1890:1989, "AVG.resid"],)

xt.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("b", "a"))

x.early <- x[x$year %in% 1750:1849,]
x.early.t <- t.test(x.early[x.early$outbreak=="outbreak", "AVG.resid"],x.early[x.early$outbreak=="no outbreak", "AVG.resid"] )

x.early.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("b", "a"))

x.late <- x[x$year %in% 1890:1989,]
x.late.t <- t.test(x.late[x.late$outbreak=="outbreak", "AVG.resid"],x.late[x.late$outbreak=="no outbreak", "AVG.resid"] )

x.late.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("a", "a"))

p1 <- ggplot(x, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=xt.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

p2 <- ggplot(x.early, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=x.early.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

p3 <- ggplot(x.late, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=x.late.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)+theme(axis.title.y=element_blank(), axis.text.y=element_blank())

x$time.period <- NA
x[x$year %in% 1750:1849,]$time.period <- "1750-1849"
x[x$year %in% 1890:1989,]$time.period <- "1890-1989"
xx <- x[x$time.period %in% c("1750-1849","1890-1989"),]

xxt.labs <- data.frame(time.period= c("1750-1849", "1890-1989"), label=c("a", "a"))
p4 <- ggplot(xx, aes(x=time.period, y=AVG))+geom_boxplot()+ylab("SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=xxt.labs, aes(label = label, x =time.period, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

 
Fig.file <- here("Results", "Figures", "T.jpg")
jpeg(Fig.file, width=3.5, height=2, units="in", res=300)
p2+labs(title = "A - 1750-1849")+p3+labs(title = "B - 1890-1989")+plot_layout(nrow=1)
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "T-simple.jpg")
jpeg(Fig.file, width=3.5, height=2, units="in", res=300)
p1
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "T-PDSI.jpg")
jpeg(Fig.file, width=3.5, height=2, units="in", res=300)
p4
whatever <- dev.off()

```

We then used superposed epoch analysis [@loughAssessmentPossibleEffects1987] to compare SC-PDSI values in years with and without outbreak initiations and cessations [@flower2014; @harvey2018]. Specifically, we used superposed epoch analysis to calculate the departure from the mean SC-PDSI for the years prior to a year of outbreak initiation (cessation), during the year of outbreak initiation (cessation), and following the year of outbreak initiation (cessation) using an 11-year window centered on the event year [@flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017]. To determine if departures from the mean value were significant, we used 1000 bootstrap samples with a block resampling design that preserved autocorrelation in a 5-year window. While block resampling estimates null distributions for serially autocorrelated data, p-values generated in this way may still be too small if autocorrelation is strong (i.e., \> 60%) over lags greater than the analysis interval. Thus prior to running our superposed epoch analyses, we confirmed that minimal (r\<0.05) serial correlation existed at lags greater than 5 years. We superposed epoch analyses using the dates of outbreak initiation and cessation from the regional outbreak record and the regional SC-PDSI time series. Superposed epoch analysis was performed in R [@rcoreteam2022] using the *dplR* package [@bunn2024DplRDendrochronologyProgram; @bunn2008].

```{r sea.regional}
pdsi.out.avg <- pdsi.out %>% filter(year>=1750 & year <=2023) %>% dplyr::select(AVG)
row.names(pdsi.out.avg) <- 1750:2023

sea.initiation.regional <- sea(x=pdsi.out.avg, key=regional.outbreak.summary[regional.outbreak.summary$start>1750,]$start, lag=5) %>% mutate(sig = cut(p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T), timing="initiation", definition="regional")

sea.initiation.regional2 <- sea(x=pdsi.out.avg, key=regional.outbreak.summary[regional.outbreak.summary$start>1750,]$start2, lag=5) %>% mutate(sig = cut(p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T), timing="initiation", definition="regional 2")

sea.cessation.regional <- sea(x=pdsi.out.avg, key=regional.outbreak.summary[regional.outbreak.summary$start>1750,]$end+1, lag=5) %>% mutate(sig = cut(p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T), timing="cessation", definition="regional")

sea.cessation.regional2 <- sea(x=pdsi.out.avg, key=regional.outbreak.summary[regional.outbreak.summary$start>1750,]$end2+1, lag=5) %>% mutate(sig = cut(p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T), timing="cessation", definition="regional 2")

sea.dat <- bind_rows(sea.initiation.regional, sea.initiation.regional2, sea.cessation.regional, sea.cessation.regional2) %>% mutate(timing=factor(timing, levels=c("initiation", "cessation"), ordered=T), definition=factor(definition, levels=c("regional", "regional 2"), labels=c("≥33% of sites\nare recording", "any site is recording\nduring regional outbreak"), ordered=T))

p <- ggplot(sea.dat, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"),drop=F)+ylab("JJA SC-PDSI")+xlab("lag (years)")+facet_grid(definition~timing)

Fig.file <- here("Results", "Figures", "SEA-Regional.jpg")
jpeg(Fig.file, width=3.5, height=4, units="in", res=300)
p
whatever <- dev.off() 
```

```{r sea.site}
sea.initiation <- NULL
sea.cessation <- NULL
row.names(pdsi.out) <- pdsi.out$year
for(j in host.meta.sub$SeriesCode){
  z <- outbreak.summary.tab %>% filter(SeriesCode==j)
  start.j <- sapply(strsplit(z$TOTAL, split="-"), "[", 1) %>% as.numeric()
  start.j <- ifelse(start.j<1750, 1750, start.j)
  end.j <- sapply(strsplit(z$TOTAL, split="-"), "[", 2) %>% as.numeric()
  pdsi.out.j <- ts(pdsi.out[,j], start=min(as.numeric(row.names(pdsi.out))))
  pdsi.out.j <- window(pdsi.out.j, start=start.j, end=end.j)
  yearz <- time(pdsi.out.j)
  pdsi.out.j <-  pdsi.out.j %>% as.data.frame()
  colnames(pdsi.out.j) <- "PDSI"
  row.names(pdsi.out.j) <- yearz
  
  x <- host.outbreak.stats[[j]] %>% filter(duration>4)
  sea.initiation[[j]] <- sea(x= pdsi.out.j, key=x$start, lag=5)
  sea.initiation[[j]]$SeriesCode <- j
  sea.initiation[[j]]$sig05 <- ifelse(sea.initiation[[j]]$p <=0.05, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
  sea.initiation[[j]]$sig10 <- ifelse(sea.initiation[[j]]$p >0.05 & sea.initiation[[j]]$p <=0.1, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
   sea.initiation[[j]]$pos01 <- ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)

  sea.cessation[[j]] <- sea(x= pdsi.out.j, key=x$cessation, lag=5)
  sea.cessation[[j]]$SeriesCode <- j
  sea.cessation[[j]]$sig05 <- ifelse(sea.cessation[[j]]$p <=0.05, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$sig10 <- ifelse(sea.cessation[[j]]$p >0.05 & sea.cessation[[j]]$p <=0.1, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$pos01 <- ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)

}

sea.cessation.df <- do.call(rbind, sea.cessation)
sea.cessation.df$sig <- cut(sea.cessation.df$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

sea.initiation.df <- do.call(rbind, sea.initiation)
sea.initiation.df$sig <- cut(sea.initiation.df$p, breaks=c(-1,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

Fig.file <- here("Results", "Figures", "SEA-initation-site.jpg")
jpeg(Fig.file, width=7, height=5, units="in", res=300)
ggplot(sea.initiation.df, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI anomaly")+xlab("lag (years)")
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "SEA-cessation-site.jpg")
jpeg(Fig.file, width=7, height=5, units="in", res=300)
ggplot(sea.cessation.df, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI anomaly")+xlab("lag (years)")
whatever <- dev.off()

countpos <- function(x){sum(x[x>=0])}
countneg <- function(x){sum(x[x<0])}

sea.initiation.pos.summary <- sea.initiation.df %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.initiation.neg.summary <- sea.initiation.df %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.initiation.summary <- rbind(sea.initiation.pos.summary, sea.initiation.neg.summary) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.initiation.summary$plotby <- factor(sea.initiation.summary$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"),   labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.cessation.pos.summary <- sea.cessation.df %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.cessation.neg.summary <- sea.cessation.df %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.cessation.summary <- rbind(sea.cessation.pos.summary, sea.cessation.neg.summary) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.cessation.summary$plotby <- factor(sea.cessation.summary$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"), labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.init.combo <- ggplot(sea.initiation.summary, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c('#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-5, 5))+geom_hline(yintercept=0)+theme(legend.title=element_blank())+ylab("Count of sites")

sea.cess.combo <- ggplot(sea.cessation.summary, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c( '#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-5, 5))+geom_hline(yintercept=0)+theme(legend.title=element_blank())

Fig.file <- here("Results", "Figures","SEA-combo-site.jpg")
jpeg(Fig.file, width=5, height=3, units="in", res=300)
sea.init.combo+ylab("Count of sites")+xlab("lag (years)")+labs(title = "A - Initiation")+ sea.cess.combo+xlab("lag (years)")+labs(title = "B - Cessation")+ theme(axis.text.y = element_blank(), axis.title.y = element_blank()) + plot_layout(nrow=1)  + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
whatever <- dev.off()
```

To determine if the duration or magnitude of multi-year drought (i.e., negative SC-PDSI) or wet periods (i.e., positive SC-PDSI) were important in driving the initiation or cessation of WSB outbreaks, we used site-level records of SC-PDSI and outbreak. First, we classified time series of SC-PDSI as periods of either drought or above average moisture availability, which we defined as consecutive years with SC-PDSI values below -1.0 (drought) or above 1.0 (wet periods). For each of these periods, we then calculated the duration and mean and extreme SC-PDSI value (i.e., greatest PDSI value for wet periods and lowest SC-PDSI value for droughts). We then used a generalized linear mixed effect modeling approach to test if the duration, mean, or extreme value of droughts or wet periods differed between periods of outbreak and no outbreak. Specifically, we examined: (1) droughts concurrent with or immediately preceding outbreak initiation, (2) wet periods concurrent/following with outbreak initiation, (3) wet periods concurrent with or immediately preceding outbreak cessation, and (4) drought periods concurrent or following outbreak cessation. In all models we included a fixed effect of the presence/absence of an outbreak event and random effect of site identity, which was included to account for multiple outbreak events within each site. We then tested the statistical hypothesis that the intercept differed from zero using a Wald test. Models were fit using Penalized Quasi-Likelihood using the *MASS* package [@MASS] in R [@rcoreteam2022].

```{r PDSIperiod}
# characterize droughts and wet periods that coincide with outbreaks for each site
regional.outbreaks.climate <- regional.outbreaks %>% filter(year>=1650) %>% dplyr::select(B18:year) %>% pivot_longer(!year)
res <- NULL
for(site in unique(regional.outbreaks.climate$name)){
  dat <- regional.outbreaks.climate %>% filter(name==site) # filter to site
  start.year <- dat %>% na.omit() %>% filter(value==1) %>%  pull(year) %>% min() # get first year of outbreak

  pdsi.out$site <- pdsi.out[,site]
  while(start.year <= max(pdsi.out$year)){
    end.year <- dat %>% filter(year>start.year & value==0) %>% pull(year) %>% min() -1
    
    # get period of drought prior to year of outbreak initiation
    i.drought.end <- pdsi.out %>% filter(year<=start.year & site<0) %>% pull(year) %>% max()
    i.drought.start <- pdsi.out %>% filter(year<i.drought.end & site>1) %>% pull(year) %>% max() +1
    meanj <- pdsi.out %>% filter(year %in% i.drought.start:i.drought.end) %>% pull(site) %>% mean()
    extremej <- pdsi.out %>% filter(year %in% i.drought.start:i.drought.end) %>% pull(site) %>% min()
    resj <- data.frame(site = site, outbreak.start=start.year, outbreak.end=end.year, outbreak.stage="initiation", variable="previous drought", start=i.drought.start, end=i.drought.end, duration_val=length(i.drought.start:i.drought.end), extreme_val=extremej, mean_val=meanj)
    res <- rbind(res, resj)
    
    # get wet period concurrent/following with outbreak initiation
    i.wet.start <- pdsi.out %>% filter(year>=start.year & site>0) %>% pull(year) %>% min()
    if(i.wet.start==start.year){
      i.wet.start <- pdsi.out %>% filter(year<i.wet.start & site<0) %>% pull(year) %>% max()+1
    }
    i.wet.end <- pdsi.out %>% filter(year>=i.wet.start & site<0) %>% pull(year) %>% min() -1
    meanj <- pdsi.out %>% filter(year %in% i.wet.start:i.wet.end) %>% pull(site) %>% mean()
    extremej <- pdsi.out %>% filter(year %in% i.wet.start:i.wet.end) %>% pull(site) %>% max()
    resj <- data.frame(site = site, outbreak.start=start.year, outbreak.end=end.year, outbreak.stage="initiation", variable="concurret wet period", start=i.wet.start, end=i.wet.end , duration_val=length(i.wet.start:i.wet.end), extreme_val=extremej, mean_val=meanj)
    res <- rbind(res, resj)
    
    # get wet period prior to or concurrent with outbreak cessation
    c.wet.end <- pdsi.out %>% filter(year<=end.year & site>0) %>% pull(year) %>% max()
    c.wet.start <- pdsi.out %>% filter(year<c.wet.end & site<0) %>% pull(year) %>% max() +1
    meanj <- pdsi.out %>% filter(year %in% c.wet.start:c.wet.end) %>% pull(site) %>% mean()
    extremej <- pdsi.out %>% filter(year %in% c.wet.start:c.wet.end) %>% pull(site) %>% max()
    resj <- data.frame(site = site, outbreak.start=start.year, outbreak.end=end.year, outbreak.stage="cessation", variable="concurret wet period", start=c.wet.start, end=c.wet.end , duration_val=length(c.wet.start:c.wet.end), extreme_val=extremej, mean_val=meanj)
    res <- rbind(res, resj)
    
    # get drought period concurrent or following outbreak cessation 
    c.drought.start <- pdsi.out %>% filter(year>=end.year & site<0) %>% pull(year) %>% min()
    if(c.drought.start==end.year){
      c.drought.start <- pdsi.out %>% filter(year<c.drought.start & site>0) %>% pull(year) %>% max()+1
    }
    c.drought.end <- pdsi.out %>% filter(year>=c.drought.start & site>0) %>% pull(year) %>% min() -1 
    meanj <- pdsi.out %>% filter(year %in% c.drought.start:c.drought.end) %>% pull(site) %>% mean()
    extremej <- pdsi.out %>% filter(year %in% c.drought.start:c.drought.end) %>% pull(site) %>% min()
    resj <- data.frame(site = site, outbreak.start=start.year, outbreak.end=end.year, outbreak.stage="cessation", variable="subsequent drought", start=c.drought.start, end=c.drought.end, duration_val=length(c.drought.start:c.drought.end), extreme_val=extremej, mean_val=meanj)
    res <- rbind(res, resj)
  
    start.year <- dat %>% na.omit() %>% filter(year>end.year & value==1) %>%  pull(year) %>% min() # get first year with data
  }
}
res.true <- res

# characterize droughts and wet periods for each site
res <-NULL
for(site in unique(regional.outbreaks.climate$name)){
  pdsi.out$site <- pdsi.out[,site]
  pdsi.out$drought <- ifelse(pdsi.out[,site]<0, -1, 1)
  start <- pdsi.out %>% filter(year==1650) %>% pull(drought)
  start.year <- pdsi.out %>% filter(year>=1650 & drought == -1*start) %>% pull(year) %>% min()
  while(start.year <= max(pdsi.out$year)){
    droughtj <- pdsi.out %>% filter(year==start.year) %>% pull(drought)
    pdsi.out.j <- pdsi.out %>% filter(year>start.year & !drought==droughtj)
    if(nrow(pdsi.out.j)>0){
      end.year <- pdsi.out.j %>% pull(year) %>% min() - 1
      meanj <- pdsi.out %>% filter(year %in% start.year:end.year) %>% pull(site) %>% mean()
      if(droughtj==1){
          extremej <- pdsi.out %>% filter(year %in% start.year:end.year) %>% pull(site) %>% max()
        }else{
          extremej <- pdsi.out %>% filter(year %in% start.year:end.year) %>% pull(site) %>% min()
        }
      resj <- data.frame(site=site, drought=droughtj, start=start.year, end=end.year, duration_val=length(start.year:end.year), extreme_val=extremej, mean_val=meanj)
      start.year <- end.year +1 
      res <- rbind(res, resj)
    }else{
      start.year=10000
    }
  }
}
res.null <- res

# drought concurrent with or immediately preceding outbreak initiation
idrought.null <- res.null %>% filter(drought==-1) %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
idrought.yes <- res.true %>% filter(variable=="previous drought"& outbreak.stage=="initiation") %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
idrought.no <- anti_join(idrought.null, idrought.yes) %>% mutate(outbreak=0)
idrought.yes <- idrought.yes %>% mutate(outbreak=1)

idrought <- rbind(idrought.yes, idrought.no)
mod.duration <- glmmPQL(duration_val~factor(outbreak), random=~1|site, family=poisson, data=idrought)
mod.mean <- glmmPQL(mean_val~factor(outbreak), random=~1|site, family=gaussian, data=idrought )
mod.extreme <- glmmPQL(extreme_val~factor(outbreak), random=~1|site, family=gaussian, data=idrought )
modz <- list(mod.duration, mod.mean, mod.extreme)

idrought.results <- data.frame(response=c("duration", "mean", "extreme"))
idrought.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})
idrought.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})
idrought.results$xvar <- "idrought"

idrought <- idrought %>% 
  mutate(sig =ifelse(idrought.results[idrought.results$response=="mean",]$p.value<0.05, 1,0), mean_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(idrought.results[idrought.results$response=="duration",]$p.value<0.05, 1,0), duration_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(idrought.results[idrought.results$response=="extreme",]$p.value<0.05, 1,0), extreme_colz=sig*outbreak) %>%
  mutate(outbreak=factor(outbreak, levels=c(0,1), labels=c("no outbreak", "outbreak"))) %>% 
  dplyr::select(outbreak, duration_val, extreme_val, mean_val, mean_colz, duration_colz, extreme_colz) %>%
  pivot_longer(-outbreak, 
               names_to = c("Var", ".value"), 
               names_sep="_" ) %>% 
  mutate(xvar="idrought")

#  wet period concurrent with or immediately following outbreak initiation
iwet.null <- res.null %>% filter(drought==1) %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
iwet.yes <- res.true %>% filter(variable=="concurret wet period" & outbreak.stage=="initiation") %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
iwet.no <- anti_join(iwet.null, iwet.yes) %>% mutate(outbreak=0)
iwet.yes <- iwet.yes %>% mutate(outbreak=1)

iwet <- rbind(iwet.yes, iwet.no)
mod.duration <- glmmPQL(duration_val~factor(outbreak), random=~1|site, family=poisson, data=iwet)
mod.mean <- glmmPQL(mean_val~factor(outbreak), random=~1|site, family=gaussian, data=iwet )
mod.extreme <- glmmPQL(extreme_val~factor(outbreak), random=~1|site, family=gaussian, data=iwet )
modz <- list(mod.duration, mod.mean, mod.extreme)

iwet.results <- data.frame(response=c("duration", "mean", "extreme"))
iwet.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})
iwet.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})
iwet.results$xvar <- "iwet"

iwet <- iwet %>% 
  mutate(sig =ifelse(iwet.results[iwet.results$response=="mean",]$p.value<0.05, 1,0), mean_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(iwet.results[iwet.results$response=="duration",]$p.value<0.05, 1,0), duration_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(iwet.results[iwet.results$response=="extreme",]$p.value<0.05, 1,0), extreme_colz=sig*outbreak) %>%
  mutate(outbreak=factor(outbreak, levels=c(0,1), labels=c("no outbreak", "outbreak"))) %>% 
  dplyr::select(outbreak, duration_val, extreme_val, mean_val, mean_colz, duration_colz, extreme_colz) %>%
  pivot_longer(-outbreak, 
               names_to = c("Var", ".value"), 
               names_sep="_" ) %>% 
  mutate(xvar="iwet")

#  wet period concurrent with or immediately preceding outbreak cessation
cwet.null <- res.null %>% filter(drought==1) %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
cwet.yes <- res.true %>% filter(variable=="concurret wet period" & outbreak.stage=="cessation") %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
cwet.no <- anti_join(cwet.null, cwet.yes) %>% mutate(outbreak=0)
cwet.yes <- cwet.yes %>% mutate(outbreak=1)

cwet <- rbind(cwet.yes, cwet.no)
mod.duration <- glmmPQL(duration_val~factor(outbreak), random=~1|site, family=poisson, data=cwet)
mod.mean <- glmmPQL(mean_val~factor(outbreak), random=~1|site, family=gaussian, data=cwet )
mod.extreme <- glmmPQL(extreme_val~factor(outbreak), random=~1|site, family=gaussian, data=cwet )
modz <- list(mod.duration, mod.mean, mod.extreme)

cwet.results <- data.frame(response=c("duration", "mean", "extreme"))
cwet.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})
cwet.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})
cwet.results$xvar <- "cwet"

cwet <- cwet %>% 
  mutate(sig =ifelse(cwet.results[cwet.results$response=="mean",]$p.value<0.05, 1,0), mean_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(cwet.results[cwet.results$response=="duration",]$p.value<0.05, 1,0), duration_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(cwet.results[cwet.results$response=="extreme",]$p.value<0.05, 1,0), extreme_colz=sig*outbreak) %>%
  mutate(outbreak=factor(outbreak, levels=c(0,1), labels=c("no outbreak", "outbreak"))) %>% 
  dplyr::select(outbreak, duration_val, extreme_val, mean_val, mean_colz, duration_colz, extreme_colz) %>%
  pivot_longer(-outbreak, 
               names_to = c("Var", ".value"), 
               names_sep="_" ) %>% 
  mutate(xvar = "cwet")

#  drought concurrent with or immediately following outbreak cessation
cdrought.null <- res.null %>% filter(drought==-1) %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
cdrought.yes <- res.true %>% filter(variable=="subsequent drought" & outbreak.stage=="cessation") %>% dplyr::select(site, start, end, duration_val, extreme_val, mean_val)
cdrought.no <- anti_join(cdrought.null, cdrought.yes) %>% mutate(outbreak=0)
cdrought.yes <- cdrought.yes %>% mutate(outbreak=1)

cdrought <- rbind(cdrought.yes, cdrought.no)
mod.duration <- glmmPQL(duration_val~factor(outbreak), random=~1|site, family=poisson, data=cdrought)
mod.mean <- glmmPQL(mean_val~factor(outbreak), random=~1|site, family=gaussian, data=cdrought )
mod.extreme <- glmmPQL(extreme_val~factor(outbreak), random=~1|site, family=gaussian, data=cdrought )
modz <- list(mod.duration, mod.mean, mod.extreme)

cdrought.results <- data.frame(response=c("duration", "mean", "extreme"))
cdrought.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})
cdrought.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})
cdrought.results$xvar <- "cdrought"

cdrought <- cdrought %>% 
  mutate(sig =ifelse(cdrought.results[cdrought.results$response=="mean",]$p.value<0.05, 1,0), mean_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(cdrought.results[cdrought.results$response=="duration",]$p.value<0.05, 1,0), duration_colz=sig*outbreak) %>% 
  mutate(sig =ifelse(cdrought.results[cdrought.results$response=="extreme",]$p.value<0.05, 1,0), extreme_colz=sig*outbreak) %>%
  mutate(outbreak=factor(outbreak, levels=c(0,1), labels=c("no outbreak", "outbreak"))) %>% 
  dplyr::select(outbreak, duration_val, extreme_val, mean_val, mean_colz, duration_colz, extreme_colz) %>%
  pivot_longer(-outbreak, 
               names_to = c("Var", ".value"), 
               names_sep="_" ) %>% 
  mutate(xvar = "cdrought")

icdat <- bind_rows(idrought, iwet, cwet, cdrought) %>%
  mutate(Var=factor(Var, levels=c("mean", "extreme","duration"), labels=c("mean SC-PDSI", "extreme SC-PDSI", "duration (years)"), ordered=T)) %>% 
  mutate(xvar=factor(xvar, levels=c("idrought", "iwet", "cwet", "cdrought"), labels=c("drought coinciding with\noutbreak initiation", "wet period coinciding\nwith outbreak initiation", "wet period coinciding\nwith outbreak cessation", "drought coinciding with\noutbreak cessation"), ordered=T))

icdat.results <- bind_rows(idrought.results, iwet.results, cwet.results, cdrought.results) %>% 
  mutate(xvar=factor(xvar, levels=c("idrought", "iwet", "cwet", "cdrought"), labels=c("drought coinciding with outbreak initiation", "wet period coinciding with outbreak initiation", "wet period coinciding with outbreak cessation", "drought coinciding with outbreak cessation"), ordered=T))
write.csv(icdat.results, here("results", "outbreak-PDSIperiods.csv"), row.names=F)

PDSIperiods.plot <- icdat %>% ggplot(aes(x=outbreak, y=val, fill=factor(colz)))+geom_boxplot()+facet_grid2(Var~xvar, scales = "free_y", independent = "y")+scale_fill_manual(values=c("darkgray", "#4F81BD"))+theme(legend.position="none", axis.title.x = element_blank(), axis.title.y=element_blank())
ggsave(filename=here("results", "figures", "outbreak-PDSIperiods.jpg"), plot=PDSIperiods.plot, width=7, height=4, units="in", dpi=300)
```

# Results

## Outbreak reconstruction summary

Using the combined tree-ring and geospatial datasets, we were able to reconstruct a total of `r outbreak.summary.tab %>% pull(no.outbreaks) %>% sum()` WSB outbreaks at `r outbreak.summary.tab %>% nrow()` sites (Table \@ref(tab:outbreaksummary); Figure \@ref(fig:FigOutbreakHistory)). The `r outbreak.summary.tab %>% nrow()` outbreak reconstruction histories have starting dates between `r sapply(host.outbreak, FUN=function(x){return(min(x[x$samp_depth>=4, ]$year))}) %>% min()` and `r sapply(host.outbreak, FUN=function(x){return(min(x[x$samp_depth>=4, ]$year))}) %>% max()` and ending dates between 2002 and 2023. Most sites experienced at least `r outbreak.summary.tab$no.outbreaks %>% median() %>% trunc()` outbreaks, however one site experienced only `r outbreak.summary.tab %>% pull(no.outbreaks) %>% min()` outbreaks, and two sites experienced `r outbreak.summary.tab %>% pull(no.outbreaks) %>% max()` outbreaks. The average outbreak duration at an individual site ranged from `r outbreak.summary.tab %>% pull(dur) %>% min()` to `r outbreak.summary.tab %>% pull(dur) %>% max()` years (mean: `r outbreak.summary.tab %>% pull(dur) %>% mean() %>% trunc(1)` years) and the average quiescent period ranged from `r outbreak.summary.tab %>% pull(q) %>% min()` to `r outbreak.summary.tab %>% pull(q) %>% max()` years (mean: `r outbreak.summary.tab %>% pull(q) %>% mean() %>% trunc(1)` years).

We identified `r regional.outbreak.summary %>% nrow()` periods of regional outbreak, which occurred between 1666 and 2023 (Figure \@ref(fig:FigOutbreakHistory)). On average periods of regional outbreak with at least one third of sites were concurrently experiencing outbreak lasted `r regional.outbreak.summary %>% pull(duration) %>% mean() %>% round(1)` years (range:`r regional.outbreak.summary %>% pull(duration) %>% min()`-`r regional.outbreak.summary %>% pull(duration) %>% max()` years) with `r regional.outbreak.summary %>% pull(q) %>% mean(na.rm=T) %>% round(1)` years between outbreak periods (range: `r regional.outbreak.summary %>% pull(q) %>% min(na.rm=T)` - `r regional.outbreak.summary %>% pull(q) %>% max(na.rm=T)` years). However, when the initiation and cessation of regional outbreaks were defined using the first and last year any site was experiencing an outbreak that overlapped with a period of regional outbreak, outbreak duration was on average `r (regional.outbreak.summary %>% pull(duration2) %>% mean() / regional.outbreak.summary %>% pull(duration) %>% mean()) %>% round(1)` times greater (mean:`r regional.outbreak.summary %>% pull(duration2) %>% mean() %>% round(1)` years; range:`r regional.outbreak.summary %>% pull(duration2) %>% min()`-`r regional.outbreak.summary %>% pull(duration2) %>% max()` years) with `r regional.outbreak.summary %>% pull(q2) %>% mean(na.rm=T) %>% round(1)` years between outbreak periods (range: `r regional.outbreak.summary %>% pull(q2) %>% min(na.rm=T)` - `r regional.outbreak.summary %>% pull(q2) %>% max(na.rm=T)` years).

```{r start landscape outbreaksummary}
op_section <- prop_section(type = "continuous")
block_section(op_section) # create section in landscape format
```

```{r outbreaksummary,  tab.cap='Summary of site-level outbreak characteristics. The tree-ring record length includes years with at least four trees recording growth. The quiescent period length was calculated as the number of years between outbreak cessation and the initiation of a subsequent outbreak. Actual evapotranspiration (AET) and climatic water deficit (CWD) data are from Rodman et al. (2020) and represent mean annual values from 1981-2010.', tab.id='outbreaksummary'}
site.order <- host.meta.sub %>% arrange(Lat) %>% pull(SeriesCode)
outbreak.summary.tab.print$Site <- factor(outbreak.summary.tab.print$Site, levels=rev(site.order), ordered=T)
outbreak.summary.tab.print <- outbreak.summary.tab.print %>% arrange(Site)
ft <- qflextable(outbreak.summary.tab.print)
ft %>%  set_table_properties(layout = "autofit", width=1)
```

```{r end landscape outbreaksummary}
close_section <- prop_section(
    page_size = page_size(orient = "landscape"), 
    type = "continuous")
block_section(close_section) # end section in landscape format
```

```{r, FigOutbreakHistory, fig.cap="Variability of the self-calibrated Palmer Drought Severity Index (SC-PDSI) (A) and WSB outbreaks by site arranged from north to south (B) and the number of sites across the region (C). In all panels, periods of regional outbreak with at least one third of sites experience outbreak are highlighted by darker gray shading and lighter gray shading shows where at least one site is experiencing an outbreak coincident with regional outbreak. The 1750-1849 period prior to extensive Euro-American colonization is shown in lighter blue, while the 1890-1989 period is shown in dark blue. In A, the thin line shows a tree-ring based reconstruction of SC-PDSI, while the thick black line shows a 10-year rolling mean of that time series. In C, the bars show the number of sites recording an outbreak and the dashed line shows the number of potential tree-ring recording sites. ", fig.width=7, fig.height=5.5, results="show"}
pdsi.out$PDSIroll <- rollapply(pdsi.out$AVG, align="center", width=10, FUN="mean", fill=NA)
pdsi.out$colorz <- cut(pdsi.out$year, breaks=c(1600,1750,1850,1890,1990,2025), include.lowest=T, right=F)
regional.outbreak.summary2 <- regional.outbreak.summary[,3:4] %>% unique()
ADS.WSB.sites$count <- 1

p1 <- ggplot(pdsi.out, aes(x=year, y=AVG))+geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start-0.5, xmax = end+0.5), alpha = 0.2, fill = "gray10")+geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start2-0.5, xmax = end2+0.5), alpha = 0.2, fill = "gray10")+ geom_line(aes(col=colorz))+geom_line(aes(y=PDSIroll, x=year), col="black", linewidth=1.1)+geom_hline(yintercept=0)+xlim(1625,2023)+ylab("SC-PDSI")+scale_x_continuous(breaks=c(1700, 1750, 1800,1850, 1900,1950, 2000), limits=c(1625,2023))+scale_color_discrete(type=c("gray25","#4F81BD", "gray25", "#081D58", "gray25"))+theme(legend.position = "none")
host.outbreak.stats.df$SeriesCode <- factor(host.outbreak.stats.df$SeriesCode, levels=site.order, ordered=T)

host.outbreak.stats.df$colorz <- cut(host.outbreak.stats.df$start, breaks=c(1600,1750,1850,1890,1990,2025), include.lowest=T, right=F)

p2 <- ggplot(host.outbreak.stats.df, aes(x=start-0.5, xend=end+0.5, y=SeriesCode, yend=SeriesCode)) + geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start-0.5, xmax = end+0.5), alpha = 0.2, fill = "gray10") +geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start2-0.5, xmax = end2+0.5), alpha = 0.2, fill = "gray10")+geom_segment(aes(color=colorz))+geom_segment(data=na.omit(ADS.WSB.sites),aes(y=SeriesCode, yend=SeriesCode, x=SURVEY_YEAR-0.5, xend=SURVEY_YEAR+0.5), color="gray25")+ylab("Site")+xlab("Year")+xlim(1625,2023)+scale_x_continuous(breaks=c(1700, 1750, 1800,1850, 1900,1950, 2000), limits=c(1625,2023))+scale_color_discrete(type=c("gray25","#4F81BD", "gray25", "#081D58", "gray25"))+theme(legend.position = "none")

regional.outbreaks$colorz <- cut(regional.outbreaks$year, breaks=c(1600,1750,1850,1890,1990,2025), include.lowest=T, right=F)
p3 <- ggplot(regional.outbreaks, aes(x=year)) + geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start-0.5, xmax = end+0.5), alpha = 0.2, fill = "gray20")+geom_rect(data=regional.outbreak.summary, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start2-0.5, xmax = end2+0.5), alpha = 0.2, fill = "gray10") + geom_bar(aes(y=noutbreaks, fill=colorz), stat="identity",width=1) + geom_bar(data=ADS.WSB.sites, aes(x=SURVEY_YEAR, y=count), stat="identity",width=1)+geom_line(aes(y=nsites), linetype="dashed")+scale_y_continuous(name="number of sites",breaks=c(0,5,10))+scale_x_continuous(breaks=c(1700, 1750, 1800,1850, 1900,1950, 2000), limits=c(1625,2023))+scale_fill_discrete(type=c("gray25","#4F81BD", "gray25", "#081D58", "gray25"))+theme(legend.position = "none")

Fig.file <- here("Results", "Figures", "OutbreakHistory-Combo.jpg")
jpeg(Fig.file, width=7, height=5.5, units="in", res=300)
p1 + theme(axis.title.x = element_blank(), axis.text.x=element_blank())+ p2+ theme(axis.title.x = element_blank(), axis.text.x=element_blank()) +p3 +plot_layout(nrow=3, heights=c(0.9, 1.5, 0.9)) +plot_annotation(tag_levels = "A")
whatever <- dev.off()


knitr::include_graphics(here("Results", "Figures", "OutbreakHistory-Combo.jpg"))
```

## Synchrony of outbreaks

We found that sites across the study area exhibited similar temporal patterns of WSB outbreak (Fig. \@ref(fig:FigOutbreakHistory) and Fig. S\@ref(fig:FigPercDefol)). Over the 1750-1995 period, we found moderate agreement among time series of the percent of trees defoliated at a site (W = `r kendalls.w %>% filter(subset=="1750-1995") %>% pull(W)`; p `r kendalls.w %>% filter(subset=="1750-1995") %>% pull(p.value)`; mean inter-site r~s~ = `r kendalls.w %>% filter(subset=="1750-1995") %>% pull(r.mean)`; mean inter-site C= `r round(peakz.mean[1],2)*100`%). However, relationships between some pairs of sites were neutral or even negative (range of. inter-site r~s~: `r kendalls.w %>% filter(subset=='1750-1995') %>% pull(r.min) %>% round(2)` - `r kendalls.w %>% filter(subset=='1750-1995') %>% pull(r.max) %>% round(2)`; range of inter-site C: `r peakz[[1]][-1][upper.tri(peakz[[1]][-1])] %>% min() %>% round(2)` - `r peakz[[1]][-1][upper.tri(peakz[[1]][-1])] %>% max() %>% round(2)`), highlighting site-level variation in outbreak dynamics across the study area (Fig. S\@ref(fig:FigPairwiseCor)). This site-level variation was in part explained by geographic proximity; we found that significant synchrony among time series of the percent of trees defoliated existed at distances up to 50 km and that synchrony decreased with increasing distance (Fig. \@ref(fig:FigCovariance)).

```{r FigCovariance, fig.cap="Nonparametric spatial covariance function describing the covariance among records of the percent of trees defoliated at all 12 sites across study area over the 1750-1995 period. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony).", fig.width=3.5, fig.height=2, results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance.jpg"))
```

Multivariate event analysis indicated that both years of initiation and cessation were significantly clustered in time (Fig. \@ref(fig:FigMEA)). Years of outbreak initiation were more likely than not to occur within `r initiation.year` years of another year of outbreak initiation, while years of outbreak cessation were more likely than not to occur within `r cessation.year` years of another year of outbreak cessation.

\pagebreak

```{r FigMEA, fig.cap="Bidirectional multivariate event analysis of temporal synchrony between dates of WSB outbreak initiation (A) and cessation (B) at 12 sites over the 1750-1995 period (n=57 total outbreaks across the 12 sites and ≥ 3 outbreaks per site). The solid black line is the L(t) function, a transformation of Ripley’s K such that the mean and variance are stabilized through time t, where values >0 indicate synchrony and values <0 indicate asynchrony. The dashed lines indicate 95% confidence interval.", fig.width=3.5, fig.height=4, results="show"}
knitr::include_graphics(here("Results", "Figures", "MEA.jpg"))
```

## Outbreak dynamics for periods before and after Euro-American colonization

Across our study area, we found some outbreak dynamics differed in the century prior to and following extensive Euro-American colonization. Relative to the 1890-1989 period, outbreaks were longer and more severe during the 1750-1849 period (Fig. \@ref(fig:FigColonization); Table S\@ref(tab:colonizationtab)). However, outbreaks occurred about as frequently and the length of the quiescent period and percent of trees defoliated at the start of the outbreak were not statistically different. Nonetheless, a long quiescent period lacking regional outbreaks from 1910-1980 is a conspicuous feature of the period following Euro-American colonization (Fig. \@ref(fig:FigOutbreakHistory)).

```{r FigColonization, fig.cap="The proportion of years affected by WSB outbreak (A), the duration of outbreak (B), the length of the quiescent period (C), the minimum normalized growth suppression index (D), and the percent of trees defoliated at outbreak initiation (E) for the century prior to and after extensive Euro-American colonization (1750-1849 and 1890-1989, respectively). Within each panel, different color boxes or bars indicate significant (p<0.05) differences between groups. In A, the sample sizes printed above bars show the number of total outbreaks recorded at any site during that period. For boxplots, the bottom and top limits of each box are the lower and upper quartiles, respectively; the thick black line within the box is the median; error bars equal ±1.5 times the interquartile range; and points denote outliers, values outside ±1.5 times the interquartile range. ", fig.width=7, fig.height=2.5, results="show"}

knitr::include_graphics(here("Results", "Figures", "Colonization.jpg"))
```

We found synchrony in outbreak dynamics was lower in the 1890-1989 period than the 1750-1849 period. The mean inter-site correlation was `r round((spearmans.time$estimate[2]- spearmans.time$estimate[1])/spearmans.time$estimate[2] *100, 0)`% lower in the century following extensive Euro-American colonization (mean r~s~ for 1750-1859: `r round(spearmans.time$estimate[2], 2)` and mean r~s~ for 1890-1989: `r round(spearmans.time$estimate[1], 2)`; t=`r round(spearmans.time$statistic, 1)`, p=`r round(spearmans.time$p.value, 2)`) and the mean inter-site concurrency was `r round((peakz.time$estimate[2]- peakz.time$estimate[1])/ peakz.time$estimate[2]*100, 0)`% lower (mean C for 1750-1859: `r round(peakz.time$estimate[2], 3)` and mean C for 1890-1989: `r round(peakz.time$estimate[1], 2)`; t=`r round(peakz.time$statistic, 1)`, p\<0.001). While regional synchrony was lower in the 1890-1989 period, spline correlograms calculated for the 1750-1849 and 1890-1989 periods showed similar decreases in synchrony with increasing distances (Fig. S\@ref(fig:FigCovarianceTime)).

## Association between interannual climate variability and outbreaks

Over the 1750-2023 time span, we found periods of outbreak were associated with interannual variability in drought severity (Figure \@ref(fig:FigOutbreakHistory)). During periods of regional outbreak, the mean SC-PDSI was greater (i.e., wetter) than during quiescent periods (mean SC-PDSI~outbreak~ = `r xt$estimate[1] %>% signif(2)`; mean SC-PDSI~quiescent~ = `r xt$estimate[2] %>% signif(2)`; t = `r xt$statistic %>% round(2)`; p = `r xt$p.value %>% round(3)`). These results were supported by superposed epoch analyses conducted using the regional record (Fig. \@ref(fig:FigSEARegional)) and site-level records (Fig. \@ref(fig:FigSEASite)). Here we found that outbreaks were more likely to initiate following periods of drought that were followed by periods of above-average moisture availability. The cessation of regional outbreak generally coincided with a switch from above average moisture availability to below average moisture availability (Fig. \@ref(fig:FigSEARegional) and \@ref(fig:FigSEASite)).

```{r FigSEARegional, fig.cap="Superposed epoch analysis results illustrating the departure from the mean SC-PDSI for the years prior, during, and following regional outbreak events (n=6) over the 1750-2023 period. Descending bars illustrate a negative association with summer SC-PDSI (i.e., drier conditions), ascending bars show a positive association with summer SC-PDSI (i.e., wetter conditions).", fig.width=3.5, fig.height=4}
 
knitr::include_graphics(here("Results", "Figures", "SEA-Regional.jpg"))
```

\pagebreak

```{r FigSEASite, fig.cap="Summary of site-level superposed epoch analyses summarizing the association between summer SC-PDSI and outbreak initiation (A) and cessation (B) over the 1750-2023 period (n=57 total outbreaks across the 12 sites and ≥ 3 outbreaks per site). Red descending bars illustrate the number of sites with a statistically significant negative association with summer SC-PDSI (i.e., drier conditions), blue ascending bars show the number of sites with a statistically significant positive association with summer SC-PDSI (i.e., wetter conditions).",  fig.width=5, fig.height=3}

knitr::include_graphics(here("Results", "Figures","SEA-combo-site.jpg"))
```

Our results also suggest that multi-annual variability in moisture availability may be important in driving WSB outbreaks. Specifically, we found that outbreak initiation was proceeded by droughts that were on average `r idrought %>% filter(Var=="duration" & xvar=="idrought") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean) %>% round(1) - idrought %>% filter(Var=="duration" & xvar=="idrought") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) %>% round(1)` years longer and where the minimum SC-PDSI was `r (idrought %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean)  / idrought %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) *100) %>%  round(0)`% lower than drought periods that did not coincide with outbreak initiation events (Fig. \@ref(fig:FigPDSIperiods) and Table S\@ref(tab:PDSIperiodstab)). Further, outbreak initiations were followed by wet periods that were on average `r iwet %>% filter(Var=="duration") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean) %>% round(1) - iwet %>% filter(Var=="duration") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) %>% round(1)` years longer, `r (iwet %>% filter(Var=="mean") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean)  / iwet %>% filter(Var=="mean") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) *100) %>%  round(0)`% wetter, and where the maximum SC-PDSI was `r (iwet %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean)  / iwet %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) *100) %>%  round(0)`% wetter than wet periods that did not coincide with outbreak initiation events. Outbreak cessation events were often proceeded by wet periods where the maximum SC-PDSI was `r (cwet %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean)  / cwet %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) *100) %>%  round(0)`% wetter than wet periods that did not coincide with outbreak cessation events. Further, periods of drought that coincided with outbreak cessation were on average `r cdrought %>% filter(Var=="duration") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean) %>% round(1) - cdrought %>% filter(Var=="duration") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) %>% round(1)` year longer and the minimum SC-PDSI was `r (cdrought %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="outbreak") %>% pull(mean)  / cdrought %>% filter(Var=="extreme") %>% group_by(outbreak) %>% summarize(mean=mean(val)) %>% filter(outbreak=="no outbreak") %>% pull(mean) *100) %>%  round(0)`% lower than drought periods that did not coincide with outbreak cessation events.

\pagebreak

```{r FigPDSIperiods, fig.cap="Characteristics of the droughts and wet periods coinciding with periods of outbreak and no outbreak over the 1750-2023 period. Boxes differing in color indicate significant (p<0.05) differences between the groups", fig.width=7, fig.height=4, results="show"}
knitr::include_graphics(here("Results", "Figures","outbreak-PDSIperiods.jpg"))
```

# Discussion

Here we combined tree-ring and geospatial data to reconstruct periods of WSB outbreak at 12 sites across northern to central Colorado. We used this dataset to examine the overarching hypothesis that climate variability and the effects of land use are important drivers of WSB outbreaks dynamics. We show: (1) WSB outbreaks occur synchronously across sites, suggestive of the combined effects of density-dependent processes and the Moran effect; (2) reduced synchrony of outbreaks following Euro-American colonization may be explained by changes in forest communities due to land use practices; (3) outbreaks were often proceeded by periods of drought and sustained by periods of above average moisture availability; (4) outbreak cessation often co-occurred with drought.

## Outbreak histories

We identified `r regional.outbreak.summary %>% nrow()` periods of regional outbreak, which occurred between 1666 and 2023. These periods correspond with periods of outbreak identified in other dendroecological studies from Colorado (Table S\@ref(tab:historytab)). Furthermore the 1980s outbreak is well documented in observational records from Colorado [@hadleyStandResponseWestern1993; @weber1995DendroecologicalReconstructionWestern]. While our regional record lacks the 1940s and 1960s outbreaks present in some observational records from Colorado (Table S\@ref(tab:historytab)), these outbreaks were recorded in 25% of our site reconstructions. Overall, we conclude that the agreement between existing tree-ring and observational records confirms that tree-ring data can provide insights into periods of past WSB outbreak, as has been previously reported [@swetnam1989].

Across all our sites the mean outbreak duration (`r host.outbreak.stats.df %>% pull(duration) %>% mean() %>% round(1)` years) was similar to those previously reported in dendroecological studies conducted in interior Pacific Northwest (mean duration: 12 years) [@flower2014] and the Colorado Front Range (mean duration: 6.9 years) [@weber1995DendroecologicalReconstructionWestern]. However, outbreaks in our record were notably shorter than in dendroecological records from central British Columbia (mean duration: 18 years) [@harvey2018] and southwestern Colorado (mean duration: 18.4 years) [@ryerson2003TreeringReconstructionWestern]. These differences may reflect geographic variability and differences in tree-ring data collection and processing methods. Collectively this highlights the need for more research that addresses the drivers of outbreak dynamics in space and time, as well as the need for infrastructure for sharing dendroecological data, code, and research that integrates multiple studies.

## Inter-site synchrony

We found that WSB outbreak occurs synchronously across northern to central Colorado, consistent with previous dendroecological research [@swetnam1993; @ryerson2003TreeringReconstructionWestern; @flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017]. For populations of irruptive insects, temporal synchrony may arise from density-dependent processes (e.g., dispersal, predation) and/or the Moran effects, where spatial autocorrelation in exogenous drivers, such as climate, leads to synchrony [@liebhold2004WithinpopulationSpatialSynchrony]. Here we found that both regional synchrony (`r Regional.synch %>% filter(years=="1750-1995" & dataset=="defoliated") %>% pull(synchrony) %>% round(2)`) and the spatial scale at which synchrony was statistically significant (≤50 km) were lower than we would expect if climate, acting independently of WSB population dispersal, was the only driver. For instance, across the 12 drought-sensitive ponderosa pine chronologies used to remove climate-trends in host ring-width series, we calculated greater regional synchrony (`r Regional.synch %>% filter(years=="1750-1995" & dataset=="nonhost") %>% pull(synchrony) %>% round(2)`) and significant correlations at greater distances (i.e., up to 100 km; Fig. S\@ref(fig:FigCovarianceNonHost)). This is consistent with previous research spatiotemporal patterns of contemporary WSB outbreak in British Columbia that has suggested that dispersal is key in driving the synchronization of WBS population dynamics [@senf2017MultiscaleAnalysisWestern]. Our records also show that outbreaks can develop concurrently in disjunct populations. For instance, evidence of the 1820s outbreak first appears in the tree-ring record in 1825 at the TI and JP sites, the furthest apart of our sites. While budworms are strong fliers that can disperse hundreds of kilometers in the right weather conditions [@sturtevant2013LongdistanceDispersalSpruce], most dispersal occurs at much shorter distances (i.e, \<15 km) [@senf2017MultiscaleAnalysisWestern]. Thus both dispersal and the Moran effect are likely important in driving the synchrony of local populations of WSBs [@flower2014; @senf2017MultiscaleAnalysisWestern].

## Euro-American colonization and outbreak dynamics

We found that some attributes of outbreaks dynamics differed during the period prior to and after Euro-American colonization. During the 1750-1849 period, outbreaks were longer, more severe, and more synchronous across the region. Nonetheless, one of the most synchronous, widespread, and severe outbreaks in our record occurred in the 1990s, when 8 out of 12 sites were affected. Collectively this suggests that Euro-American colonization may have been initially associated with a period of lower severity outbreaks that occurred less synchronously across the region. This period was followed by a period where outbreak dynamics were more similar to dynamics prior to Euro-American colonization. This pattern, which has been previously reported for the Southwest [@swetnam1993], may have occurred because of changes in landscape-level availability of host trees [@hadleyStandResponseWestern1993; @senf2017MultiscaleAnalysisWestern]. Greater regional host availability can increase probability and severity of local WSB outbreak, independent of stand susceptibility, by influencing the potential for dispersing WSBs to arrive at the focal stand [@senf2017MultiscaleAnalysisWestern; @nealis2021EcologyOutbreakPopulations; @howe2024BudwormsBeetlesWildfire]. Across our study area, initial logging and burning reduced host availability in the early 20th century [@veblen1991ColoradoFrontRange]. Many, if not most, of the Douglas-fir dominated stands in our study area originated after widespread burning in the second half of the 19th century [@sherriff2007SpatiallyExplicitReconstructionHistorical]. Thus, during the 1910-1980 quiescent period much of the study area would have been too young to be highly susceptible to WSB outbreak. However, during the late-20th century further development of multi-storied structures and increased host abundance coincident with continued absence of wildfire may have promoted a regional increase in susceptibility to WSB outbreak [@hadleyStandResponseWestern1993; @rodman2019WildfireActivityLand]. Consequently, considering the history of regional land-use practices is critical to understanding temporal and spatial is critical to understanding temporal and spatial patterns of WSB outbreaks.

Nonetheless, we note that concurrent changes in land-use practices and climate can limit our ability to detect the effects of changes in land-use practices on forest ecosystems. For example, Schoennagel et al. [-@schoennagelMultidecadalClimateVariability2007] found that over 50% of the fires recorded in the upper montane zone of the Colorado Front Range from 1750-1989 burned in a 41 year period (1850-1890), which coincided with a multidecadal period of drought and widespread mining activity. Here, we found a prolonged period of regional WSB quiescence in the century following extensive Euro-American colonization. While summer PDSI conditions were similar during the 1750-1849 and 1890-1989 periods (S\@ref(fig:FigPDSIt)), the period of regional WSB quiescence was relatively warm and dry, conditions that may have inhibited outbreak.

## Climate and outbreak dynamics

Our 250 year record shows that WSB outbreaks were more likely to occur during periods of above average moisture availability, consistent with the expectation that greater moisture availability increases forage palatability and availability thereby increasing insect population growth rates [@price1991PlantVigorHypothesis]. Here we document higher SC-PDSI values during years of outbreak, consistent with previous dendroecological research from the Southwest [@swetnam1993; @ryerson2003TreeringReconstructionWestern]. We also show that outbreak initiation tended to co-occur with the start of periods of above average moisture availability, as has been reported in the Pacific Northwest [@flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017]. Additionally, we show that across our study area, regionally synchronous outbreaks were more likely to occur when periods of increased moisture availability were longer and more extreme. These findings highlight the importance of considering cumulative effects of climate variability on ecological systems [@hartmann2018ResearchFrontiersImproving].

Our analyses provide support for the idea that drought proceeds WSB outbreaks. Collectively, regional and site-level superposed epoch analyses suggested a significant relationship existed between outbreak initiation and drought in the preceding one to five years, as has been previously reported in the Pacific Northwest [@flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017]. The variation in the timing of the inciting drought may emerge due to density-dependent processes and/or a lagged effect of defoliation on radial growth, which may occur because trees can use previously stored carbon for growth [@richardson2015DistributionMixingOld]. Indeed, dendroecological studies of ongoing outbreaks show that the effect of defoliation on radial growth often lag defoliation by one to three years [@alfaroTreeMortalityRadial1982; @swetnam1985].

Once outbreaks begin, our results suggest that above average moisture conditions are important for sustaining outbreaks, consistent with Huberty and Denno's [-@huberty2004PlantWaterStress] *pulsed stress hypothesis*. Additional moisture likely allows trees to allocate more carbon to more production of new foliage [@gower1992CarbonDynamicsRocky], which can increase the survival rates of WSB larvae [@nealis2009RiskDispersalWestern]. We also find that outbreak cessation often co-occurred with a transition from above average moisture availability to drought, consistent with previous work from the interior Pacific Northwest [@ellisMulticenturyDendrochronologicalReconstruction2017]. Ellis and Flower [@ellisMulticenturyDendrochronologicalReconstruction2017] concluded that prolonged wet periods rather than the transition to droughts contributed to outbreak cessation. Cool and wet conditions in the spring can decrease overwintering survival and subsequent foraging [@nealis2021EcologyOutbreakPopulations] and prolonged reductions in survival early during the WSB life cycle can contribute to population reductions. However, here we found that the wet periods coincident with outbreak cessation were of average duration. Instead, our data suggests that drought events may facilitate outbreak collapse by decreasing forage production and/or increasing the rates that dormant budworms deplete glycogen reserves, which may cause significant mortality [@nealis2016WhyWesternSpruce; @nealis2021EcologyOutbreakPopulations]. Indeed, Thomson et al. [-@thomson1984RelatingWeatherOutbreaks] reported warm temperatures in the late summer as the primary factors driving the collapse of two outbreaks British Columbia.

While overall we found that both outbreak initiation and cessation co-occurred with drought, not all outbreaks followed this pattern. This variable effect of drought on outbreak dynamics may exist because the drought sensitivity of the WSB-Douglas fir system varies [@harvey2018; @xuDroughtMoistureAvailability2019]. For instance, during the period of regional quiescence from 1910-1980, the sites that experienced local outbreaks were on average more productive than sites that did not (mean 1981-2010 actual evapotranspiration was `r host.sites.climate %>% filter(SeriesCode %in% host.sites.sub$SeriesCode & SeriesCode %in% c("TI", "WB", "B18", "SS", "SR", "WR", "JP")) %>% pull(AET) %>% mean()  %>%round()` and `r host.sites.climate %>% filter(SeriesCode %in% host.sites.sub$SeriesCode & !SeriesCode %in% c("TI", "WB", "B18", "SS", "SR", "WR", "JP")) %>% pull(AET) %>% mean()  %>%round()` mm yr^-1^ for sites with and without outbreak, respectively; Table \@ref(tab:outbreaksummary)). At these less productive sites, the concurrent prolonged drought conditions may have limited the production of palatable forage and thus WSB outbreak. This finding is consistent with Xu et al.'s [-@xuDroughtMoistureAvailability2019] observations of drought positively influencing spatiotemporal patterns of WSB outbreak only at the more productive Douglas-fir forests in the Western US. Future research is necessary to understand how drought may influence WSB outbreak dynamics across gradients of productivity.

Our study is limited by its annual precision and the correlation among seasonal climate variables known to influence different stages of the WSB life cycle [@nealis2021EcologyOutbreakPopulations]. Here we assessed the effect of climate variability on WSB outbreak dynamics using summer SC-PDSI, which is highly correlated with other climate variables that may also influence WSB outbreak dynamics [@nealis2021EcologyOutbreakPopulations]. For instance, in the WSB-Douglas fir system, drought commonly co-occurs with warm spring temperatures, which may positively affect WSB population growth rates by limiting mortality due to freezing or destruction of food supplies [@fellinWesternSpruceBudworm1982; @nealis2021EcologyOutbreakPopulations]. Thus, the positive effect of drought on outbreak initiation identified here may in part reflect the positive effects of warm spring temperatures.

# Implications

This study highlights the role of broad-scale drivers in WSB outbreak dynamics, which has several important implications for understanding the ecology and management of WSB outbreak dynamics. First, forest management practices aimed at mitigating the effects of WSB, must consider regional- and landscape-scale processes. Here we attribute the early to mid 1900s quiescent period in our regional WSB record to a regional reduction in host availability due to Euro-American land-use practices, including logging and widespread anthropogenic fires during the relatively dry second half of the 19th century. From this we suggest that assessment of the likelihood of WSB outbreak and the efficacy of potential mitigation effort to enhance stand resistance to outbreak must consider stand structures across the surrounding landscape. In that context, the potential success of any management objectives should consider the effects of large fires in alternating landscape- to regional-scale forest susceptibility to WSB outbreak. For example, the extensive fires in 2020 in our study area have significantly reduced the extent of Douglas fir-dominated stands susceptible to WSB. Based on our results linking changes in WSB to past land-use practices, the 2020 fires may provide an opportunity to explore their potential benefits as a nature-based solution to adaptation to climate change impacts [@baker2023HarnessingNaturalDisturbances]. Likewise, our results are highly relevant to management discusses framed in terms of emulating natural disturbances to promote heterogeneity at multiple scales [@derose2014ResistanceResilienceConceptual; @windmuller-campione2021LandscapeScaleDriversResistance]. Second, we find that outbreaks were strongly linked to regional climate variability. Consequently future changes in climate, which are forecasted to include increases in the intensity and frequency of drought across the Southwest [@usgcrp2023FifthNationalClimate], are likely to alter spatial and temporal patterns of WSB outbreak. While previous work from the Pacific Northwest has suggested that climate change may increase the likelihood of WSB outbreaks [@flower2014; @ellis2017MulticenturyDendrochronologicalReconstruction], the associaion between outbreak continuation an above-average moisture availabilty that we observed here suggests that future warming and drying may inhibit outbreaks, particularly at more xeric locations. Collectively, this highlights the need for forest managers to plan for uncertainty by adopting adaptive management practices [@millar2016ClimateChangeForests].

# Acknowledgements

This research was supported the USDA National Institute of Food and Agriculture, McIntire-Stennis project COL00520, accession number 7002894. Additionally, we would like to the thank Colorado State University and the Colorado Mountain Club for supporting O. Santiago. For research assistance we thank L. Daniels, K. Farley, M. Gonzalez, S. Shimek, and J. Smith.

# References

::: {#refs}
:::

\pagebreak

# Supplementary Material {#SuppMat}

```{r start landscape}
op_section <- prop_section(type = "continuous")
block_section(op_section) # create section in landscape format
```

```{r hostmeta, tab.id="hostmeta", tab.cap="Chronology statistics for host sites.", tab.lp="supp-tab",tab.cap.pre="Table S"}
host.meta.sub.print <- host.meta.sub[,c("SeriesCode", "SiteName", "Lat", "Lon", "nseries", "FirstYear", "LastYear", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd")]
host.meta.sub.print <- host.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
host.meta.sub.print$"Interseries r" <- paste0(host.meta.sub.print$"Interseries r" , ")")
host.meta.sub.print <- host.meta.sub.print %>% tidyr::unite("Years", FirstYear:LastYear, sep="-")

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
host.meta.sub.print$"Autocorrelation" <- paste0(host.meta.sub.print$"Autocorrelation" , ")")

host.meta.sub.print <- host.meta.sub.print[,c("SeriesCode", "SiteName", "Lat", "Lon", "Years", "nseries", "Interseries r", "Autocorrelation")]

colnames(host.meta.sub.print)<- c("Site ID", "Site Name", "Latitude\n(degrees)", "Longitude\n(degrees)", "Chronology\nlength\n(years)" , "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation")
host.meta.sub.print$Reference <- c("")

ft <- qflextable(host.meta.sub.print) 
ft %>% set_table_properties(layout = "autofit", width=1)

```

\pagebreak

```{r nonhostmeta, tab.id="nonhostmeta", tab.cap="Site and chronology statistics for nonhost sites.", tab.lp="supp-tab",tab.cap.pre="Table S"}
nonhost.meta.sub.print <- nonhost.meta.sub[,c("SeriesCode", "SiteName", "Lat", "Lon", "FirstYear", "LastYear", "nseries", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd")]
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(Lat:Lon), ~round(., 3))
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Years", FirstYear:LastYear, sep="-")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Interseries r" <- paste0(nonhost.meta.sub.print$"Interseries r" , ")")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Autocorrelation" <- paste0(nonhost.meta.sub.print$"Autocorrelation" , ")")

nonhost.meta.sub.print <- nonhost.meta.sub.print[,c("SeriesCode", "SiteName", "Lat", "Lon", "Years", "nseries", "Interseries r", "Autocorrelation")]

colnames(nonhost.meta.sub.print)<- c("Site ID", "Site Name", "Latitude\n(degrees)", "Longitude\n(degrees)", "Chronology\nlength\n(years)" , "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation")

nonhost.meta.sub.print$Reference<- c("Woodhouse and Losleben 2006a", "Woodhouse et al. 2006b", "Woodhouse and Losleben 2006b", "Woodhouse and Losleben 2006c", "Woodhouse et al. 2015", "Woodhouse et al. 2006c", "Woodhouse et al. 2006a", "Woodhouse et al. 2010", "Woodhouse et al. 2019c", "Woodhouse et al. 2019a", "Veblen et al. 2000", "Graybill 2002; Woodhouse et al. 2019b")

ft <- qflextable(nonhost.meta.sub.print) 
ft %>% set_table_properties(layout = "autofit", width=1)
```

```{r end landscape}
close_section <- prop_section(
    page_size = page_size(orient = "landscape"), 
    type = "continuous")
block_section(close_section) # end section in landscape format
```

```{r colonizationtab, tab.id="colonizationtab", tab.cap="Summary of modelling results testing the effect of Euro-Americans on WSB outbreak dynamics and ecological effects.", tab.lp="supp-tab",tab.cap.pre="Table S"}

colnames(colonization.results) <- c("Response", "Coefficient", "p value")
ft <- flextable(colonization.results) 
ft %>% flextable::align(j=-1, align = "center", part = "all") %>% autofit() %>% fit_to_width(7.5) 
```

<br>

```{r PDSIperiodstab,  tab.id="PDSIperiodstab", tab.cap="Results of statistical tests comparing the climate conditions in the dry period prior and wet period coincident outbreak initiation with all periods of above average moisture availability.", tab.lp="supp-tab",tab.cap.pre="Table S"}
outbreak_PDSIperiods <- read.csv(here("Results", "outbreak-PDSIperiods.csv")) %>% dplyr::select(xvar, response, coefficient, p.value) %>% mutate(response=factor(response, levels=c("mean", "extreme", "duration"), labels=c("mean SC-PDSI", "extreme SC-PDSI", "duration (years)"), ordered=T), coefficient = round(coefficient, 2), p.value = round(p.value, 3))

colnames(outbreak_PDSIperiods) <- c("Climate period", "Measure", "Coefficient", "p value")
outbreak_PDSIperiods %>% flextable() %>% autofit() %>% fit_to_width(7)
```

\pagebreak

```{r historytab, tab.id="historytab", tab.cap="Published periods of WSB outbreak in Colorado.", tab.lp="supp-tab",tab.cap.pre="Table S"}

history.tab <- read_excel(here("Documents", "PublishedOutbreakHistory.xlsx"), sheet=1, col_types="text") %>% setorder(cols=Start)

colnames(history.tab) <- c("Start", "End", "Duration\n(years)", "Study area", "Source")

history.tab %>% as.data.frame() %>% flextable() %>% autofit() %>% fit_to_width(7.5) 
```

\pagebreak

```{r FigPercDefol, fig.id="FigPercDefol",fig.cap="Site-level outbreak records expressed as the percent of trees recording an infestation.", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=4.48, fig.height=6.5}
knitr::include_graphics(here("Results", "Figures", "Fig-PercentDefoliated.jpg"))
```

\pagebreak

```{r FigPairwiseCor, fig.id="FigPairwiseCor",fig.cap="Pairwise Spearman's correlation between time series of the percent of trees defoliated at each site.", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=4.48, fig.height=3}
knitr::include_graphics(here("Results", "Figures", "Fig-PairwiseCorrelation.jpg"))
```

<br>

```{r FigCovarianceTime, fig.cap="Nonparametric spatial covariance function describing the covariance among time series of the percent of trees defoliated at site for the 1750-1995 and the centuries prior to and following  extensive Euro-American colonization (1750-1848 and 1890-1989, respectively). Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=7, fig.height=3}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Multi.jpg"))
```

```{r FigCovarianceNonHost, fig.id="FigCovarianceNonHost", fig.cap="Nonparametric spatial covariance function describing the covariance among the 12 drought-sensitive ponderosa pine chronologies used to reconstruct WSB histories. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=3.5, fig.height=2.4}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Nonhost.jpg"))
```

<br>

```{r FigPDSIt, fig.id="FigPDSIt", fig.cap="Boxplots illustrating the mean June-August SC-PDSI during the century prior to and following extensive Euro-American colonization. Letters above bars indicate significant (p<0.05) differences between groups.", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=3.5, fig.height=2}

knitr::include_graphics(here("Results", "Figures", "T-PDSI.jpg"))
```

```{r FigSEASiteInitiation, fig.id="FigSEASiteInitiation", fig.cap="Site-level superposed epoch analyses summarizing the association between summer SC-PDSI and outbreak initiation over the 1750-2023 period. Descending bars illustrate a negative association with summer SC-PDSI (i.e., drier conditions), ascending bars show a positive association with summer SC-PDSI (i.e., wetter conditions).", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=7, fig.height=5, eval=F}

knitr::include_graphics(here("Results", "Figures", "SEA-initation-site.jpg"))

```

```{r FigSEASiteCessation, fig.id="FigSEASiteCessation", fig.cap="Site-level superposed epoch analyses summarizing the association between summer SC-PDSI and outbreak cessation over the 1750-2023 period. Descending bars illustrate a negative association with summer SC-PDSI (i.e., drier conditions), ascending bars show a positive association with summer SC-PDSI (i.e., wetter conditions).", fig.cap.pre="Figure S", fig.lp="supp-fig", fig.width=7, fig.height=5, eval=F}

knitr::include_graphics(here("Results", "Figures", "SEA-cessation-site.jpg"))

```

\pagebreak

@CO591; @CO596; @CO601; @CO602; @CO607; @CO611; @CO622; @CO639; @CO666; @CO669; @woodhouse2019NOAAWDSPaleoclimatologya; @graybill2002NOAAWDSPaleoclimatologyc; @veblen2000; @rodman2020DataChangingClimatea
