---
title: "Title"
author: "Sarah J. Hart, Olivia Santiago, Josh Carrell, and Thomas T. Veblen"
email: "sarah.hart@colostate.edu"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
  bookdown::word_document2:
    reference_docx: JOETemplate.docx
    fig_caption: yes
    number_sections: no
    toc: no
    df_print: kable
editor_options: 
  chunk_output_type: inline
bibliography: references.bib
csl: "`r here:::here('ecology.csl')`"
link-citations: true
urlcolor: blue
linkcolor: blue
citationcolor: blue
---

```{r setup,include=FALSE, results='hide'}
knitr::opts_chunk$set(
	fig.height = 4,
	fig.width = 7,
	out.width= "504pt",
	message = FALSE,
	echo=FALSE,
	warning = FALSE,
	results= "hide",
	dpi = 300,
	progress = FALSE
)

options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*60*10) #timeout downloads that last longer than 10 hours

### Import libraries
if (!require("remotes"))  install.packages("remotes")

if (!require("climateR")) remotes::install_github("mikejohnson51/climateR")

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, # modeling 
  ggplot2, # figures
  patchwork, # combining figures
  ggsci, # color palettes
  dplR, # basic dendrochronology
  dfoliatR, # dendroecology 
  zoo, # time series
  factoextra, # multivariate analyses
  forcats, # categorical data
  GGally, # easy data exploration
  colorspace, # color palettes
  RColorBrewer, # color palettes
  knitr, # markdown documents
  kableExtra, # tables in markdown
  flextable, # other table options
  bookdown, # figure numbering in markdown
  sf, # spatial data (new pkg)
  terra, # raster data (new pkg)
  raster, # raster data (old pkg)
  ncdf4, #import ncdf files
  tmap, # easy plotting of maps
  ncf, # spatial covariance
  RCurl, # downloading data via curl
  MASS, # mixed effect modelling
  nlme, # mixed effect modelling
  climateR, 
  synchrony,
  remotes,
  readxl, # read excel files
  terrainr # dem
) 



# Set plotting options
options(scipen=999)
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())

fig.width1 <- 3.4
fig.width2 <- 7
fig.width1.5 <- 4.48

pt.width1 <-fig.width1 * 72
pt.width2 <-fig.width2 * 72
pt.width1.5 <- fig.width1.5 * 72

sf_use_s2(FALSE)
```

# Abstract

# Introduction

Global change, including changes in climate, population density, and land-use, is altering ecosystems around the world [@weiskopf2020ClimateChangeEffects]. In forested ecosystems of western North America, global change is altering plant-insect interactions, leading to changes in in ecosystem structure, composition, and function [@bale2002]. Such changes may be particularly dramatic when insect herbivores increase consumption in response to elevated temperatures, CO~2~ concentrations, drought stress, and/or nutrient conditions [@hamann2021ClimateChangeAlters]. Predicting the effects of global change on the structure, composition, and function of forest ecosystems requires a better understanding of the effects of global change on interactions between plants and insects.

The western spruce budworm (WSB; *Choristoneura occidentalis*) is one of the most widely distributed native defoliators of coniferous forests in North America, where it plays an important role in shaping ecosystem function [@johnson1975OutbreaksWesternSpruce; @brookes1987WesternSpruceBudworm]. WSBs are specialist herbivores that preferentially feed upon young buds and new foliage of their host tree, which include Douglas-fir (*Pseudotsuga menziesii*), true firs (*Abies* spp.) and spruce (*Picea spp.*). Typically, WSBs exist at low population levels and defoliation is minimal [@brookes1987WesternSpruceBudworm]. However, periodically WBS populations may experience irruptions leading to severe defoliation. These outbreaks occur when several thresholds are crossed and negative feedbacks among the WSB populations, host trees, and natural enemies no longer constrain WSB population dynamics. During outbreaks, affected trees may experience severe reductions in growth and seed production or even death [@alfaroTreeMortalityRadial1982], leading to changes in carbon cycling [@dymond2010FutureSpruceBudworm], reductions in timber volume [@alfaro1992], and changes to subsequent disturbance dynamics [@cole2022OutbreaksDouglasfirBeetle]. Importantly, outbreaks often occur synchronously across broad spatial extents [i.e, 1000s of kilometers; @flower2016], leading to considerable fluctuation in the provisioning of ecosystem services at a subcontinental scale [@wilcox2017AsynchronyLocalCommunities; @patrick2021MultiscaleBiodiversityDrives].

Disjunct populations may fluctuate synchronously due to density-dependent processes, including dispersal, parasitoidism, disease, and predation. For example, analyses of the spatial patterning of a recent (ca. 1996-2011) WSB outbreak in interior southern British Columbia revealed that 90% of patches newly infested by WSB were within 5 km of an existing patch, consistent with the expectation that adult moth dispersal drives spatiotemporal patterns of outbreak [@senf2017MultiscaleAnalysisWestern]. While dispersal may explain spatiotemporal synchrony at fine scales, WSB populations fluctuate synchronously across western North America [@flower2016]. At least part of this pattern has been attributed to Moran effects, where spatial autocorrelation in exogenous drivers leads to synchronicity [@moran1953StatisticalAnalsisCanadian]. For the WSB, Moran effects may occur if climate affects WSB population rates by altering insect survival or fecundity [@brookes1987WesternSpruceBudworm; @swetnam1993] and/or if regionally-synchronized stand development affects forage quantity and quality [@brookes1987WesternSpruceBudworm; @hadleyStandResponseWestern1993; @swetnam1993].

Outbreaks of WSB are most likely to occur in multistoried stands with abundant hosts, particularly when the surrounding landscape is also characterized by abundant hosts [@brookes1987WesternSpruceBudworm; @senf2017MultiscaleAnalysisWestern]. At the stand and landscape scale, patterns of host abundance and size reflect past disturbances and land-use history [@hadleyStandResponseWestern1993; @maclauchlan2009InfluenceForestryPractices]. Notably, the forcible displacement of native peoples by Euro-American settlers and the ensuing changes in land management practices altered forest composition, structure, and disturbance regimes across much of the Western US [@covington2018HistoricalAnticipatedChanges]. Early Euro-American settlers often heavily logged forests near settlements and ignited fires, which often burned extensive areas [@veblen1991ColoradoFrontRange]. Both logging practices that emphasize the selective harvesting of large trees and severe wildfires can result reduce host abundance and quality, thereby limiting the susceptibility of stands to outbreaks in the near-term [@hadleyStandResponseWestern1993; @swetnam1993]. While initially logged and burned stands may be less susceptible to WSB outbreaks, after several decades stands may again become susceptible to WSB outbreaks as trees regenerate and grow [@hadleyStandResponseWestern1993; @swetnam1993]. Additionally in many forests characterized by a low-severity, frequent fire regime prior to Euro-American settlement, Euro-American fire suppression policies initiated in the early 1900s and livestock grazing resulted in denser stands composed of more shade-tolerant species, including Douglas-fir, [@covingtonSouthwesternPonderosaForest1994; @veblen2000; @hessburgEnvironmentalNarrativeInland2003]. Collectively these changes have been hypothesized to make stands more susceptible to WSB outbreaks and lead to increases in the severity and synchronicity of WSB outbreaks [@swetnam1989]. However evidence for this effect appears to vary regionally, with some studies finding changes in outbreak characteristics following Euro-American settlement in the late 1800s [@swetnam1993; @hadleyStandResponseWestern1993; @flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017], while others have not [@ryersonTreeringReconstructionWestern2003; @alfaroPeriodicityWesternSpruce2014].

Given susceptible stand conditions, interannual variability in drought severity may synchronize the dynamics of disjunct populations of folivorous insects in several ways [@gely2020HowHerbivorousInsects]. First, droughts may negatively affect population growth rates by decreasing digestibility and forage availability [i.e., *plant vigor hypothesis*; @price1991PlantVigorHypothesis]. For instance, droughts often cause decreases in leaf water content and increases leaf toughness and concentrations of defense compounds [REF], thereby decreasing digestibility. In addition, droughts may decrease forage availability by reducing conifer needle production and elongation [e.g., @adams2015ExperimentalDroughtHeat]. While droughts may decrease forage digestibility and availability, they may also lead to higher leaf nitrogen content, which may increase the growth rates [i.e., *plant stress hypothesis*; @whiteAbundanceInvertebrateHerbivores1984]. Additionally, droughts commonly co-occur with warm temperatures, which may decrease insect mortality that occurs due to freezing or destruction of food supplies [@fellinWesternSpruceBudworm1982; @regniereInfluenceTemperatureHistoric2019].

For the WSB-Douglas fir system, outbreak occurrence has been linked with both periods of drought and periods of above average moisture availability [@swetnam1993; @flower2014]. This apparent contradiction may arise for several reasons. First, trees may respond nonlinearly to drought. For instance, carbon allocation to defenses is expected to be greatest at moderate levels of drought when fewer carbohydrates are used for growth and thus more resources available for the production of defense compounds [REF]. Second, temporal attributes of drought may be important. Recent research suggests that drought-driven increases in forage quality may be important in triggering outbreak initiation, but above average moisture availability is necessary for sustaining high population levels [@flower2014]. Third, the effects of drought may vary with site aridity [@harvey2018; @xuDroughtMoistureAvailability2019], if populations of Douglas fir from drier locations are better adapted to dealing with drought [@bansal2015ClimaterelatedGeneticVariation].

The aim of this paper is to use tree-ring methods to determine the history of WSB outbreaks from ca. 1700 to 2020 across central to northern Colorado. We use this data to quantify: (1) temporal synchrony in outbreak history, (2) the effects of Euro-American settlement on the dynamics of WSB outbreaks, and (3) the association between climate and outbreak initiation and cessation. Additionally we assess the stability of climate-outbreak relationships in the century prior to and following extensive Euro-American settlement and across a gradient of site aridity.

# Materials and Methods

## Study area

The study area is the montane zone (ca. 1500-3300 m) of central to northern Colorado (ca. 38.3° N to 40.8° latitude), where Douglas fir is commonly found (Fig. \@ref(fig:FigStudyArea)). Across the study area, we reconstructed periods of WSB outbreak from 12 sites that span a climatic water deficit gradient (ca. 270 - 660 mm/year; Fig. \@ref(fig:FigStudyAreaCWD)).

The study area typically experiences warm summers (1991-2020 mean July daily maximum temperature: 25.2 °C), cold winters (1991-2020 mean January daily minimum temperature: -10.3 °C), and moderate amounts of precipitation (1991-2020 mean total annual precipitation: 527 mm) [@prismclimategroup2021]. At local scales, the climate is driven by elevation gradients, the prevailing westerly winds, and the north-south orientation of the mountains. Temperatures are warmer at lower elevations, while more precipitation falls at higher elevations, particularly on the windward side of the Rockies [@lukas2014ClimateChangeColorado]. Summer precipitation patterns exhibit a distinct latitudinal gradient, where more southern locations often receive more precipitation due to the North American Monsoon system [@lukas2014ClimateChangeColorado].

Montane forests across the region are dominated by ponderosa pine (*Pinus ponderosa*) and Douglas fir (*Pseudotsuga menziesii)*, with lesser components of aspen (*Populus tremuloides*), lodgepole pine (*Pinus contorta*), and limber pine (*Pinus flexilis*) [@veblen2005]. Prior to Euro-American colonization, lower montane forests across the study area were characterized by frequent, low-severity fire, while higher elevation montane forests were characterized by a more variable fire regime [@sherriff2007SpatiallyExplicitReconstructionHistorical].

```{r DL_SpatialData}
dir.create(here("Data", "Spatial"), showWarnings = FALSE)

# states
dir.create(here("Data", "Spatial", "States"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "States", "cb_2018_us_state_20m.zip")
if(!file.exists(temp)){
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_state_20m.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "States"))
}

# Colorado cities
dir.create(here("Data", "Spatial", "Cities"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Cities", "Colorado_City_Point_Locations.zip")
if(!file.exists(temp)){
  download.file("https://opendata.arcgis.com/api/v3/datasets/b20b5c04576145be9428b4b4f28490c2_0/downloads/data?format=shp&spatialRefId=4269&where=1%3D1", temp)
  unzip(temp, exdir=here("Data", "Spatial", "Cities"))
}

# Distribution of Douglas fir from Little 
dir.create(here("Data", "Spatial", "DouglasFirDistribution"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "DouglasFirDistribution", "pseumenz.zip")
if(!file.exists(temp)){
  download.file("https://web.archive.org/web/20170127093428/https://gec.cr.usgs.gov/data/little/pseumenz.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "DouglasFirDistribution"))
}

# MTBS 
dir.create(here("Data", "Spatial", "MTBS"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "MTBS", "mtbs_perimeter_data.zip")
if(!file.exists(temp)){
  download.file("https://edcintl.cr.usgs.gov/downloads/sciweb1/shared/MTBS_Fire/data/composite_data/burned_area_extent_shapefile/mtbs_perimeter_data.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "MTBS"))
}

# ADS
dir.create(here("Data","Spatial", "ADS"), showWarnings = FALSE)
temp <- here("Data","Spatial", "ADS", "CONUS_Region2_AllYears.gdb.zip")
if(!file.exists(temp)){
  download.file("https://usfs-public.box.com/s/0de5v3d6x9butl0etcc6iya9n8fpsk2q", temp)
  unzip(temp, exdir=here("Data","Spatial", "ADS"))
}

#EcoRegions
dir.create(here("Data","Spatial", "EcoRegions"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "EcoRegions","us_eco_l3.zip")
if(!file.exists(temp)){
  download.file("https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l3.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "EcoRegions"))
}

```

```{r DL_NADA}
if(!file.exists(here("Data", "Spatial", "NADA"))){
  dir.create(here("Data", "Spatial", "NADA"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "NADA", "nada_hd2_cl.nc")
  download.file("https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/nada_hd2_cl.nc", temp)
}

if(!file.exists(here("Data", "Spatial", "NADA", "NADA_Reconstructed_JJA_PDSI_1650_2005.txt"))){
  temp <-  here("Data", "Spatial", "NADA", "NADA_Reconstructed_JJA_PDSI_1650_2005.txt")
  download.file("https://drive.google.com/uc?export=download&id=1I8HqwR3TApy6lxfULRqZ1w__D6YVBvx4", temp)
}

```

```{r DL_PRISM}
if(!dir.exists(here("Data", "Spatial", "PRISM"))){
  dir.create(here("Data", "Spatial", "PRISM"), showWarnings = FALSE)
  temp <- here("Data", "Spatial", "PRISM", "scpdsi_6_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_6_PRISM.nc", temp)

  temp <- here("Data", "Spatial", "PRISM", "scpdsi_7_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_7_PRISM.nc", temp)

  temp <- here("Data", "Spatial", "PRISM", "scpdsi_8_PRISM.nc")
  download.file("http://www.wrcc.dri.edu/wwdt/data/PRISM/scpdsi/scpdsi_8_PRISM.nc", temp)
  
  temp <- here("Data", "Spatial", "PRISM", "PRISM_ppt_30yr_normal_800mM4_annual_asc.zip")
  download.file("https://ftp.prism.oregonstate.edu/normals_800m/ppt/PRISM_ppt_30yr_normal_800mM4_annual_asc.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "PRISM"))
  
  temp <- here("Data", "Spatial", "PRISM", "PRISM_tmax_30yr_normal_800mM4_07_asc.zip")
  download.file("https://ftp.prism.oregonstate.edu/normals_800m/tmax/PRISM_tmax_30yr_normal_800mM4_07_asc.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "PRISM"))
  
  temp <- here("Data", "Spatial", "PRISM", "PRISM_tmin_30yr_normal_800mM4_01_asc.zip")
  download.file("https://ftp.prism.oregonstate.edu/normals_800m/tmin/PRISM_tmin_30yr_normal_800mM4_01_asc.zip", temp)
  unzip(temp, exdir=here("Data", "Spatial", "PRISM"))
}
```

```{r DL_DEM}

# Southern Rockies
  srm <- st_read(here("Data", "Spatial", "EcoRegions", "us_eco_l3", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs=5071) %>% st_buffer(20000)
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)

 # 250 m 
  dem <- get_tiles(data=srm, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- lapply(dem$elevation,FUN=rast)
  writeRaster(dem.rast[[1]], here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
```

```{r Import_SpatialData}
#Project projection
#proj.proj <- 32613
proj.proj <- 4629

states <- st_read(here("Data", "Spatial", "States", "cb_2018_us_state_20m.shp")) %>% st_transform(proj.proj)
cities <- st_read(here("Data", "Spatial", "Cities", "Colorado_City_Point_Locations.shp")) %>% st_transform(proj.proj)
FR <- cities %>% filter(NAME%in%c("DENVER", "COLORADO SPRINGS", "BOULDER", "ESTES PARK"))

#Denver
denver <- cities %>% filter(NAME=="DENVER")

douglasfir <- st_read(here("Data", "Spatial", "DouglasFirDistribution", "pseumenz.shp"))
st_crs(douglasfir) <- 4267 # set to NAD 27 
douglasfir <- douglasfir %>% st_transform(proj.proj) %>% filter(CODE==1)
```

```{r Import_TreeRingSiteData}
host.meta <- read.csv(here("Data", "TreeRing", "Processed", "host-keymeta.csv"))


nonhost.meta <- read.csv(here("Data", "TreeRing", "Processed", "nonhost-keymeta.csv"))
hostxnonhost <-read.csv(here("Results/hostXnonhost-subset.csv"))
host.meta.sub <- host.meta %>% filter(SeriesCode %in% hostxnonhost$host)
host.meta.sub$SeriesCode <- factor(host.meta.sub$SeriesCode, level=c("TI", "SP", "NI", "LJ", "WB", "B19", "B18", "SS", "WW", "SR", "WR","JP"), ordered = T)
#host.meta.sub <- host.meta.sub[!host.meta.sub$SeriesCode=="TI",]


select.nonhost.sites <- unique(c(hostxnonhost$nonhost1,hostxnonhost$nonhost2,hostxnonhost$nonhost3))
nonhost.meta.sub <- nonhost.meta[nonhost.meta$SeriesCode %in% select.nonhost.sites, ]

nonhost.sites <- st_as_sf(x = nonhost.meta.sub, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)
st_write(nonhost.sites, here("Data", "TreeRing", "Processed", "nonhost-keymeta.shp"), append=FALSE)

host.sites.sub <- st_as_sf(x = host.meta.sub, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)
st_write(host.sites.sub, here("Data", "TreeRing", "Processed", "host-sub-keymeta.shp"), append=FALSE)
host.sites <- st_as_sf(x = host.meta, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(proj.proj)
st_write(host.sites, here("Data", "TreeRing", "Processed", "host-keymeta.shp"), append=FALSE)

```

```{r CharacterizeClimate}
if(!file.exists(here("Results", "climate-norms-studyarea.csv"))){
  df.rast <- rast(here("Data", "Spatial", "NIDRM","f202"))

  # Southern Rockies
  srm <- st_read(here("Data", "Spatial", "EcoRegions", "us_eco_l3", "us_eco_l3.shp")) %>% filter(US_L3NAME=="Southern Rockies") %>% st_transform(crs=st_crs(df.rast)) %>% vect()
  
  df.rast <- crop(df.rast, srm)
  ext <- host.sites.sub %>% st_transform(st_crs(df.rast)) %>% ext() %>% vect() %>% buffer(10000)
  df.rast <- crop(df.rast,ext)
  
  df.rast <- mask(df.rast, srm)
  df.rast[df.rast<10] <- NA
  df.rast[df.rast>=10] <- 1
  
  df.poly <- as.polygons(df.rast, aggregate=TRUE, values=TRUE, na.rm=TRUE) 
  
  ppt.normal <- rast(here("Data", "Spatial", "PRISM", "PRISM_ppt_30yr_normal_800mM4_annual_asc.asc"))
  tmin1.normal <- rast(here("Data", "Spatial", "PRISM", "PRISM_tmin_30yr_normal_800mM4_01_asc.asc"))
  tmax7.normal <- rast(here("Data", "Spatial", "PRISM", "PRISM_tmax_30yr_normal_800mM4_07_asc.asc"))
  dem <- rast(here( here("Data", "Spatial", "DEM", "DEM250.tif")))
  
  df.poly <- df.poly %>% project(ppt.normal)
  climate.normals <- data.frame(metric=c("mean", "min", "max"))
  
  climate.normals$PPT <- NA
  climate.normals[climate.normals$metric=="mean", ]$PPT <- terra::zonal(z=df.poly, x=ppt.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$PPT <- terra::zonal(z=df.poly, x=ppt.normal, fun=min)[1,1]
  climate.normals[climate.normals$metric=="max", ]$PPT <- terra::zonal(z=df.poly, x=ppt.normal, fun=max)[1,1]
  
  climate.normals$TMIN <- NA
  climate.normals[climate.normals$metric=="mean", ]$TMIN <- terra::zonal(z=df.poly, x=tmin1.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$TMIN <- terra::zonal(z=df.poly, x=tmin1.normal, fun=min)[1,1]
  climate.normals[climate.normals$metric=="max", ]$TMIN <- terra::zonal(z=df.poly, x=tmin1.normal, fun=max)[1,1]
  
  climate.normals$TMAX <- NA
  climate.normals[climate.normals$metric=="mean", ]$TMAX <- terra::zonal(z=df.poly, x=tmax7.normal, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$TMAX <- terra::zonal(z=df.poly, x=tmax7.normal, fun=min)[1,1]
  climate.normals[climate.normals$metric=="max", ]$TMAX <- terra::zonal(z=df.poly, x=tmax7.normal, fun=max)[1,1]
  
  df.poly <- df.poly %>% project(dem)
  climate.normals$Elev <- NA
  climate.normals[climate.normals$metric=="mean", ]$Elev <- terra::zonal(z=df.poly, x=dem, fun=mean)[1,1]
  climate.normals[climate.normals$metric=="min", ]$Elev <- terra::zonal(z=df.poly, x=dem, fun=min)[1,1]
  climate.normals[climate.normals$metric=="max", ]$Elev <- terra::zonal(z=df.poly, x=dem, fun=max)[1,1]

  write.csv(climate.normals, file=here("Results", "climate-norms-studyarea.csv"), row.names = F)
}

cwd <- rast(here("Data", "Spatial", "AETCWD", "TraitBasedApproach_Rodman", "AET and CWD", "CWD_1981-2010.tif"))
aet <- rast(here("Data", "Spatial", "AETCWD", "TraitBasedApproach_Rodman", "AET and CWD", "AET_1981-2010.tif"))
host.sites.sub.buffer <-host.sites.sub %>% st_transform(st_crs(cwd)) %>%  st_buffer( dist=500)
cwd.hosts.sub <- terra::extract(cwd, host.sites.sub.buffer, fun=mean)
aet.hosts.sub <- terra::extract(aet, host.sites.sub.buffer, fun=mean)

host.sites.sub$CWD <- cwd.hosts.sub$`CWD_1981-2010`
host.sites.sub$AET <- aet.hosts.sub$`AET_1981-2010`
```

```{r FigStudyArea, fig.cap="The study area and WSB reconstruction sample sites. The green polygon illustrates the distribution of Douglas fir and the thick black line shows the position of the Continental Divide. The study area's location relative to the contiguous western United States is shown in the inset map.", out.width = "244.8pt", results='show'}
if(!file.exists(here("Results", "Figures", "FigStudyArea.jpg"))){
  x <- tmaptools::bb(nonhost.sites)
  x[1] <- -107; x[2] <- 38.1; x[3] <- -104; x[4] <- 41.25

 df.rast <- rast(here("Data", "Spatial", "NIDRM","f202"))

  # Southern Rockies
  srm <- st_read(here("Data", "Spatial", "EcoRegions", "us_eco_l3", "us_eco_l3.shp"), quiet=T) %>% filter(US_L3NAME=="Southern Rockies") %>% st_transform(crs=st_crs(df.rast)) %>% vect()
  
  df.rast <- crop(df.rast, srm)
  df.rast[df.rast<10] <- NA
  df.rast[df.rast>=10] <- 1

  df.poly <- as.polygons(df.rast, aggregate=TRUE, values=TRUE, na.rm=TRUE) 
 
  writeVector(df.poly, here("Data", "Spatial", "NIDRM","f202.shp"), overwrite=T)
  

  douglasfir <- vect(here("Data", "Spatial", "NIDRM","f202.shp")) %>% project(nonhost.sites) %>% st_as_sf()

  studyarea <- tm_shape(douglasfir, bbox=x) +  tm_fill(col=grey(level=0.85)) + tm_shape(nonhost.sites) +tm_symbols(size=0.25, shape=21,col="darkgray", alpha=1) + tm_shape(host.sites.sub) +tm_symbols(size=0.25, shape=17, col="CWD", breaks=round(quantile(host.sites.sub$CWD, probs=seq(0,1,by=.25))), palette = c("#018571","#80cdc1",  "#dfc27d", "#a6611a" )) + tm_shape(denver) +tm_symbols(shape=8, size=0.5, col="black") + tm_text("NAME", just=c(-0.25,0), size=0.7, remove.overlap=T) +  tm_scale_bar(position = c(0.05,0.005), text.size=0.75, just="left", breaks=c(0,50,100), bg.color="white", bg.alpha = 0.8)+tm_compass(position=c(0.1, 0.875), just=c("center", "bottom"), text.size=0.75, size=2, type="4star")+tm_legend(bg.color="white",frame=T, legend.position=c(0.725,0.795))
  
  dir.create(here("Results", "Figures", ""), showWarnings = F)
  Fig.file <- here("Results", "Figures", "FigStudyArea.jpg")
  jpeg(Fig.file, width=fig.width1, height=4.5, units="in", res=300)
  studyarea
  whatever <- dev.off()

}
knitr::include_graphics(here("Results", "Figures", "Fig1.jpg"))
```

## Data

### Dendroecological data

Ring-width data for reconstructing periods of WSB outbreak were collected from Douglas fir in the 1990s, but unpublished (Table \@ref(tab:hostmeta)). Sample sites were selected based on the availability large, old Douglas fir and the absence of evidence of recent fire or logging to minimize the potential effects of other disturbances on radial growth. At each site, tree-ring data were collected by preferentially sampling at least 20 large Douglas fir using an increment borer. Cores were transferred back to the University of Colorado Biogeography Lab, where they were dried, mounted, and sanded to a fine polish, following standard dendrochronological methods [@stokes1996]. Ring-widths were then measured to a 0.01 mm precision using a Velmex unSlide digital encoded traversing table paired with a standard light microscope. To ensure accurate dating, ring-width series were visually cross-dated using the maker year approach [@yamaguchi1991]. Cross-dating was then verified statistically using the *dplR* package [@bunn2019] in R [@rcoreteam2022].

```{r hostRWLS}
host.rwls <- list.files(here("Data", "TreeRing", "Processed", "Host"), pattern=".rwl", full.names=T)
names(host.rwls) <-  c("B18", "B19", "EP", "FP", "JP", "LJ", "NI", "SH", "SR", "SS", "SP", "TI", "WR", "WW", "WB")

host.rwls <- lapply(host.rwls, read.tucson)
```

```{r nonhostRWLS}
nonhost.rwls <- list.files(here("Data", "TreeRing", "Processed", "NonHost"), full.names = T, pattern=".rwl")[-1:-2]
nonhost.rwls <- lapply(nonhost.rwls, read.rwl)
names(nonhost.rwls) <- c("CO037", "CO040", "CO526", "CO527", "CO528", "CO529", "CO530", "CO531",  "CO534", "CO538", "CO542", "CO544", "CO551", "CO555", "CO557", "CO558", "CO559", "CO560", "CO564", "CO565", "CO568", "CO569", "CO570", "CO588", "CO590", "CO591", "CO594", "CO596",  "CO601","CO607", "CO611", "CO622",  "CO627", "CO639",  "CO654", "CO659",  "CO666", "CO669", "DMC", "DRC", "ECC", "JCC", "KC", "TCC", "VBC")
```

### Geospatial disturbance data

To characterize recent history of WSB outbreaks across the study area, we acquired ADS data from the USFS [@usfsanditspartners2020USDAForestService]. ADS data are collected annually via aerial sketch mapping by trained experts who record the disturbance agent, host species, and estimated outbreak severity across broad landscapes. Additionally, given young post-fire stands are not expected to be susceptible to WSB, we acquired data describing wildfire extent for the 1984-2022 period from the Monitoring Trends in Burn Severity Project [-@mtbsprojectMTBSDataAccess2022].

### Climate data

To characterize site aridity, we obtained a 250 x 250 m grid of the 1981-2010 normals of the annual climatic water deficit (CWD) for the study area from Rodman et al. [-@rodman2020DataChangingClimatea]. CWD quantifies the evaporative demand that exceeds available soil moisture and indicates the extent of moisture limitation experienced by plants [@stephenson1990ClimaticControlVegetation]. We overlaid the site locations with this dataset to assign CWD normals to each site.

To characterize temporal variation in drought severity, we obtained multi-century records of the self-calibrating Palmer Drought Severity Index (SC-PDSI; @wellsSelfCalibratingPalmerDrought2004, @palmer1965) from the North American Drought Atlas (NADA), which provides tree-ring based reconstructions of June-August SC-PDSI on a 0.5° resolution grid [@cook2010]. Because the NADA reconstruction extends only to 2005, we also obtained gridded June-August SC-PDSI data from the West Wide Drought Tracker [@abatzoglouWestWideDrought2017]. This dataset is based on PRISM climate data [@prismclimategroup2021], which characterizes monthly precipitation and temperature, among other variables, at a 4 km resolution for the time period 1895-present. PRISM datasets are constructed using data from weather stations and a digital elevation model to adjust for the complex effects of topography on weather and climate [@dalyKnowledgebasedApproachStatistical2002].

For each site, we created time series of 1650-2005 SC-PDSI using the Northern American Drought Atlas product and 1981-2022 SC-PDSI values using the PRISM-based product by extracting the values for the cell the site fell within. We extended the SC-PDSI time series from the PRISM-based dataset back to 1700 using the following procedure. First, we scaled the mean and standard deviation of the NADA reconstruction to the mean of the detrended PRISM-based dataset, where the detrended values are the residuals from a linear regression of SC-PDSI vs. time during the common period between the two datasets (i.e, 1981-2005). We then spliced the two datasets, using the PRISM-based dataset to represent PDSI values from 1981-2022 and the adjusted NADA dataset to represent values from 1650-1980 [@schoennagelMultidecadalClimateVariability2007].

```{r import_NADA}
if(!file.exists(here("Data", "nada-hosts.csv"))){
  nc_data <- nc_open(here("Data", "Spatial", "NADA", "nada_hd2_cl.nc"))
  lon <- ncvar_get(nc_data, "lon")
  lat <- ncvar_get(nc_data, "lat")
  t <- ncvar_get(nc_data, "time")
  fillvalue <- ncatt_get(nc_data, "pdsi", "_FillValue")
  
  nada.array <- ncvar_get(nc_data, "pdsi")
  nc_close(nc_data)
  nada.array[nada.array== fillvalue ] <- NA
  
  nada <-raster(nada.array[1651,,], xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat), crs=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
  nada <- flip(nada, direction="y")
  years <- 1652:length(t)
  for(j in years){
    r <- raster(nada.array[j,,], xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat), crs=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0"))
    r <- flip(r, direction="y")
    nada <- stack(nada, r)
    r <- NULL
  }
  
  nada.hosts <- t(terra::extract(nada, host.sites)) %>% as.data.frame()
  colnames(nada.hosts) <- host.sites$SeriesCode
  row.names(nada.hosts) <- 1650:(max(years)-1)
  nada.hosts$regional <- nada2$PDSI
  nada.hosts %>% write.csv(here("Data", "nada-hosts.csv"),row.names=T)
}
nada.hosts <- read.csv(here("Data", "nada-hosts.csv"))
```

```{r import_PRISM}
if(!file.exists(here("Data", "prism-JJA.csv"))){
  prism6_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_6_PRISM.nc"))
  prism7_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_7_PRISM.nc"))
  prism8_data <- rast(here("Data", "Spatial", "PRISM", "scpdsi_8_PRISM.nc"))
  
  prism6.hosts <- t(terra::extract(prism6_data, host.sites)[,-1 ])
  colnames(prism6.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism6.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism6.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism6.hosts) <- startx:endx
  
  prism7.hosts <- t(terra::extract(prism7_data, host.sites)[,-1])
  colnames(prism7.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism7.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism7.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism7.hosts) <- startx:endx
  
  prism8.hosts <- t(terra::extract(prism8_data, host.sites)[,-1])
  colnames(prism8.hosts) <- host.sites$SeriesCode
  startx <- row.names(prism8.hosts) %>% head(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  endx <- row.names(prism8.hosts) %>% tail(1) %>% strsplit(split="data_day=") %>% `[[`(1)  %>% '['(2) %>% as.numeric() %>% as.Date(origin="1900-01-01") %>% format(format="%Y")
  row.names(prism8.hosts) <- startx:endx
  prism8.hosts <- prism8.hosts[-nrow(prism8.hosts),]
   

    prism.tmean.hist <- list.files(here("Data", "Spatial", "PRISM","PRISM_tmean_stable_4kmM3_189501_198012_bil"), pattern=".bil$", full.names=T) %>% rast()
  prism.tmean.recent <- list.files(here("Data", "Spatial", "PRISM","PRISM_tmean_stable_4kmM3_198101_202304_bil"), pattern=".bil$", full.names=T) %>% rast()

  prism.tmean.hist <- t(terra::extract(prism.tmean.hist, host.sites)[,-1 ])
  colnames(prism.tmean.hist) <- host.sites$SeriesCode
  
  prism.tmean.recent <- t(terra::extract(prism.tmean.recent, host.sites)[,-1 ])
  colnames(prism.tmean.recent) <- host.sites$SeriesCode
  
  prism.tmean <- rbind(prism.tmean.hist,prism.tmean.recent) %>% as.data.frame()
  prism.tmean$time <- do.call(c,lapply(strsplit(row.names(prism.tmean), split="_"), "[", 5)) 
  prism.tmean$year <- substr(prism.tmean$time, start=1, stop=4)
  prism.tmean$month <- substr(prism.tmean$time, start=5, stop=6)
  prism.tmean %>% write.csv(here("Data", "prism-tmean.csv"),row.names=F)
  
  
   prism.ppt.hist <- list.files(here("Data", "Spatial", "PRISM","PRISM_ppt_stable_4kmM2_189501_198012_bil"), pattern=".bil$", full.names=T) %>% rast()
  prism.ppt.recent <- list.files(here("Data", "Spatial", "PRISM","PRISM_ppt_stable_4kmM3_198101_202304_bil"), pattern=".bil$", full.names=T) %>% rast()

  prism.ppt.hist <- t(terra::extract(prism.ppt.hist, host.sites)[,-1 ])
  colnames(prism.ppt.hist) <- host.sites$SeriesCode
  
  prism.ppt.recent <- t(terra::extract(prism.ppt.recent, host.sites)[,-1 ])
  colnames(prism.ppt.recent) <- host.sites$SeriesCode
  
  prism.ppt <- rbind(prism.ppt.hist,prism.ppt.recent) %>% as.data.frame()
  prism.ppt$time <- do.call(c,lapply(strsplit(row.names(prism.ppt), split="_"), "[", 5)) 
  prism.ppt$year <- substr(prism.ppt$time, start=1, stop=4)
  prism.ppt$month <- substr(prism.ppt$time, start=5, stop=6)
  prism.ppt %>% write.csv(here("Data", "prism-ppt.csv"),row.names=F)
  
  
  prism.vpdmax.hist <- list.files(here("Data", "Spatial", "PRISM","PRISM_vpdmax_stable_4kmM3_189501_198012_bil"), pattern=".bil$", full.names=T) %>% rast()
  prism.vpdmax.recent <- list.files(here("Data", "Spatial", "PRISM","PRISM_vpdmax_stable_4kmM3_198101_202304_bil"), pattern=".bil$", full.names=T) %>% rast()

  prism.vpdmax.hist <- t(terra::extract(prism.vpdmax.hist, host.sites)[,-1 ])
  colnames(prism.vpdmax.hist) <- host.sites$SeriesCode
  
  prism.vpdmax.recent <- t(terra::extract(prism.vpdmax.recent, host.sites)[,-1 ])
  colnames(prism.vpdmax.recent) <- host.sites$SeriesCode
  
  prism.vpdmax <- rbind(prism.vpdmax.hist,prism.vpdmax.recent) %>% as.data.frame()
  prism.vpdmax$time <- do.call(c,lapply(strsplit(row.names(prism.vpdmax), split="_"), "[", 5)) 
  prism.vpdmax$year <- substr(prism.vpdmax$time, start=1, stop=4)
  prism.vpdmax$month <- substr(prism.vpdmax$time, start=5, stop=6)
  prism.vpdmax %>% write.csv(here("Data", "prism-vpdmax.csv"),row.names=F)
  
}
prism.JJA <- read.csv(here("Data", "prism-JJA.csv"))
prism.tmean <- read.csv(here("Data", "prism-tmean.csv"))
prism.ppt <- read.csv(here("Data", "prism-ppt.csv"))
prism.vpdmax <- read.csv(here("Data", "prism-vpdmax.csv"))


```

```{r join_NADAxPRISM}
pdsi.out <-data.frame(matrix(nrow=length(1650:2022), ncol=length(host.sites$SeriesCode)+1))
colnames(pdsi.out) <- c("year",host.sites$SeriesCode)
pdsi.out$year <- 1650:2022
for(j in host.sites$SeriesCode){
  prismj <- ts(prism.JJA[,j],start=min(prism.JJA$X))
  nadaj <- ts(nada.hosts[,j],start=min(nada.hosts$X))
  pdsi.combo <- cbind(prismj, nadaj)
  yearz <- time(pdsi.combo)
  pdsi.combo <- pdsi.combo %>% as.data.frame()
  pdsi.combo$year <- yearz
  lmx <- lm(prismj~year, data=na.omit(pdsi.combo[pdsi.combo$year>=1981,]))$residuals
  mean.lmx <- lmx %>% mean()
  sd.lmx <- lmx %>% sd()
  pdsi.combo$nadaj <- (scale(pdsi.combo$nadaj) + mean.lmx) * sd.lmx
  pdsi.out[,j] <- c(pdsi.combo[pdsi.combo$year <1981,]$nadaj, pdsi.combo[pdsi.combo$year >=1981,]$prismj)
}
pdsi.out$AVG <- pdsi.out %>% dplyr::select(-year) %>% rowMeans()
```

## Reconstructing periods of past outbreak

### Dendroecological approach

A common strategy for detecting periods of WSB outbreak from tree-ring data is to compare the radial growth of the host species, here Douglas-fir, with the radial growth of a non-host species [@swetnam1989]. When the non-host species responds similarly to climate, host ring-width series can then be 'corrected' to remove the effects of interannual climate variability on the radial growth. This allows for the detection of periods of reduced radial growth that may attributed to non-climate factors, such as defoliation by WSB. Across our study area, both ponderosa pine and Douglas-fir have been known to respond negatively to periods of drought [@woodhouse2006], allowing for this method to be applied here.

To follow this general approach, we first obtained all available ponderosa pine chronologies collected in the state of Colorado from the International Tree Ring Databank (ITRDB), as well as previously published chronologies from @veblen2000 (Table \@ref(tab:nonhostmeta)). We then matched each Douglas-fir site with three non-host chronologies by identifying all non-host chronologies that were within 150 km of the sample site. We further limited this subset to the pine chronologies that were collected in the mid-1990s or later, to ensure our records could be linked with geospatial data (see \@ref(combining-tree-ring-and-geospatial-data)). Of this subset, we then selected the three chronologies that showed the greatest similarity in radial growth patterns. This was achieved by first detrending host and non-host ring width series with a negative exponential curve that was fit to the ring-width data using non-linear least squares. The raw ring widths were then divided by the best fitting curve to produce a time series of dimensionless ring-width index (RWI) values. RWI values were further detrended using a 30-year 50% frequency response cubic smoothing spline. This double detrending approach was selected to first remove long-term age-growth related trends and second remove interdecadal patterns that may occur due to disturbance, while preserving high-frequency interannual variation due to climate. Next, we built mean value chronologies from the detrended ring-width series by first pre-whitening each series using an autoregressive time series model. Mean values were then calculated from the residuals of the autoregressive model using a robust mean approach that minimizes the effect of extreme outliers [@speer2010]. We then identified the three non-host chronologies that best correlated with each host chronology using pairwise pearson correlation coefficients. All detrending and chronology building was performed using the *dplR* package [@bunn2008] in R [@rcoreteam2022].

After identifying the three non-host sites that best represented interannual climate variability at each host site, we reprocessed the tree-ring data to better isolate the effects of WSB defoliation on radial growth. Because WSB outbreaks may persists for a decade or more [@swetnam1993, @flower2016], we detrended both the host and non-host tree-ring data using a 100-year cubic smoothing spline to preserve variability at the interdecadal scale [@swetnam1985; @flower2014]. We then constructed mean value chronologies for the non-host sites by first removing serial autocorrelation and then calculating a robust estimate of the mean, as above. To create a single climate-sensitive record for each host site, we performed principal components analysis on the three non-host chronologies and extracted the first principal component to serve as the control series [@flower2014].

```{r host.rwis}
#host.rwis <- lapply(host.rwls, detrend, method = "ModNegExp")
#host.rwis <- lapply(host.rwis, detrend, method = "Spline", nyrs = 100)
host.rwis <- lapply(host.rwls, detrend, method = "Spline", nyrs = 100)
```

```{r nonhost.rwis}
#nonhost.rwis <- lapply(nonhost.rwls, detrend, method = "ModNegExp")
#nonhost.rwis <- lapply(nonhost.rwis, detrend, method = "Spline", nyrs = 100)
nonhost.rwis <- lapply(nonhost.rwls, detrend, method = "Spline", nyrs = 100)
```

```{r nonhost.crns}
nonhost.crns <- lapply(nonhost.rwis, chron, biweight=T, prewhiten = TRUE)
```

To determine if individual trees experienced reductions in growth consistent with defoliation by WSB, we compared the detrended Douglas fir RWI with the control time series [@swetnam1985]. Specifically, we calculate the growth suppression index (GSI) using the following equation:

$GSI_{i} =I_{ht} - (SD_{h}/SD_{n})*(I_{nt}-\bar{I}_{n})$

where $I{ht}$ is the host RWI value for host tree $h$ at year $t$, $SD_{h}$ is the standard deviation of the RWI series for host tree $h$, $SD_{n}$ is the standard deviation of nonhost control series, $I_{nt}$ is the nonhost control series value for year $t$, and $\bar{I}_{n}$ is mean value of the nonhost control series. GSI values less than one indicate periods of reduced radial growth relative to potential growth. For each tree, we then defined defoliation events when: (1) at least eight consecutive years of negative GSI and (2) at least one year exhibited a GSI value that was at least 1.28 standard deviations below the mean [@swetnam1985; @harvey2018]. We then defined stand-level periods of outbreak as periods where: (1) at least 40% of the host trees recorded a defoliation event for 4 or more years and (2) the sample depth was greater than 4 trees [@flower2014]. We performed the correction of host tree-ring series and determination of potential WSB defoliation events and outbreak events in R [@rcoreteam2022] using the dfoliatR package [@guiterman2020].

```{r DendroOutbreaks}

#check data with time series
nada2 <- read.table( here("Data", "Spatial", "NADA", "NADA_Reconstructed_JJA_PDSI_1650_2005.txt"),skip=3)
colnames(nada2) <- c("year", "PDSI")

res <- data.frame(SeriesCode=host.meta.sub$SeriesCode,r.hostxPCA=NA, r.NADAxPCA=NA, r.hostxNADA=NA)

host.defol <- NULL
host.outbreak <- NULL
host.outbreak.stats <- NULL
for(j in host.meta.sub$SeriesCode){
  host.rwis.j <- host.rwis[[j]]
  nonhost.j <- hostxnonhost[hostxnonhost$host==j,c("nonhost1", "nonhost2", "nonhost3")]
  
  nonhost.crns.j<- list(nonhost.crns[[hostxnonhost[hostxnonhost$host==j,"nonhost1"]]], nonhost.crns[[hostxnonhost[hostxnonhost$host==j,"nonhost2"]]], nonhost.crns[[hostxnonhost[hostxnonhost$host==j,"nonhost3"]]])
  nonhost.crns.j.ts <- lapply(nonhost.crns.j, FUN=function(x){return( ts(x, start=min(as.numeric(row.names(x)))) )})
  nonhost.crns.j.mts<- do.call(cbind, nonhost.crns.j.ts) [,c(-3,-6,-9)]
  colnames(nonhost.crns.j.mts) <- c(paste0(nonhost.j[1], c("std", "res")),paste0(nonhost.j[2], c("std", "res")),paste0(nonhost.j[3], c("std", "res")))
  nonhost.crns.j.mts <- na.omit(nonhost.crns.j.mts)
  nonhost.crns.j.pca <- prcomp(nonhost.crns.j.mts , retx=T)
  nonhost.crns.j.pca.df <- as.data.frame(nonhost.crns.j.pca$x[,1])
  row.names(nonhost.crns.j.pca.df) <- time(nonhost.crns.j.mts)
  
  host.crn <- chron(host.rwis.j )
  host.ts <- ts(host.crn$std, start=min(row.names(host.crn )))
  
  nonhost.ts <- ts(nonhost.crns.j.pca.df, start=min(row.names(nonhost.crns.j.pca.df)))
  
  x <- cor(cbind(host.ts, nonhost.ts), use="pairwise.complete.obs")[1,2]
  if(x<0){
    nonhost.crns.j.pca.df[,1] <-nonhost.crns.j.pca.df[,1]  * -1
    res[res$SeriesCode==j, ]$r.NADAxPCA <- cor(cbind(nonhost.ts, ts(nada2$PDSI, start=min(nada2$year))), use="pairwise.complete.obs")[1,2] *-1
    res[res$SeriesCode==j, ]$r.hostxPCA <- cor(cbind(host.ts, nonhost.ts), use="pairwise.complete.obs")[1,2] *-1
  }else{
    res[res$SeriesCode==j, ]$r.NADAxPCA <- cor(cbind(nonhost.ts, ts(nada2$PDSI, start=min(nada2$year))), use="pairwise.complete.obs")[1,2]
    res[res$SeriesCode==j, ]$r.hostxPCA <- cor(cbind(host.ts, nonhost.ts), use="pairwise.complete.obs")[1,2]
  }
  res[res$SeriesCode==j, ]$r.hostxNADA <- cor(cbind(host.ts, ts(nada2$PDSI, start=min(nada2$year))), use="pairwise.complete.obs")[1,2]

  host.defol[[j]] <- defoliate_trees(host_tree=host.rwis.j, nonhost_chron = nonhost.crns.j.pca.df, 
      duration_years = 8, max_reduction = -1.28, bridge_events = T, series_end_event = FALSE)
  host.outbreak[[j]] <- outbreak(host.defol[[j]], filter_min_series = 4, filter_min_defol = 2, filter_perc = 40)
  host.outbreak[[j]]$SeriesCode <- j
  host.outbreak.stats[[j]] <- outbreak_stats(host.outbreak[[j]])
  host.outbreak.stats[[j]]$SeriesCode <- j
}        
```

```{r regionalOutbreaks}
thresholdr <- 0.33
regional.outbreaks <- NULL
for(j in host.meta.sub$SeriesCode){
  x <- host.outbreak[[j]]
  x.ts <- ts(x$outbreak_status, start=x$year[1])
  x.ts[x.ts==3] <- 0
  x.ts[x.ts==1] <- 1
  x.ts[x.ts==2] <- 0
  
  regional.outbreaks <- cbind(regional.outbreaks, x.ts)
}
colnames(regional.outbreaks) <- host.meta.sub$SeriesCode

years <- time(regional.outbreaks)
regional.outbreaks <- as.data.frame(regional.outbreaks)
regional.outbreaks$year <- years
regional.outbreaks$nsites <- apply(regional.outbreaks, MARGIN=1, FUN=function(x){length(na.omit(x))-1})

regional.outbreaks$noutbreaks <- apply(regional.outbreaks, MARGIN=1, FUN=function(x){sum(x[1:(length(x)-2)], na.rm=T)})
regional.outbreaks$noutbreaks[is.na(regional.outbreaks$noutbreaks)]<-0
regional.outbreaks$foutbreak <- regional.outbreaks$noutbreaks / regional.outbreaks$nsites
regional.outbreaks$outbreak <- ifelse(regional.outbreaks$foutbreak >thresholdr & regional.outbreaks$noutbreak >=3, "outbreak","no outbreak")

x <- regional.outbreaks %>% filter(outbreak=="outbreak")
x$dif <- c(NA, diff(x$year, lag=1))
start.yrs <- NULL
end.yrs <- NULL

counter <- min(x$year)
while(counter < max(x$year)){
  if(counter==min(x$year)){
    start.year <- counter
    x.sub <- x %>% filter(year>start.year)
    index <- x.sub %>% filter(dif>1) %>% pull(year) %>% min()
    index <-  which(x.sub$year == index)
    end.year <-   x.sub[(index-1), ]$year
    start.yrs <- c(start.yrs, start.year)
    end.yrs <- c(end.yrs, end.year)
    counter <- end.year
  }else{
    x.sub <- x %>% filter(year>end.yrs[length(end.yrs)])
    start.year <- x.sub %>% pull(year) %>% min()
    index <- x.sub %>% filter(year>start.year & dif>1) %>% pull(year)
    if(length(index)>0){
      index <- index %>% min()
      index <- which(x.sub$year == index)
      end.year <- x.sub[(index-1),] %>% pull(year)
    }else{
      end.year <- max(x.sub$year)
    }
    start.yrs <- c(start.yrs, start.year)
    end.yrs <- c(end.yrs, end.year)
    counter <- end.year
  }
}


regional.outbreaks.sum <- data.frame(start=start.yrs, end=end.yrs)
#Bridge regional outbreaks so that events separated by three or more years are considered a single event
j <- 1
while(j < nrow(regional.outbreaks.sum)){
  regional.outbreaks.sum.j <- regional.outbreaks.sum[j,]
  regional.outbreaks.sum.j2 <- regional.outbreaks.sum[(j+1),]
  if((regional.outbreaks.sum.j2$start - regional.outbreaks.sum.j$end) <=3){
    regional.outbreaks.sum[j,]$end <- regional.outbreaks.sum[(j+1),]$end
    regional.outbreaks.sum <- regional.outbreaks.sum[-(j+1),]
  }
  j <- j +1
}

regional.outbreaks.sum$duration <- regional.outbreaks.sum$end-regional.outbreaks.sum$start+1
regional.outbreaks.sum <- regional.outbreaks.sum %>% filter(duration>4)

```

### Combining tree-ring and geospatial data

We extended tree-ring records of WSB outbreak by spatially joining point data describing the location of sample sites with ADS data describing the annual extent of WSB outbreak for the 1996-2021 period. Additionally, we joined sample site location with data describing wildfire extent [@mtbsprojectMTBSDataAccess2022] and the extent of Douglas-fir beetle (*Dendroctonus psuedotsugae*) outbreak, which both lead to mortality of Douglas fir and thereby may be limit the potential for outbreaks to occur. When sites were affected by either Douglas-fir beetle or fire, we truncated the record in the year prior to the disturbance.

### Defining periods of regional outbreak

Finally, we used the composite record to define periods of regional outbreak, defined here as two or more consecutive years where at least one third of the sites simultaneously recorded a WSB outbreak. Given not all records extend as far back in time, we limited the regional record to time period where at least 50% of the sites were recording.

```{r SpatialJoin_MTBS_ADS}
if(!file.exists(here("Results", "burnedsites.csv"))){
  fires <- st_read(here("Data", "Spatial", "MTBS", "mtbs_perims_DD.shp")) %>% st_transform(proj.proj) 
  # find points within fire polygons
  points_in_fires <- st_join(host.sites.sub, fires, join = st_within)
  points_in_fires %>% as.data.frame() %>% dplyr::select(SeriesCode, Incid_Name, Ig_Date) %>% write.csv(here("Results", "burnedsites.csv"))
}
burnedsites <- read.csv(here("Results", "burnedsites.csv"))

if(!file.exists(here("Results", "ADSsites.csv"))){
  ADS <- st_read(here("Data", "Spatial", "ADS", "CONUS_Region2_AllYears.gdb")) %>% st_transform(proj.proj)
  # find points within ADS polygons
  ADS.sub <- ADS %>% filter(DCA_COMMON_NAME  %in% c("western balsam bark beetle", "Douglas-fir beetle")) 
  points_in_ADS <- st_join(host.sites.sub, ADS.sub, join = st_within)
  points_in_ADS %>% as.data.frame() %>% dplyr::select(SeriesCode, DCA_COMMON_NAME, SURVEY_YEAR) %>% write.csv(here("Results", "ADSsites.csv"))
}
ADSsites <- read.csv(here("Results", "ADSsites.csv"))


geo.outbreak.dat <- data.frame(SeriesCode=burnedsites$SeriesCode, start.yr = 1996, end.yr = c(2020, 2020, 2020, 2020, 2001, 2001, 2001, 2020, 2019, 2019, 2020, 2020) )
```

```{r SummarizeOutbreakHistory}
outbreak.summary.tab <- host.meta.sub[,c("SeriesCode","Lat", "Lon", "EarliestYr", "LatestYr")]
outbreak.summary.tab$EarliestYr <- sapply(host.outbreak, FUN=function(x){return(min(x[x$samp_depth>=4, ]$year))})
outbreak.summary.tab <- left_join(outbreak.summary.tab, geo.outbreak.dat, by="SeriesCode")
host.outbreak.stats.df <- do.call(rbind, host.outbreak.stats[host.meta.sub$SeriesCode])
host.outbreak.stats.df <- host.outbreak.stats.df %>% filter(duration>4)

host.outbreak.stats.df$q <- NA
for(j in host.meta.sub$SeriesCode){
  host.outbreak.stats.df.j <-  host.outbreak.stats.df %>% filter(SeriesCode==j)
  q <- host.outbreak.stats.df.j$start[-1] - host.outbreak.stats.df.j$end[-1*nrow(host.outbreak.stats.df.j)]
  host.outbreak.stats.df[host.outbreak.stats.df$SeriesCode==j,]$q <- c(NA, q)
}

x <- host.outbreak.stats.df %>% group_by(SeriesCode) %>% summarise(no.outbreaks=n(), dur = round(mean(duration),1), duration.sd =round(sd(duration, na.rm=T),2), q=round(mean(q,na.rm=T),1))
x$q.sd <- NA
for(j in host.meta.sub$SeriesCode){
  q<-  host.outbreak.stats.df %>% filter(SeriesCode==j) %>% pull(q) %>% sd(na.rm=T)
 x[x$SeriesCode==j,]$q.sd <- round(q,2)
}
                                                                   
outbreak.summary.tab <- left_join(outbreak.summary.tab , x)

outbreak.summary.tab <- outbreak.summary.tab %>% unite(TOTAL, c(EarliestYr,end.yr), sep="-", remove=F)
outbreak.summary.tab <- outbreak.summary.tab %>% unite(DENDRO,EarliestYr:LatestYr, sep="-", remove=T)
outbreak.summary.tab <- outbreak.summary.tab %>% unite(GEO, start.yr:end.yr, sep="-", remove=T)
 
host.outbreak.stats.df$SeriesCode <- factor(host.outbreak.stats.df$SeriesCode, levels=outbreak.summary.tab[order(outbreak.summary.tab$Lat,decreasing=F),]$SeriesCode, ordered=T)

outbreak.summary.tab.print  <- outbreak.summary.tab %>% tidyr::unite(duration, dur:duration.sd, sep="\n(sd=")
outbreak.summary.tab.print$duration <- paste0(outbreak.summary.tab.print$duration , ")")

outbreak.summary.tab.print  <- outbreak.summary.tab.print %>% tidyr::unite(quiescent, q:q.sd, sep="\n(sd=")
outbreak.summary.tab.print$quiescent <- paste0(outbreak.summary.tab.print$quiescent , ")")
outbreak.summary.tab.print$Lat <- round(outbreak.summary.tab.print$Lat, 3)
outbreak.summary.tab.print$Lon <- round(outbreak.summary.tab.print$Lon, 3)
colnames(outbreak.summary.tab.print) <- c("Site", "Lat. \n(degrees)", "Lon. \n(degrees)", "Combined\nrecord length\n(years)", "Tree-ring\nrecord length\n(years)", "Geospatial\nrecord length\n(years)", "No. of\noutbreaks", "Avg. outbreak\nduration\n(years)", "Avg. quiescent\nperiod\n(years)")
outbreak.summary.tab.print$Site <- factor(outbreak.summary.tab.print$Site, levels=levels(host.meta.sub$SeriesCode), ordered = T)
outbreak.summary.tab.print <- outbreak.summary.tab.print %>% arrange(Site)
```

## Quantifying inter-site synchrony

We tested for synchrony in site-level outbreak histories using several approaches. First, to quantify the level of agreement among records of the percent of trees defoliated at each site we calculated Kendall's coefficient of concordance (W), a non-parametric statistic that quantifies the multivariate agreement in terms of rank [@kendall1970RankCorrelationMethods]. Because Kendall's W does not distinguish between asynchrony and synchrony, we also calculated the mean intersite Spearman's correlation (r~s~ ), which indicates correlation direction but the magnitude is sensitive to sample size [@loreau2008SpeciesSynchronyIts; @gouhier2014SynchronyQuantifyingVariability]. Additionally we calculated concurrency (C), a measure of the proportion of peaks and troughs in agreement between two variables, which is useful for quantifying synchrony when the amplitude of two time series are uncorrelated but local maxima and minima co-occur [@gouhier2014SynchronyQuantifyingVariability]. For all approaches, we determined statistical significance using a bootstrap resampling approach with 1000 replications, where each column in the dataset was shifted a random amount thereby preserving the serial autocorrelation present but not the cross-correlation [@purvesFinescaleSpatialStructure2002]. We performed all correlation analyses using the *synchrony* package [@gouhier2014SynchronyQuantifyingVariability] in R [@rcoreteam2022].

```{r percdefol.r}
percdefol.ts <- NULL

for(j in levels(host.meta.sub$SeriesCode)){
  x <- host.outbreak[[j]]
  x.ts <- ts(x$perc_defol, start=min(x$year))
  percdefol.ts <- cbind(percdefol.ts , x.ts)
}
colnames(percdefol.ts ) <- levels(host.meta.sub$SeriesCode)

percdefol.df <- data.frame(as.matrix(percdefol.ts), year=time(percdefol.ts))
percdefol.df <- percdefol.df %>% pivot_longer(cols=TI:JP, values_to="percent")
percdefol.df <- percdefol.df %>% mutate(name=factor(name, levels=levels(host.meta.sub$SeriesCode), ordered=T))

Fig.file <- here("Results", "Figures", "Fig-PercentDefoliated.jpg")
jpeg(Fig.file, width=4.48, height=6.5, units="in", res=300)
ggplot(percdefol.df, aes(x=year, y=percent))+geom_bar(stat="identity", fill="grey25", col="grey25", width=.1)+facet_wrap(~name, nrow=12)+ylab("percent of trees defoliated")+ scale_y_continuous(breaks = c(0,50,100))
whatever <- dev.off()

listw <- list(kendall.w(window(percdefol.ts, start=1730, end=1998), nrands=1000, type=2, quiet=T),
kendall.w(window(percdefol.ts, start=1750, end=1849), nrands=1000, type=2, quiet=T),
kendall.w(window(percdefol.ts, start=1890,1989), nrands=1000, type=2, quiet=T))

upper.fun <- function(x){return(data.frame(rs=x[upper.tri(x)]))}
listx <- list(cor(window(percdefol.ts, start=1730, end=1998),use="pairwise.complete.obs", method="spearman"),
cor(window(percdefol.ts, start=1750, end=1849), use="pairwise.complete.obs", method="spearman"),
cor(window(percdefol.ts, start=1890,1989), use="pairwise.complete.obs", method="spearman"))
cor.dat <- lapply(listx, upper.fun)
cor.dat[[1]]$subset <- "1730-1998"
cor.dat[[2]]$subset <- "1750-1849"
cor.dat[[3]]$subset <- "1890-1989"
cor.dat <- do.call(rbind, cor.dat)
cor.dat$subset <- factor(cor.dat$subset, levels=c("1730-1998", "1750-1849", "1890-1989"), ordered=T)

spearmans.time <- t.test(cor.dat[cor.dat$subset=="1890-1989", "rs"], cor.dat[cor.dat$subset=="1750-1849", "rs"])

kendalls.w <- data.frame(subset=c("1730-1998", "1750-1849", "1890-1989"), W = sapply(listw, FUN=function(x){return(round(x$w.corrected,2))}),  "p-value" = sapply(listw, FUN=function(x){return(round(x$pval,4))}), r.mean=round(sapply(lapply(listx, upper.fun), colMeans),2), r.max=sapply(lapply(listx, upper.fun), max), r.min=sapply(lapply(listx, upper.fun), min))
kendalls.w$subset <- factor(kendalls.w$subset, levels=c("1730-1998", "1750-1849", "1890-1989"), ordered=T)
kendalls.w$p.value[kendalls.w$p.value==0] <- "<0.001"

if(!file.exists(here("Results", "peakz-1730-1998.csv"))){
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <-  peakz
  peakz.max.lag <-  peakz
  peakz.max.val <- peakz
  for(j in  host.meta.sub$SeriesCode ){
    for(k in 1:nrow(peakz)){
      z <- NULL
      for(t in -5:5){
        percdefol.ts.win <- window(percdefol.ts, start=1750, end=1998) %>% na.omit()
        percdefol.ts.win <- cbind(stats::lag(percdefol.ts.win[,j], k=t), percdefol.ts.win[,k]) %>% na.omit()
        peakjk <- peaks(percdefol.ts.win[,1], percdefol.ts.win[,2])
        z <- c(z, peakjk$obs)
        if(t==0){
          peakjk <- peaks(percdefol.ts.win[,1], percdefol.ts.win[,2], nrands=1000, type=2, quiet=T)
          peakz[k,j] <- peakjk$obs
          peakz.p[k,j] <- peakjk$pval
        }
      }
    peakz.max.lag[k,j] <- paste0((-5:5)[which(z==max(z))][1], collapse=".")
    peakz.max.val[k,j] <- max(z)
    }
  }
  peakz %>% write.csv(here("Results", "peakz-1730-1998.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-p-1730-1998.csv"), row.names = T)
  peakz.max.lag %>% write.csv(here("Results", "peakz-maxlag-1730-1998.csv"), row.names = T)
  peakz.max.val %>% write.csv(here("Results", "peakz-maxvalue-1730-1998.csv"), row.names = T)
  
}

if(!file.exists(here("Results", "peakz-1750-1849.csv"))){
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  for(j in  host.meta.sub$SeriesCode ){
    for(k in 1:nrow(peakz)){
      peakjk <- peaks(window(percdefol.ts[,j],start=1750, end=1849), window(percdefol.ts[,k], start=1750, end=1849), nrands=1000, type=2, quiet=T)
      peakz[k,j] <- peakjk$obs
      peakz.p[k,j] <- peakjk$pval
    }
  }
  peakz %>% write.csv(here("Results", "peakz-1750-1849.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-p-1750-1849.csv"), row.names = T)
}

if(!file.exists(here("Results", "peakz-1890-1989.csv"))){
  peakz <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  row.names(peakz) <- host.meta.sub$SeriesCode
  colnames(peakz) <- host.meta.sub$SeriesCode   
  peakz.p <- data.frame(matrix(nrow=length(host.meta.sub$SeriesCode), ncol=length(host.meta.sub$SeriesCode)))
  for(j in  host.meta.sub$SeriesCode ){
    for(k in 1:nrow(peakz)){
      peakjk <- peaks(window(percdefol.ts[,j],start=1890, end=1989), window(percdefol.ts[,k], start=1890, end=1989), nrands=1000, type=2, quiet=T)
      peakz[k,j] <- peakjk$obs
      peakz.p[k,j] <- peakjk$pval
    }
  }
  peakz %>% write.csv(here("Results", "peakz-1890-1989.csv"), row.names = T)
  peakz.p %>% write.csv(here("Results", "peakz-1890-1989.csv"), row.names = T)
}
count.p <- function(x){return(length(x[x<0.05])/nrow(x))}
upper.fun <- function(x){return(data.frame(proportion=as.numeric(x[upper.tri(x)])))}

peakz <- list( read.csv(here("Results", "peakz-1730-1998.csv")),read.csv(here("Results", "peakz-1750-1849.csv")), read.csv(here("Results", "peakz-1890-1989.csv")))
names(peakz) <- c("1730-1998", "1750-1849", "1890-1989")
peakz.mean <- sapply(lapply(peakz, upper.fun), colMeans, na.rm=T)
peakz.time <- t.test(upper.fun(peakz$'1890-1989'), upper.fun(peakz$'1750-1849'))

Fig.file <- here("Results", "Figures", "Fig-PairwiseCorrelation.jpg")
jpeg(Fig.file, width=4.48, height=3, units="in", res=300)
ggcorr(percdefol.ts, nbreaks = 7,  method = c("pairwise", "spearman"))
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "Fig-PairwiseCorrelation-Colonization.jpg")
jpeg(Fig.file, width=9, height=4, units="in", res=300)
p1 <- ggcorr(window(percdefol.ts, start=1730, end=1998), nbreaks = 7,  method = c("pairwise", "spearman"))
p2 <- ggcorr(window(percdefol.ts, start=1760, end=1859), nbreaks = 7,  method = c("pairwise", "spearman"))
p3 <- ggcorr(window(percdefol.ts, start=1890,1989), nbreaks = 7,  method = c("pairwise", "spearman"),)
p1+labs(title="A - 1730-1998")+p2+labs(title="B - 1750-1849")+p3+labs(title="C - 1890-1989")+ plot_layout(guides = "collect") & theme(legend.position = 'bottom')
whatever <- dev.off()


nw.r <- cor(window(percdefol.ts[,c("NI", "TI", "SP")], start=1730, end=1998),use="pairwise.complete.obs", method="spearman")
nw.r <- nw.r[upper.tri(nw.r)] %>% mean()
nw.c <- peakz[[1]][, c("NI", "TI", "SP")]
nw.c <- nw.c[upper.tri(nw.c)] %>% mean()

ne.r <- cor(window(percdefol.ts[,c("WB", "LJ", "B19", "B18", "SS")], start=1730, end=1998),use="pairwise.complete.obs", method="spearman")
ne.r <- ne.r[upper.tri(ne.r)] %>% mean()
ne.c <- peakz[[1]][, c("WB", "LJ", "B19", "B18", "SS")]
ne.c <- ne.c[upper.tri(ne.c)] %>% mean()

se.r <- cor(window(percdefol.ts[,c("WW", "WR", "JP", "SR")], start=1730, end=1998),use="pairwise.complete.obs", method="spearman")
se.r <- se.r[upper.tri(se.r)] %>% mean()
se.c <- peakz[[1]][, c("WW", "WR", "JP", "SR")]
se.c <- se.c[upper.tri(se.c)] %>% mean()

sub.region.r <- data.frame(region=c("NW", "NE", "SE"), r=c(nw.r, ne.r, se.r), c=c(nw.c, ne.c, se.c))

```

Second, we quantified the spatial scale at which WSB outbreak occurs synchronously using a spline correlogram [@bjornstadNonparametricSpatialCovariance2001]. Here, time series of the percent of trees defoliated at each site were used to calculate cross correlations. Confidence intervals around the correlation function were calculated using a bootstrap resampling approach with 1000 replications. Calculations were performed using the *ncf* package [@bjornstadNcfSpatialNonparametric2020] in R [@rcoreteam2022].

```{r SNCF}
if(!file.exists(here("Results", "Regional-sychrony.csv"))){
  host.meta.sub <- host.meta.sub %>% arrange(SeriesCode)
  host.sites.sub <- st_as_sf(x = host.meta.sub, coords = c("Lon", "Lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(26913)
  z <- t(as.data.frame(window(percdefol.ts, start=1730, end=1998)))

   sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T, quiet=T)
  
  sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted $x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])
  sncf.plot <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")
  
  Regional.synch.1730.1998 <- summary(sncf.percdefol)$Regional.synch 
  
  z <- t(as.data.frame(window(percdefol.ts,start=1750, end=1849)))
  sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T)
  
  sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted$x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])
  sncf.plot.pre <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")

  Regional.synch.1750.1849 <- summary(sncf.percdefol)$Regional.synch 
  
  z <- t(as.data.frame(window(percdefol.ts,start=1890, end=1989)))
  sncf.percdefol <- Sncf(x=st_coordinates(host.sites.sub)[,1], y=st_coordinates(host.sites.sub)[,2], z, resamp = 1000, na.rm=T)
  
  sncf.percdefol.res <- data.frame(x=sncf.percdefol$real$predicted$x[1,], y=sncf.percdefol$real$predicted$y[1,], upper=sncf.percdefol$boot$boot.summary$predicted$y[10,], lower=sncf.percdefol$boot$boot.summary$predicted$y[2,])
  sncf.plot.post <- ggplot(sncf.percdefol.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+ylim(-0.5,1)+xlim(0,100)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.percdefol)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")

  Regional.synch.1890.1989 <- summary(sncf.percdefol)$Regional.synch
  
  
  Fig.file <- here("Results", "Figures", "FigCovariance-Multi.jpg")
  jpeg(Fig.file, width=fig.width2, height=3, units="in", res=300)
  sncf.plot+labs(title="A - 1750-1998") + sncf.plot.pre+labs(title="B - 1750-1849") + sncf.plot.post+labs(title="C - 1890-1989")
  whatever <- dev.off()
  
  Fig.file <- here("Results", "Figures", "FigCovariance.jpg")
  jpeg(Fig.file, width=fig.width1, height=2.4, units="in", res=300)
  sncf.plot
  whatever <- dev.off()
  
  ts.crn <- function(x){return(ts(x$res, start=min(as.numeric(row.names(x))), end=max(as.numeric(row.names(x)))))}
  nonhost.crns.ts <- do.call(cbind,lapply(nonhost.crns, ts.crn))
  nonhost.crns.df <- as.data.frame(window(nonhost.crns.ts, start=1730, end=1998))
  nonhost.crns.df <- nonhost.crns.df[,colnames(nonhost.crns.df)%in%nonhost.meta.sub$SeriesCode]
  nonhost.crns.sites.sub <- st_as_sf(x = nonhost.meta.sub, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(26913)

  z <- t(nonhost.crns.df)
  sncf.nonhost <- Sncf(x=st_coordinates(nonhost.crns.sites.sub)[,1], y=st_coordinates(nonhost.crns.sites.sub)[,2], z, resamp = 1000, na.rm=T, quiet=T)
  
  sncf.nonhost.res <- data.frame(x=sncf.nonhost$real$predicted$x[1,], y=sncf.nonhost$real$predicted$y[1,], upper=sncf.nonhost$boot$boot.summary$predicted$y[10,], lower=sncf.nonhost$boot$boot.summary$predicted$y[2,])
  sncf.plot.nonhost <- ggplot(sncf.nonhost.res, aes(x=x/1000, y=y))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+xlim(0,100)+ylim(-0.5,1)+geom_abline(intercept = 0, slope = 0) +geom_abline(intercept = summary(sncf.nonhost)$Regional.synch, slope = 0, linetype = "dashed") +labs(x="distance (km)", y= "covariance")
  
  Fig.file <- here("Results", "Figures", "FigCovariance-Nonhost.jpg")
  jpeg(Fig.file, width=fig.width1, height=2.4, units="in", res=300)
  sncf.plot.nonhost
  whatever <- dev.off()
  
    Regional.synch <- data.frame(years=c("1730-1998", "1750-1849", "1890-1989"), dataset="defoliated", synchrony=c(Regional.synch.1730.1998, Regional.synch.1750.1849, Regional.synch.1890.1989))
    Regional.synch <- rbind(Regional.synch, c("1730-1998", "RWI",summary(sncf.nonhost)$Regional.synch))
  Regional.synch %>% write.csv(here("Results", "Regional-sychrony.csv"), row.names=F)


}
  
Regional.synch <- read.csv(here("Results", "Regional-sychrony.csv"))
```

Third, we used Multivariate Event Analysis to test for clustering among years of outbreak initiation and cessation. Multivariate Event Analysis is a modification of Ripley's K that identifies the synchrony of events in one dimension (time) within a defined window by comparing the timing of events within multiple records [@gavinWeakClimaticControl2006]. MEA was performed using the R implementation of the K1D software [@gavin2010K1DAnalysisSynchrony].

```{r MEA}

  source(here("Code", "k1d.r"))
  k1d.dat.initiation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
    x <- ts(x$start, start=1)
   k1d.dat.initiation <- cbind(k1d.dat.initiation, x)
  }  
  colnames(k1d.dat.initiation) <- host.meta.sub$SeriesCode
  
  
  k1d.initiation.t<- k1d(k1d.dat.initiation,start=1730,end=2020 ,nstep=21,stepsize=1)
  k1d.initiation.s <- k1d.sim(k1d.initiation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.initiation.t$h, Lhat=k1d.initiation.t$Lhat, upper=k1d.initiation.s[1,], lower=k1d.initiation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  startk <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = " ", y = "Temporal clustering", title = "A - Initiation (1730-2020)") +theme(legend.position="none") +ylim(-7.5, 7.5)
  
  k1d.dat.cessation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
   x <- ts(x$end, start=1)
   k1d.dat.cessation <- cbind(k1d.dat.cessation, x)
  }  
  colnames(k1d.dat.cessation) <- host.meta.sub$SeriesCode
  source(here("Code", "k1d.r"))
  k1d.cessation.t<- k1d(k1d.dat.cessation,start=1750,end=1998,nstep=21,stepsize=1)
  k1d.cessation.s <- k1d.sim(k1d.cessation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.cessation.t$h, Lhat=k1d.cessation.t$Lhat, upper=k1d.cessation.s[1,], lower=k1d.cessation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  endk <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = "lag (years)", y = "Temporal clustering", title = "B - Cessation (1730-2020)") +theme(legend.position="none")  +ylim(-7.5, 7.5)
  
  ### Pre 1850
  k1d.dat.initiation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
   x <- ts(x$start, start=1)
   k1d.dat.initiation <- cbind(k1d.dat.initiation, x)
  }  
  colnames(k1d.dat.initiation) <- host.meta.sub$SeriesCode
  
  
  k1d.initiation.t<- k1d(k1d.dat.initiation,start=1750,end=1849,nstep=21,stepsize=1)
  k1d.initiation.s <- k1d.sim(k1d.initiation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.initiation.t$h, Lhat=k1d.initiation.t$Lhat, upper=k1d.initiation.s[1,], lower=k1d.initiation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  startk.pre <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = " ", y = "Temporal clustering", title = "B - Initiation (1750-1849)") +theme(legend.position="none") +ylim(-7.5, 7.5)
  
  
  k1d.dat.cessation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
   x <- ts(x$end, start=1)
   k1d.dat.cessation <- cbind(k1d.dat.cessation, x)
  }  
  colnames(k1d.dat.cessation) <- host.meta.sub$SeriesCode
  source(here("Code", "k1d.r"))
  k1d.cessation.t<- k1d(k1d.dat.cessation,start=1750,end=1849,nstep=21,stepsize=1)
  k1d.cessation.s <- k1d.sim(k1d.cessation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.cessation.t$h, Lhat=k1d.cessation.t$Lhat, upper=k1d.cessation.s[1,], lower=k1d.cessation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  endk.pre <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = "lag (years)", y = "Temporal clustering", title = "E - Cessation (1750-1849)") +theme(legend.position="none")  +ylim(-7.5, 7.5)
  
  
  ### Post 1870
  k1d.dat.initiation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
   x <- ts(x$start, start=1)
   k1d.dat.initiation <- cbind(k1d.dat.initiation, x)
  }  
  colnames(k1d.dat.initiation) <- host.meta.sub$SeriesCode
  
  
  k1d.initiation.t<- k1d(k1d.dat.initiation,start=1890,end=1989,nstep=21,stepsize=1)
  k1d.initiation.s <- k1d.sim(k1d.initiation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.initiation.t$h, Lhat=k1d.initiation.t$Lhat, upper=k1d.initiation.s[1,], lower=k1d.initiation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  startk.post <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = " ", y = "Temporal clustering", title = "C - Initiation (1890-1989)") +theme(legend.position="none") +ylim(-7.5, 7.5)
  
  
  k1d.dat.cessation <- NULL
  for(j in host.meta.sub$SeriesCode){
    x <- host.outbreak.stats[[j]] %>% filter(duration>4)
   x <- ts(x$end, start=1)
   k1d.dat.cessation <- cbind(k1d.dat.cessation, x)
  }  
  colnames(k1d.dat.cessation) <- host.meta.sub$SeriesCode
  source(here("Code", "k1d.r"))
  k1d.cessation.t<- k1d(k1d.dat.cessation,start=1890,end=1989,nstep=21,stepsize=1)
  k1d.cessation.s <- k1d.sim(k1d.cessation.t,scenario="random",nsim=100,perc=c(0.025,0.975))
  x <- data.frame(h=k1d.cessation.t$h, Lhat=k1d.cessation.t$Lhat, upper=k1d.cessation.s[1,], lower=k1d.cessation.s[2,])
  y <- reshape2::melt(x, id.var='h')
  
  endk.post <- ggplot(x, aes(x=h, y=Lhat))+geom_ribbon(aes(ymin=lower, ymax=upper), fill="lightgray")+geom_line(col="blue")+geom_hline(yintercept=0)+labs(x = "lag (years)", y = "Temporal clustering", title = "F - Cessation (1980-1989)") +theme(legend.position="none")  +ylim(-7.5, 7.5)
  
  Fig.file <- here("Results", "Figures", "MEA-Multi.jpg")
  jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
  startk + theme(axis.text.x = element_blank(), axis.title.x = element_blank() ) +startk.pre + theme(axis.text = element_blank(), axis.title = element_blank() ) +startk.post + theme(axis.text = element_blank(), axis.title = element_blank()) +endk + endk.pre + theme(axis.text.y = element_blank(), axis.title.y = element_blank())  + endk.post + theme(axis.text.y = element_blank(), axis.title.y = element_blank()) + plot_layout(nrow=2)
  whatever <- dev.off() 
  
  
  Fig.file <- here("Results", "Figures", "MEA.jpg")
  jpeg(Fig.file, width=fig.width1, height=3.5, units="in", res=300)
  startk+xlab("lag (years)")+labs(title="A - Initiation") +endk+labs(title="B - Cessation")  + plot_layout(nrow=2)
  whatever <- dev.off() 
```

## Understanding the influence of Euro-American settlement on outbreak dynamics and effects

To determine if Euro-American settlement influenced the dynamics of WSB outbreaks, we split our dataset into two 100-yr periods: (1) 1750-1849, or approximately the century before intensive colonization occurred in the mid to late 1800s [@veblen2000], and (2) 1890-1989, or approximately the century after intensive colonization. We then compared site-level outbreak characteristics during these two period. Specifically we compared: (1) the probability of an outbreak occurring in an individual year, (2) outbreak duration, (3) the length the period of quiescence between outbreaks, (4) the minimum normalized GSI, and (5) the percent of trees defoliated. We modeled the response variable as a function of a categorically variable describing the time period as either 1750-1849 or 1890-1989 and tested the statistical hypothesis that the intercept differed from zero using a Wald test. In all models we included a random effect of site identity to account for multiple outbreak events within each site. In the model of outbreak occurrence in a given year, we additionally included a first order autocorrelation structure to account for temporal autocorrelation. Models were fit using Penalized Quasi-Likelihood using the packages MASS [@MASS] and nlme [@nlme] in R [@rcoreteam2022]. Additionally, we used spline correlograms to determine if the Euro-American colonization affected the spatial scale at which WSB outbreak occurs synchronously. We performed separate analyses for the 1750-1959 and 1890-1989 periods and visually compared the results.

```{r ColonizationEffects}
for(j in names(host.outbreak)){
  last.tree.yr <- max(host.outbreak[[j]]$year)
  last.geo.yr <- geo.outbreak.dat[geo.outbreak.dat$SeriesCode==j, ]$end.yr
  supplement <- data.frame(year=(last.tree.yr+1):last.geo.yr, samp_depth=1, num_defol=NA, perc_defol=NA, num_max_defol=NA, perc_max_defol=NA, mean_gsi=NA, mean_ngsi=NA, outbreak_status="not_obr", SeriesCode=j)
  host.outbreak[[j]] <- rbind(host.outbreak[[j]], supplement)
}

host.outbreak.lag <- lapply(host.outbreak, FUN=function(x){x$outbreak <- ifelse(x$outbreak=="outbreak", 1, 0); return(x)})
host.outbreak.lag <- lapply(host.outbreak.lag, FUN=function(x){x$lag <- c(NA,x$outbreak[(-1*nrow(x))]); return(x)})
host.outbreak.df <- do.call(rbind, host.outbreak.lag)

host.outbreak.df.sub <- host.outbreak.df %>% filter(year>=1750)
host.outbreak.df.sub <- host.outbreak.df.sub %>% filter(!(year %in% (1850:1889)))
host.outbreak.df.sub$timeperiod <- ifelse(host.outbreak.df.sub$year <=1849, "1750-1849", "1890-1989")

host.outbreak.stats.df.sub <- host.outbreak.stats.df %>% filter(start>1750)
host.outbreak.stats.df.sub <- host.outbreak.stats.df.sub %>% filter(!(start %in% (1850:1889)))
host.outbreak.stats.df.sub$timeperiod <- ifelse(host.outbreak.stats.df.sub$start <=1849, "1750-1849", "1890-1989")
host.outbreak.stats.df.sub$n <- round(host.outbreak.stats.df.sub$n_df_start/(host.outbreak.stats.df.sub$perc_df_start/100))

mod.ngsi <- glmmPQL(min_ngsi~timeperiod, random=~1|SeriesCode, family=gaussian, data=host.outbreak.stats.df.sub)
mod.n_df_start <- glmmPQL(cbind(n_df_start,n)~timeperiod, random=~1|SeriesCode, family=binomial, data=host.outbreak.stats.df.sub)
mod.duration <- glmmPQL(duration~timeperiod, random=~1|SeriesCode, family=poisson, data=host.outbreak.stats.df.sub)
mod.q <- glmmPQL(q~timeperiod, random=~1|SeriesCode, family=poisson, data=host.outbreak.stats.df.sub)
mod.outbreak <- glmmPQL(outbreak~timeperiod+lag, random=~1|SeriesCode, family=binomial(link="logit"), data=host.outbreak.df.sub)

modz <- list(mod.outbreak,mod.duration, mod.q, mod.ngsi, mod.n_df_start)
colonization.results <- data.frame(response=c("occurence of years of outbreak", "duration of outbreak", "length of quiescent period", "minimum normalized GSI during outbreak events", "percent of trees defoliated at start of outbreak"))
colonization.results$coefficient <- sapply(modz, FUN=function(x){return(round(summary(x)$coefficients$fixed[2],3))})

colonization.results$p.value <- sapply(modz, FUN=function(x){return(round(summary(x)$tTable[2,5], 3))})

host.outbreak.df.sub$outbreak_status <- factor(host.outbreak.df.sub$outbreak_status, levels=c("not_obr","outbreak" ),labels=c("no outbreak","outbreak"), ordered=T)


#p1.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=c("a", "a"), outbreak_status="outbreak")
p1.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=paste0("n = ", table(host.outbreak.stats.df.sub$timeperiod)), outbreak_status="outbreak")
p1 <- ggplot(host.outbreak.df.sub, aes(x=timeperiod))+geom_bar(position="fill", aes(fill=outbreak_status))+ylab("proportion of years\naffected by WSB outbreak")+ theme(axis.title.x=element_blank())+theme(legend.position = "none")+scale_fill_manual(values=c("white", "grey20"))+ylim(0,0.265)+geom_text(data=p1.labs, aes(label = label, x = timeperiod, fill=outbreak_status, y = c(0.26,0.205)), size=3)

#p2.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=c("a", "a"))
p2 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=duration))+geom_boxplot()+ylab("outbreak duration (years)")+ theme(axis.title.x=element_blank())+ylim(4,22)#+geom_text(data=p2.labs, aes(label = label, x =timeperiod, y = c(21.75,21)), size=3)

p3.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=c("a", "a"))
p3 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=min_ngsi))+geom_boxplot()+ylab("Minimum normalized\ngrowth suppression index")+ theme(axis.title.x=element_blank())+ylim(-3,-0.4)#+geom_text(data=p3.labs, aes(label = label, x =timeperiod, y = c(-0.8,-0.4)), size=3)

p4.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=c("a", "a"))
p4 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=perc_df_start))+geom_boxplot()+ylab("percent of trees defoliated\nat start of outbreak")+ theme(axis.title.x=element_blank())+ylim(40,90)#+geom_text(data=p4.labs, aes(label = label, x =timeperiod, y = c(86,68)), size=3)

p5.labs <- data.frame(timeperiod= c("1750-1849", "1890-1989"), label=c("a", "a"))
p5 <- ggplot(host.outbreak.stats.df.sub, aes(x=timeperiod, y=q))+geom_boxplot()+ylab("length of quiescent\nperiod (years)")+ theme(axis.title.x=element_blank())#+ylim(40,90)#+geom_text(data=p4.labs, aes(label = label, x =timeperiod, y = c(86,68)), size=3)

Fig.file <- here("Results", "Figures", "Colonization.jpg")
jpeg(Fig.file, width=fig.width2, height=2.5, units="in", res=300)
p1+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p2+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p5+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p3+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+p4+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+plot_layout(nrow=1)+plot_annotation(tag_levels = "A")
whatever <- dev.off()
```

## Quantifying the relationship between climate and outbreaks of the WSB

To quantify the association between climate variability and WSB outbreak, we used several approaches. First, we used a t-test to determine if SC-PDSI differed during periods of regional outbreak and non-outbreak periods. To quantify SC-PDSI across the region, we averaged SC-PDSI across all sites. Given the assumption of independence of observations and strong serial autocorrelation in the regional SC-PDSI time series, we first fit an autoregressive model to the regional SC-PDSI time series. We used AIC [@akaikeInformationTheoryExtension1973] to select the level of complexity. We fit the autoregressive model using the R package *stats* [@rcoreteam2022] and then performed the t-test on the residuals.

```{r ttest}
pdsi.out$AVG.resid <- ar(ts(pdsi.out$AVG, start=min(pdsi.out$year)))$resid
regional.outbreaks.ex <- data.frame(B18=NA, B19=NA, LJ=NA, SS=NA, WR=NA, JP=NA, WW=NA, SR=NA, NI=NA, SP=NA, WB=NA, TI=NA, year=2000:2020, nsites=NA, noutbreaks=NA, foutbreak=NA, outbreak="no outbreak")
regional.outbreaks$year <- as.numeric(regional.outbreaks$year)
regional.outbreaks.ex  <- rbind(regional.outbreaks, regional.outbreaks.ex)

all.outbreak.yrs <- host.outbreak.df %>% filter(outbreak_status=="outbreak") %>% pull(year) %>% unique()
regional.outbreaks.ex$all.outbreak <- ifelse(regional.outbreaks.ex$year %in% all.outbreak.yrs, "outbreak", "no outbreak")

x <- full_join(pdsi.out, regional.outbreaks.ex, by="year")
x <- x[x$year>=1750,]
x <- na.omit(x[,c("year", "AVG.resid", "AVG", "outbreak", "all.outbreak")])

x.total <- x[x$year %in% 1730:2020, ]
xt <- t.test(x.total[x.total$outbreak=="outbreak", "AVG.resid"],x.total[x.total$outbreak=="no outbreak", "AVG.resid"] )

pdsi.t <- t.test(x[x$year %in% 1750:1849, "AVG.resid"], x[x$year %in% 1890:1989, "AVG.resid"],)

xt.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("b", "a"))

x.early <- x[x$year %in% 1750:1849,]
x.early.t <- t.test(x.early[x.early$outbreak=="outbreak", "AVG.resid"],x.early[x.early$outbreak=="no outbreak", "AVG.resid"] )

x.early.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("b", "a"))

x.late <- x[x$year %in% 1890:1989,]
x.late.t <- t.test(x.late[x.late$outbreak=="outbreak", "AVG.resid"],x.late[x.late$outbreak=="no outbreak", "AVG.resid"] )

x.late.labs <- data.frame(timeperiod= c("outbreak", "no outbreak"), label=c("a", "a"))

p1 <- ggplot(x, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=xt.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

p2 <- ggplot(x.early, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=x.early.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

p3 <- ggplot(x.late, aes(x=outbreak, y=AVG))+geom_boxplot()+ylab("JJA SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=x.late.labs, aes(label = label, x =timeperiod, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)+theme(axis.title.y=element_blank(), axis.text.y=element_blank())

x$time.period <- NA
x[x$year %in% 1750:1849,]$time.period <- "1750-1849"
x[x$year %in% 1890:1989,]$time.period <- "1890-1989"
xx <- x[x$time.period %in% c("1750-1849","1890-1989"),]

xxt.labs <- data.frame(time.period= c("1750-1849", "1890-1989"), label=c("a", "a"))
p4 <- ggplot(xx, aes(x=time.period, y=AVG))+geom_boxplot()+ylab("SC-PDSI")+theme(axis.title.x=element_blank())+geom_text(data=xxt.labs, aes(label = label, x =time.period, y = c(6.3,5.9)), size=3)+ylim(-8, 6.5)

 
Fig.file <- here("Results", "Figures", "T.jpg")
jpeg(Fig.file, width=fig.width1.5, height=2, units="in", res=300)
p2+labs(title = "A - 1750-1849")+p3+labs(title = "B - 1890-1989")+plot_layout(nrow=1)
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "T-simple.jpg")
jpeg(Fig.file, width=fig.width1, height=2, units="in", res=300)
p1
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "T-PDSI.jpg")
jpeg(Fig.file, width=fig.width1, height=2, units="in", res=300)
p4
whatever <- dev.off()

```

We then used superposed epoch analysis [@loughAssessmentPossibleEffects1987] to compare SC-PDSI values in years with and without outbreak initiations and cessations [@flower2014; @harvey2018]. Specifically, we used superposed epoch analysis to calculate the departure from the mean SC-PDSI for the years prior to a year of outbreak initiation (cessation), during the year of outbreak initiation (cessation), and following the year of outbreak initiation initiation (cessation) using an 11-year window centered on the event year [@flower2014; @ellisMulticenturyDendrochronologicalReconstruction2017]. To determine if departures from the mean value were significant, we used 1000 bootstrap samples with a block resampling design that preserved autocorrelation in a 5-year window. While block resampling estimates null distributions for serially autocorrelated data, p-values generated in this way may be still be too small if autocorrelation is strong (i.e., \> 60%) over lags greater than the analysis interval. Thus prior to running our superposed epoch analyses, we confirmed that minimal (r\<0.05) serial correlation existed at lags greater than 5 years. We performed separate superposed epoch analysis for each site and then summarized these results by counting the number of sites with a positive or negative association that was statistically significant [@flower2014]. We also performed a superposed epoch analysis using the dates of outbreak initiation and cessation using the regional outbreak record and the regional SC-PDSI time series. Superposed epoch analysis was performed in R [@rcoreteam2022] using the *dplR* package [@bunn2008].

```{r sea.site}
sea.initiation <- NULL
initiation.pdsi <- data.frame(value=NA, initiation=NA, site=NA)
sea.cessation <- NULL
row.names(pdsi.out) <- pdsi.out$year
for(j in host.meta.sub$SeriesCode){
  z <- outbreak.summary.tab %>% filter(SeriesCode==j)
  start.j <- sapply(strsplit(z$TOTAL, split="-"), "[", 1) %>% as.numeric()
  start.j <- ifelse(start.j<1730, 1730, start.j)
  end.j <- sapply(strsplit(z$TOTAL, split="-"), "[", 2) %>% as.numeric()
  
  pdsi.out.j <- ts(pdsi.out[,j], start=min(as.numeric(row.names(pdsi.out))))
  pdsi.out.j <-  pdsi.out.j %>% as.data.frame()
  colnames(pdsi.out.j) <- "PDSI"
  row.names(pdsi.out.j) <- min(as.numeric(row.names(pdsi.out))):max(as.numeric(row.names(pdsi.out)))
  
  x <- host.outbreak.stats[[j]] %>% filter(duration>4)
  sea.initiation[[j]] <- sea(x= pdsi.out.j, key=x$start, lag=5)
  sea.initiation[[j]]$SeriesCode <- j
  sea.initiation[[j]]$sig05 <- ifelse(sea.initiation[[j]]$p <=0.05, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
  sea.initiation[[j]]$sig10 <- ifelse(sea.initiation[[j]]$p >0.05 & sea.initiation[[j]]$p <=0.1, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
   sea.initiation[[j]]$pos01 <- ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
   
  sea.cessation[[j]] <- sea(x= pdsi.out.j, key=x$end, lag=5)
  sea.cessation[[j]]$SeriesCode <- j
  sea.cessation[[j]]$sig05 <- ifelse(sea.cessation[[j]]$p <=0.05, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$sig10 <- ifelse(sea.cessation[[j]]$p >0.05 & sea.cessation[[j]]$p <=0.1, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$pos01 <- ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)

}

sea.cessation.df <- do.call(rbind, sea.cessation)
sea.cessation.df$sig <- cut(sea.cessation.df$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

sea.initiation.df <- do.call(rbind, sea.initiation)
sea.initiation.df$sig <- cut(sea.initiation.df$p, breaks=c(-1,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

Fig.file <- here("Results", "Figures", "SEA-initation-site.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.initiation.df, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "SEA-cessation-site.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.cessation.df, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()

countpos <- function(x){sum(x[x>0])}
countneg <- function(x){sum(x[x<0])}

sea.initiation.pos.summary <- sea.initiation.df %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.initiation.neg.summary <- sea.initiation.df %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.initiation.summary <- rbind(sea.initiation.pos.summary, sea.initiation.neg.summary) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.initiation.summary$plotby <- factor(sea.initiation.summary$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"),   labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.cessation.pos.summary <- sea.cessation.df %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.cessation.neg.summary <- sea.cessation.df %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.cessation.summary <- rbind(sea.cessation.pos.summary, sea.cessation.neg.summary) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.cessation.summary$plotby <- factor(sea.cessation.summary$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"), labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.init.combo <- ggplot(sea.initiation.summary, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c('#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.title=element_blank())+ylab("Count of sites")

sea.cess.combo <- ggplot(sea.cessation.summary, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c( '#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.title=element_blank())

Fig.file <- here("Results", "Figures","SEA-combo-site.jpg")
jpeg(Fig.file, width=fig.width1.5, height=3, units="in", res=300)
sea.init.combo+ylab("Count of sites")+xlab("lag (years)")+labs(title = "A - Initiation")+ sea.cess.combo+xlab("lag (years)")+labs(title = "B - Cessation")+ theme(axis.text.y = element_blank(), axis.title.y = element_blank()) + plot_layout(nrow=1)  + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
whatever <- dev.off()
```

To determine if the effect of climate on WSB outbreak dynamics differed in the century prior to and following extensive Euro-American colonization, we first used a t-test to compare SC-PDSI values during the two periods. To account for serial autocorrelation, we performed the t-test on the residuals of an autoregressive model fit to the regional SC-PDSI time series. After confirming that SC-PDSI values were similar during the 1750-1959 and 1890-1989 periods [\@ref(fig:FigPDSIbyTimePeriod)], we performed separate superposed epoch analyses for each time period.

```{r sea.pre1850}
sea.initiation <- NULL
sea.cessation <- NULL
row.names(pdsi.out) <- pdsi.out$year
for(j in host.meta.sub$SeriesCode[!(host.meta.sub$SeriesCode %in% c("B18", "WW"))]){
  
   pdsi.out.j <- ts(pdsi.out[,j], start=min(as.numeric(row.names(pdsi.out))))
  pdsi.out.j <-  pdsi.out.j %>% as.data.frame()
  colnames(pdsi.out.j) <- "PDSI"
  row.names(pdsi.out.j) <- min(as.numeric(row.names(pdsi.out))):max(as.numeric(row.names(pdsi.out)))

  x <- host.outbreak.stats[[j]] %>% filter(duration>4)
  x <- x[x$start<1850 & x$start>1749,]

  sea.initiation[[j]] <- sea(x= pdsi.out.j, key=x$start, lag=5)
  sea.initiation[[j]]$SeriesCode <- j
  sea.initiation[[j]]$sig05 <- ifelse(sea.initiation[[j]]$p <=0.05, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
  sea.initiation[[j]]$sig10 <- ifelse(sea.initiation[[j]]$p >0.05 & sea.initiation[[j]]$p <=0.1, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
   sea.initiation[[j]]$pos01 <- ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)

  sea.cessation[[j]] <- sea(x= pdsi.out.j, key=x$end, lag=5)
  sea.cessation[[j]]$SeriesCode <- j
  sea.cessation[[j]]$sig05 <- ifelse(sea.cessation[[j]]$p <=0.05, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$sig10 <- ifelse(sea.cessation[[j]]$p >0.05 & sea.cessation[[j]]$p <=0.1, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$pos01 <- ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)

}

sea.initiation.df.pre <- do.call(rbind, sea.initiation)
sea.cessation.df.pre <- do.call(rbind, sea.cessation)

sea.initiation.df.pre$sig <- cut(sea.initiation.df.pre$p, breaks=c(-1,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)
sea.cessation.df.pre$sig <- cut(sea.cessation.df.pre$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)


Fig.file <- here("Results", "Figures", "SEA-initation-site-pre.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.initiation.df.pre, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "SEA-cessation-site-pre.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.cessation.df.pre, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()


countpos <- function(x){sum(x[x>0])}
countneg <- function(x){sum(x[x<0])}


sea.initiation.pos.summary.pre <- sea.initiation.df.pre %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.initiation.neg.summary.pre <- sea.initiation.df.pre %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.initiation.summary.pre<- rbind(sea.initiation.pos.summary.pre, sea.initiation.neg.summary.pre) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.initiation.summary.pre$plotby <- factor(sea.initiation.summary.pre$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"), labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.cessation.pos.summary.pre <- sea.cessation.df.pre %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.cessation.neg.summary.pre <- sea.cessation.df.pre %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.cessation.summary.pre <- rbind(sea.cessation.pos.summary.pre, sea.cessation.neg.summary.pre) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.cessation.summary.pre$plotby <- factor(sea.cessation.summary.pre$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"),labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)


sea.init.combo.pre <- ggplot(sea.initiation.summary.pre, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c('#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.position="none")+ylab("Count of sites")

sea.cess.combo.pre <- ggplot(sea.cessation.summary.pre, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c( '#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.position="none")

```

```{r sea.post1890}
sea.initiation <- NULL
sea.cessation <- NULL
row.names(pdsi.out) <- pdsi.out$year
for(j in host.meta.sub$SeriesCode[!(host.meta.sub$SeriesCode %in% c("B18","WW"))]){
 
  pdsi.out.j <- ts(pdsi.out[,j], start=min(as.numeric(row.names(pdsi.out))))
  pdsi.out.j <-  pdsi.out.j %>% as.data.frame()
  colnames(pdsi.out.j) <- "PDSI"
  row.names(pdsi.out.j) <- min(as.numeric(row.names(pdsi.out))):max(as.numeric(row.names(pdsi.out)))

  x <- host.outbreak.stats[[j]] %>% filter(duration>4)
  x <- x[x$start>1859 & x$start <1990,]
  
  sea.initiation[[j]] <- sea(x= pdsi.out.j, key=x$start, lag=5)
  sea.initiation[[j]]$SeriesCode <- j
  sea.initiation[[j]]$sig05 <- ifelse(sea.initiation[[j]]$p <=0.05, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
  sea.initiation[[j]]$sig10 <- ifelse(sea.initiation[[j]]$p >0.05 & sea.initiation[[j]]$p <=0.1, 1,0) *ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)
   sea.initiation[[j]]$pos01 <- ifelse(sea.initiation[[j]]$se.unscaled <0, -1,1)

  sea.cessation[[j]] <- sea(x= pdsi.out.j, key=x$end, lag=5)
  sea.cessation[[j]]$SeriesCode <- j
  sea.cessation[[j]]$sig05 <- ifelse(sea.cessation[[j]]$p <=0.05, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$sig10 <- ifelse(sea.cessation[[j]]$p >0.05 & sea.cessation[[j]]$p <=0.1, 1,0)  *ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
  sea.cessation[[j]]$pos01 <- ifelse(sea.cessation[[j]]$se.unscaled <0, -1,1)
}

sea.cessation.df.post <- do.call(rbind, sea.cessation)
sea.initiation.df.post <- do.call(rbind, sea.initiation)


sea.initiation.df.post$sig <- cut(sea.initiation.df.post$p, breaks=c(-1,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)
sea.cessation.df.post$sig <- cut(sea.cessation.df.post$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

Fig.file <- here("Results", "Figures", "SEA-initation-site-post.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.initiation.df.post, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()

Fig.file <- here("Results", "Figures", "SEA-cessation-site-post.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
ggplot(sea.cessation.df.post, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+facet_wrap(.~SeriesCode)+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black", "grey30", "lightgray"))+ylab("JJA SC-PDSI")+xlab("lag (years)")
whatever <- dev.off()

sea.initiation.pos.summary.post <- sea.initiation.df.post %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.initiation.neg.summary.post <- sea.initiation.df.post %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.initiation.summary.post <- rbind(sea.initiation.pos.summary.post, sea.initiation.neg.summary.post) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.initiation.summary.post$plotby <- factor(sea.initiation.summary.post$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"), labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)

sea.cessation.pos.summary.post <- sea.cessation.df.post %>% group_by(lag) %>% summarise(sig05=countpos(sig05),sig10=countpos(sig10),  direction='positive')
sea.cessation.neg.summary.post <- sea.cessation.df.post %>% group_by(lag) %>% summarise(sig05=countneg(sig05),sig10=countneg(sig10), direction='negative')
sea.cessation.summary.post <- rbind(sea.cessation.pos.summary.post, sea.cessation.neg.summary.post) %>% pivot_longer(sig05:sig10) %>% unite('plotby',direction:name) 
sea.cessation.summary.post$plotby <- factor(sea.cessation.summary.post$plotby, levels=c("positive_sig10","positive_sig05", "negative_sig05", "negative_sig10"),labels = c("positive &\n0.05>p<0.10", "positive &\np<0.05", "negative &\n0.05>p<0.10", "negative &\np<0.05"), ordered=T)


sea.init.combo.post <- ggplot(sea.initiation.summary.post, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c('#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.position="none")+ylab("Count of sites")

sea.cess.combo.post <- ggplot(sea.cessation.summary.post, aes(x=lag, y=value,fill=plotby))+geom_bar(stat="identity")+scale_fill_manual(values=c( '#92c5de', '#0571b0', '#f4a582','#ca0020'))+scale_y_continuous(limits=c(-4, 8),breaks=c(-4, -2, 0, 2, 4,6,8), labels=c(4, 2, 0, 2,4,6,8))+geom_hline(yintercept=0)+theme(legend.position="none")


Fig.file <- here("Results", "Figures", "SEA-combo-site-timeperiod.jpg")
jpeg(Fig.file, width=fig.width2, height=4, units="in", res=300)
sea.init.combo+theme(axis.text.x=element_blank(), axis.title.x=element_blank(), legend.title=element_blank())+labs(title = "A - Initiation (all years)")+sea.init.combo.pre+ theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank(), legend.title=element_blank())+labs(title = "B - Initiation (1750-1849)")+ sea.init.combo.post+ theme(axis.text.x=element_blank(), axis.title.x=element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank(), legend.title=element_blank())+labs(title = "C - Initiation (1890-1989)") + sea.cess.combo +theme(legend.title=element_blank())+xlab("lag (years)")+ labs(title = "D - Cessation (all years)", y="Count of sites") + sea.cess.combo.pre +xlab("lag (years)")+ theme(axis.text.y = element_blank(), axis.title.y = element_blank(), legend.title=element_blank())+labs(title = "E - Cessation (1750-1849)") + sea.cess.combo.post+xlab("lag (years)")+labs(title = "F - Cessation (1890-1989)")+ theme(axis.text.y = element_blank(), axis.title.y = element_blank(), legend.title=element_blank()) + plot_layout(nrow=2) + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
whatever <- dev.off()
```

```{r sea.regional}
pdsi.out.avg <- pdsi.out %>% filter(year>=1730 & year <=2020) %>% dplyr::select(AVG)
row.names(pdsi.out.avg) <- 1730:2020
sea.initiation.regional <- sea(x=pdsi.out.avg, key=regional.outbreaks.sum[regional.outbreaks.sum$start>1730,]$start, lag=5)
sea.initiation.regional$sig <- cut(sea.initiation.regional$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

sea.cessation.regional <- sea(x=pdsi.out.avg, key=regional.outbreaks.sum[regional.outbreaks.sum$start>1730,]$end, lag=5)
sea.cessation.regional$sig <- cut(sea.cessation.regional$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

p1 <- ggplot(sea.initiation.regional, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"),drop=F)+ylab("JJA SC-PDSI")+xlab("lag (years)")+labs(title = "A - Initiation")

p2 <- ggplot(sea.cessation.regional, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"),drop=F)+ylab("JJA PDSI")+xlab("lag (years)")+labs(title = "B - Cessation")

Fig.file <- here("Results", "Figures", "SEA-Regional.jpg")
jpeg(Fig.file, width=fig.width1.5, height=3, units="in", res=300)
p1+ylim(-1.5,2.5)+ p2+ylim(-1.5,2.5) + theme(axis.title.y = element_blank(), axis.text.y = element_blank()) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
whatever <- dev.off()


pdsi.out.avg.1750.1849 <- pdsi.out %>% filter(year>=1750 & year <=1849) %>% dplyr::select(AVG)
row.names(pdsi.out.avg.1750.1849 ) <- 1750:1849
sea.initiation.regional.1750.1849  <- sea(x=pdsi.out.avg.1750.1849, key=regional.outbreaks.sum[regional.outbreaks.sum$start>=1750 & regional.outbreaks.sum$start<=1849, ]$start, lag=5)
sea.initiation.regional.1750.1849$sig <- cut(sea.initiation.regional.1750.1849$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

sea.cessation.regional.1750.1849  <- sea(x=pdsi.out.avg.1750.1849, key=regional.outbreaks.sum[regional.outbreaks.sum$start>=1750 & regional.outbreaks.sum$start<=1849, ]$end, lag=5)
sea.cessation.regional.1750.1849$sig <- cut(sea.cessation.regional.1750.1849$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

p1.1750.1849 <- ggplot(sea.initiation.regional.1750.1849, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"), drop=F)+ylab("JJA SC-PDSI anomaly")+xlab("lag (years)")+labs(title = "A - Initiation")

p2.1750.1849 <- ggplot(sea.cessation.regional.1750.1849, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"), drop=F)+ylab("JJA PDSI anomaly")+xlab("lag (years)")+ labs(title = "B - Cessation")


pdsi.out.avg.1890.1989 <- pdsi.out %>% filter(year>=1890 & year <=1989) %>% dplyr::select(AVG)
row.names(pdsi.out.avg.1890.1989 ) <- 1890:1989
sea.initiation.regional.1890.1989  <- sea(x=pdsi.out.avg.1890.1989, key=regional.outbreaks.sum[regional.outbreaks.sum$start>=1890 & regional.outbreaks.sum$start<=1989, ]$start, lag=5)
sea.initiation.regional.1890.1989$sig <- cut(sea.initiation.regional.1890.1989$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

sea.cessation.regional.1890.1989  <- sea(x=pdsi.out.avg.1890.1989, key=regional.outbreaks.sum[regional.outbreaks.sum$start>=1890 & regional.outbreaks.sum$start<=1989, ]$end, lag=5)
sea.cessation.regional.1890.1989$sig <- cut(sea.cessation.regional.1890.1989$p, breaks=c(0,0.05, 0.1, 1), labels=c("p<0.05", "0.05>p<0.10", "p>0.1"), include.lowest=T)

p1.1890.1989 <- ggplot(sea.initiation.regional.1890.1989, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"), drop=F)+ylab("JJA SC-PDSI anomaly")+xlab("lag (years)")+labs(title = "A - Initiation")

p2.1890.1989 <- ggplot(sea.cessation.regional.1890.1989, aes(x=lag, y=se.unscaled, fill=sig))+geom_bar(stat="identity")+theme(legend.position="bottom", legend.title=element_blank())+scale_fill_manual(values=c("black","grey30", "lightgrey"), drop=F)+ylab("JJA PDSI anomaly")+xlab("lag (years)")+labs(title = "B - Cessation")

Fig.file <- here("Results", "Figures", "SEA-Regional-time.jpg")
jpeg(Fig.file, width=7, height=4, units="in", res=300)
p1+ylim(-3,4)+labs(title = "A - Initiation (all years)")+theme(axis.title.x = element_blank(), axis.text.x = element_blank())+p1.1750.1849+ylim(-3,4)+labs(title= "B - Initiation (1750-1849)")+theme(axis.title.y=element_blank(), axis.text.y=element_blank(),axis.title.x = element_blank(), axis.text.x = element_blank())+p1.1890.1989+ylim(-3,4)+labs(title= "C - Initiation (1890-1989)")+theme(axis.title.y=element_blank(), axis.text.y=element_blank(),axis.title.x = element_blank(), axis.text.x = element_blank())+ p2+ylim(-3,4)+labs(title = "D - Cessation (all years)")+ p2.1750.1849+ylim(-3,4)+labs(title= "E - Cessation (1750-1849)")+theme(axis.title.y=element_blank(), axis.text.y=element_blank())+ p2.1890.1989+ylim(-3,4)+labs(title= "F - Cessation (1890-1989)")+theme(axis.title.y=element_blank(), axis.text.y=element_blank())+theme(axis.title.y = element_blank(), axis.text.y = element_blank()) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
whatever <- dev.off()

```

To determine if the effect of climate on WSB outbreak dynamics depended upon site aridity, we used similar linear regression to to model the departure from the SC-PDSI value as a function of site CWD normals. We constructed separate models for years of outbreak initiation and cessation and for each lag (i.e., -5 to 5 years) for a total of 22 models.

```{r sea.cwd}
sea.cwd <- left_join(sea.initiation.df, host.sites.sub, by="SeriesCode")
res <- data.frame(lag=unique(sea.cwd$lag), coefficient=NA, std.error=NA,  p.value=NA)
for(j in sea.cwd$lag){
  sea.cwd.lag <- sea.cwd %>% filter(lag==j)
  lm.lag <- lm(se~CWD, data=sea.cwd.lag) %>% summary()
  res[res$lag==j, ]$coefficient <- lm.lag$coefficients[2,1]
  res[res$lag==j, ]$std.error <- lm.lag$coefficients[2,2]
  res[res$lag==j, ]$p.value <- lm.lag$coefficients[2,4]
}
sea.cwd.res.initiation <- res
sea.cwd$sig.plot <- "p>=0.1"
sea.cwd[sea.cwd$lag=="-1", ]$sig.plot <- "p>=0.1"
sea.cwd.initiation <- sea.cwd
sea.cwd.initiation$col <- ifelse(sea.cwd.initiation$se<0, "negative", "positive")

sea.cwd <- left_join(sea.cessation.df, host.sites.sub, by="SeriesCode")
res <- data.frame(lag=unique(sea.cwd$lag), coefficient=NA, std.error=NA,  p.value=NA)
for(j in sea.cwd$lag){
  sea.cwd.lag <- sea.cwd %>% filter(lag==j)
  lm.lag <- lm(se~CWD, data=sea.cwd.lag) %>% summary()
  res[res$lag==j, ]$coefficient <- lm.lag$coefficients[2,1]
  res[res$lag==j, ]$std.error <- lm.lag$coefficients[2,2]
  res[res$lag==j, ]$p.value <- lm.lag$coefficients[2,4]
}
sea.cwd.res.cessation <- res
sea.cwd$sig.plot <- "p>=0.1"
sea.cwd[sea.cwd$lag=="-1", ]$sig.plot <- "p<0.1"
sea.cwd.cessation <- sea.cwd
sea.cwd.cessation$col <- ifelse(sea.cwd.cessation$se<0, "negative", "positive")

p1 <- ggplot(sea.cwd.res.initiation,aes(x=lag,y=coefficient))+geom_bar(stat="identity")+ylim(-0.0025,0.002)
p2 <- ggplot(sea.cwd.res.cessation,aes(x=lag,y=coefficient))+geom_bar(stat="identity")+ylim(-0.0025,0.002)


p3 <- ggplot(sea.cwd.initiation, aes(x=CWD, y=se))+geom_smooth(method="lm",level=0.95, col="black")+geom_point(col="#0571b0", size=0.5)+facet_wrap(~lag, nrow=4)+scale_fill_manual(values=c( "lightgray"))+theme(legend.position = "none")+ylab("JJA SC-PDSI")+ylim(-1.5, 1.5)+labs(title = "A - Initiation")+geom_hline(yintercept=0, lty=2)

p4 <- ggplot(sea.cwd.cessation, aes(x=CWD, y=se))+geom_smooth(method="lm",level=0.95, col="black")+geom_point(col="#0571b0", size=0.5)+facet_wrap(~lag, nrow=4)+scale_fill_manual(values=c( "lightgray"))+theme(legend.position = "none", axis.title.y=element_blank(), axis.text.y=element_blank())+ylab("SC-PDSI anomaly")+ylim(-1.5, 1.5)+labs(title = "B - Cessation")+geom_hline(yintercept=0, lty=2)

Fig.file <- here("Results", "Figures","SEA-Combo-CWD.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
p3+p4
whatever <- dev.off()
```

To determine if the duration or severity of multi-year drought (i.e., negative SC-PDSI) or wet periods (i.e., positive SC-PDSI) were important in WSB outbreak dynamics, we first determined periods of drought and wet periods for each site-level SC-PDSI record. For each site-level outbreak event, we then determined the period of drought prior to outbreak initiation, the wet period concurrent with initiation, wet period concurrent with outbreak cessation, and dry period following outbreak cessation. For each of these periods, we then calculated the duration and mean and extreme SC-PDSI value (i.e., greatest PDSI value for wet periods and lowest SC-PDSI value for droughts). We then used a t-test to compare these values with expected values, which were generated from the periods of drought and wet periods present in the entire time series.

```{r PDSIperiod}
pdsi.out$drought <- ifelse(pdsi.out$AVG>=0, 1, -1) 
start.year <- pdsi.out %>% na.omit() %>% filter(drought==1) %>% pull(year) %>% min()
pdsi.sub <- pdsi.out %>% filter(year>=start.year)
res <- data.frame(start=NA, end=NA, mean=NA, max=NA,start.pre=NA, end.pre=NA, mean.pre=NA, min.pre=NA, start.post=NA, end.post=NA, mean.post=NA, min.post=NA)
for(j in pdsi.sub$year[-1]){
  if(pdsi.sub %>% filter(year==j) %>% pull(drought) == 1){
    if(pdsi.sub %>% filter(year==(j-1)) %>% pull(drought) == -1){
      pdsi.subj <- pdsi.sub %>% filter(year>=j)
      if(!is.na(max(res$end))){
        end.j <- pdsi.subj %>% filter(drought==-1) %>% filter(year>max(res$end)) %>% pull(year) %>% min()
        mean.j <- pdsi.sub %>% filter(year %in% j:(end.j-1)) %>% pull(AVG) %>% mean()
        max.j <- pdsi.sub %>% filter(year%in% j:(end.j-1)) %>% pull(AVG) %>% max()
        drought.start <- pdsi.sub %>% filter(year<j) %>% filter(drought==1) %>% max() +1
        drought.mean <- pdsi.sub %>% filter(year %in% drought.start:(j-1)) %>% pull(AVG) %>% mean()
        drought.min <- pdsi.sub %>% filter(year %in% drought.start:(j-1)) %>% pull(AVG) %>%  min()
        post.start <- end.j
        post.end <- pdsi.subj %>% filter(year>post.start & drought==1) %>% pull(year) %>% min()
          if(!is.infinite(post.end)){
            post.mean <- pdsi.sub %>% filter(year %in% post.start:(post.end-1)) %>% pull(AVG) %>%  mean()
            post.min <- pdsi.sub %>% filter(year %in% post.start:(post.end-1)) %>% pull(AVG) %>%  min()
          }else{
            post.mean <- NA
            post.min < - NA
          }
     }else{
     end.j <- pdsi.subj %>% filter(drought==-1) %>% pull(year) %>% min()
     mean.j <- pdsi.sub %>% filter(year %in% j:(end.j-1)) %>% pull(AVG) %>% mean()
     max.j <- pdsi.sub %>% filter(year%in% j:(end.j-1)) %>% pull(AVG) %>% max()
     drought.start <- pdsi.sub %>% filter(year<j) %>% filter(drought==1) %>% max() +1
     drought.mean <- pdsi.sub %>% filter(year %in% drought.start:(j-1)) %>% pull(AVG) %>%  mean()
     drought.min <- pdsi.sub %>% filter(year %in% drought.start:(j-1)) %>% pull(AVG) %>%  min()
     post.start <- end.j
     post.end <- pdsi.subj %>% filter(year>post.start & drought==1) %>% pull(year) %>% min()
       if(!is.infinite(post.end)){
          post.mean <- pdsi.sub %>% filter(year %in% post.start:(post.end-1)) %>% pull(AVG) %>%  mean()
          post.min <- pdsi.sub %>% filter(year %in% post.start:(post.end-1)) %>% pull(AVG) %>%  min()
        }else{
          post.mean <- NA
          post.min < - NA
        }
      }
      res <- rbind(res, c(j, (end.j-1), mean.j, max.j, drought.start, (j-1), drought.mean, drought.min, post.start, post.end, post.mean, post.min))
    }
  }
}
res$duration <- res$end - res$start +1
res$duration.pre <- res$end.pre - res$start.pre +1
res$duration.post <- res$end.post - res$start.post +1
res$year <- res$start

res.initiation <- left_join(regional.outbreaks, res, by='year')
res.initiation <- res.initiation %>% mutate(start=na.locf(start, na.rm=F), end=na.locf(end, na.rm=F), duration=na.locf(duration, na.rm=F), mean=na.locf(mean, na.rm=F), max=na.locf(max, na.rm=F),start.pre=na.locf(start.pre, na.rm=F), end.pre=na.locf(end.pre, na.rm=F),duration.pre=na.locf(duration.pre, na.rm=F), mean.pre=na.locf(mean.pre, na.rm=F), min.pre=na.locf(min.pre, na.rm=F), start.post=na.locf(start.post, na.rm=F), end.post=na.locf(end.post, na.rm=F),duration.post=na.locf(duration.post, na.rm=F), mean.post=na.locf(mean.post, na.rm=F), min.post=na.locf(min.post, na.rm=F))

regional.outbreaks.sum$year <- regional.outbreaks.sum$start
regional.outbreaks.sum$var <- "initiation"
res.initiation <- left_join(regional.outbreaks.sum[,c("year", "var")], res.initiation, by='year')
res.initation <- res.initiation[,colnames(res)]
res.initation$plotby <- "outbreak"

all <- res
all$plotby <- "all years"

rall <- rbind(res.initation, all)
rall <- rall %>% filter(year>=1730) %>% dplyr::select(start:plotby) %>% pivot_longer(mean:duration.post) %>% filter(!name %in% c("start.pre", "end.pre"))

rall$x <- factor(rall$name, levels=c("mean", "max", "mean.pre", "min.pre", "duration", "duration.pre", "mean.post", "min.post", "duration.post"), labels=c("wet period concurrent with outbreak initiation", "wet period concurrent with outbreak initiation", "dry period prior to outbreak initiation", "dry period prior to outbreak initiation", "wet period concurrent with outbreak initiation","dry period prior to outbreak initiation", "dry period following outbreak initiation","dry period following outbreak initiation","dry period following outbreak initiation"))

rall$var <- factor(rall$name, levels=c("mean", "max", "mean.pre", "min.pre", "duration", "duration.pre", "mean.post", "min.post", "duration.post"), labels=c("mean JJA SC-PDSI", "extreme JJA SC-PDSI", "mean JJA SC-PDSI", "extreme JJA SC-PDSI", "duration (years)","duration (years)", "mean JJA SC-PDSI","extreme JJA SC-PDSI","duration (years)"))
rall[is.infinite(rall$value)==TRUE,]$value <- NA

results.timeperiod <- expand.grid(variable=na.omit(unique(rall$var)), period=na.omit(unique(rall$x)))
results.timeperiod $p.value <- NA
results.timeperiod $t <- NA
for(j in na.omit(unique(rall$var))){
  for(k in na.omit(unique(rall$x))){
   rall.jk <-  rall %>%  filter(var==j & x ==k)
   #rall.jk <- na.omit(rall.jk[,c("plotby", "value")])
   t.jk <- t.test(rall.jk[rall.jk$plotby=="outbreak",]$value, rall.jk[rall.jk$plotby=="all years",]$value)
   results.timeperiod [results.timeperiod $variable==j & results.timeperiod$period==k, ]$t <-  round(t.jk$statistic,2)
   results.timeperiod [results.timeperiod $variable==j & results.timeperiod$period==k, ]$p.value <- round( t.jk$p.value,2)
  }
}
results.timeperiod $event <- "initation"

rall$x <- factor(rall$x,  levels=c("dry period prior to outbreak initiation","wet period concurrent with outbreak initiation", "dry period following outbreak initiation"), labels=c("dry period prior\nto outbreak initiation","wet period concurrent\nwith outbreak initiation","dry period following \noutbreak initiation"), ordered=T)


p1 <- rall %>% filter(var=="mean JJA SC-PDSI" & x %in% c("dry period prior\nto outbreak initiation", "wet period concurrent\nwith outbreak initiation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2", width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("mean JJA SC-PDSI")
p2 <- rall %>% filter(var=="extreme JJA SC-PDSI" & x %in% c("dry period prior\nto outbreak initiation", "wet period concurrent\nwith outbreak initiation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2",width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("extreme JJA SC-PDSI")
p3 <- rall %>% filter(var=="duration (years)" & x %in% c("dry period prior\nto outbreak initiation", "wet period concurrent\nwith outbreak initiation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2",width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("duration (years)")+
  scale_y_continuous( breaks=pretty_breaks())

# Cessation
res.cessation <- left_join(regional.outbreaks, res, by='year')
res.cessation <- res.cessation %>% mutate(duration=na.locf(duration, na.rm=F), mean=na.locf(mean, na.rm=F), max=na.locf(max, na.rm=F),duration.pre=na.locf(duration.pre, na.rm=F), mean.pre=na.locf(mean.pre, na.rm=F), min.pre=na.locf(min.pre, na.rm=F), duration.post=na.locf(duration.post, na.rm=F), mean.post=na.locf(mean.post, na.rm=F), min.post=na.locf(min.post, na.rm=F))

regional.outbreaks.sum$year <- regional.outbreaks.sum$end
regional.outbreaks.sum$var <- "cessation"
res.cessation <- left_join(regional.outbreaks.sum[,c("year", "var")], res.cessation, by='year')
res.cessation <- res.cessation[,colnames(res)]
res.cessation$plotby <- "outbreak"

all <- res
all$plotby <- "all years"

rall <- rbind(res.cessation, all)
rall <- rall %>% filter(year>=1730) %>% dplyr::select(start:plotby) %>% pivot_longer(mean:duration.post) %>% filter(!name %in% c("start.pre", "end.pre"))

rall$x <- factor(rall$name, levels=c("mean", "max", "mean.pre", "min.pre", "duration", "duration.pre", "mean.post", "min.post", "duration.post"), labels=c("wet period concurrent with outbreak cessation", "wet period concurrent with outbreak cessation", "dry period prior to outbreak cessation", "dry period prior to outbreak cessation", "wet period concurrent with outbreak cessation", "dry period prior to outbreak cessation", "dry period following outbreak cessation","dry period following outbreak cessation","dry period following outbreak cessation"))
rall$var <- factor(rall$name, levels=c("mean", "max", "mean.pre", "min.pre", "duration", "duration.pre", "mean.post", "min.post", "duration.post"), labels=c("mean JJA SC-PDSI", "extreme JJA SC-PDSI", "mean JJA SC-PDSI", "extreme JJA SC-PDSI", "duration (years)","duration (years)", "mean JJA SC-PDSI","extreme JJA SC-PDSI","duration (years)"))
rall[is.infinite(rall$value)==TRUE,]$value <- NA
results.timeperiod2 <- expand.grid(variable=na.omit(unique(rall$var)), period=na.omit(unique(rall$x)))
results.timeperiod2$p.value <- NA
results.timeperiod2$t <- NA
for(j in na.omit(unique(rall$var))){
  for(k in na.omit(unique(rall$x))){
   rall.jk <-  rall %>%  filter(var==j & x ==k)
   #rall.jk <- na.omit(rall.jk[,c("plotby", "value")])
   t.jk <- t.test(rall.jk[rall.jk$plotby=="outbreak",]$value, rall.jk[rall.jk$plotby=="all years",]$value)
   results.timeperiod2[results.timeperiod2$variable==j & results.timeperiod2$period==k, ]$t <-  round(t.jk$statistic,2)
   results.timeperiod2[results.timeperiod2$variable==j & results.timeperiod2$period==k, ]$p.value <- round( t.jk$p.value,2)
  }
}
results.timeperiod2$event <- "cessation"
  

rall$x <- factor(rall$x, levels=c("dry period prior to outbreak cessation","wet period concurrent with outbreak cessation","dry period following outbreak cessation"), labels=c("dry period prior\nto outbreak cessation","wet period concurrent\nwith outbreak cessation","dry period following\noutbreak cessation"), ordered=T)

p4 <- rall %>% filter(var=="mean JJA SC-PDSI" & x %in% c("wet period concurrent\nwith outbreak cessation", "dry period following\noutbreak cessation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2", width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("mean JJA SC-PDSI")
p5 <- rall %>% filter(var=="extreme JJA SC-PDSI" & x %in% c("wet period concurrent\nwith outbreak cessation", "dry period following\noutbreak cessation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2",width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("extreme JJA SC-PDSI")
p6 <- rall %>% filter(var=="duration (years)" & x %in% c("wet period concurrent\nwith outbreak cessation", "dry period following\noutbreak cessation")) %>%  ggplot(aes(x=plotby,y=value))+geom_boxplot()+geom_jitter(col="#0072B2",width=0.1, size=.5)+facet_wrap(~x, scales="free_y", nrow=1)+theme(axis.title.x = element_blank())+ylab("duration (years)")+
  scale_y_continuous( breaks=pretty_breaks())

Fig.file <- here("Results", "Figures","outbreak-PDSIperiod.jpg")
jpeg(Fig.file, width=fig.width2, height=5, units="in", res=300)
p1+theme(axis.text.x=element_blank())+p4+theme(axis.title.y=element_blank(),axis.text.x=element_blank())+p2+p5+theme(axis.title.y=element_blank())+p3+p6+theme(axis.title.y=element_blank())+plot_layout(nrow=3)
whatever <- dev.off() 

```

# Results

## Outbreak reconstruction summary

Using the combined tree-ring and geospatial datasets, we were able to reconstruct a total of `r outbreak.summary.tab %>% pull(no.outbreaks) %>% sum()` WSB outbreaks at `r outbreak.summary.tab %>% nrow()` sites (Table \@ref(tab:outbreaksummary); Figure \@ref(fig:FigOutbreakHistory)). The `r outbreak.summary.tab %>% nrow()` outbreak reconstructions have starting dates between 1637 and 1743 and ending dates between 2001 and 2020, with at least 50% of the sites records extending to 1730. All outbreak events occurred prior to 1996 and thus appear only in the dendrochronological record. Most sites experienced about five outbreaks, however one site experienced only two outbreaks and two sites experienced eight outbreak events. Outbreak duration at a site ranged from `r host.outbreak.stats.df %>% pull(duration) %>% min()` to `r host.outbreak.stats.df %>% pull(duration) %>% max()` years, with an average outbreak at a given site lasting for `r outbreak.summary.tab %>% pull(dur) %>% min()` to `r outbreak.summary.tab %>% pull(dur) %>% max()` years. At the site-level the average quiescent period ranged from `r outbreak.summary.tab %>% pull(q) %>% min()` to `r outbreak.summary.tab %>% pull(q) %>% max()` years.

```{r outbreaksummary, results='show'}
ft <- flextable(outbreak.summary.tab.print)
ft <- set_caption(ft, caption="Summary of outbreak characteristics. The quiescent period length was calculated as the number of years between outbreak cessation and the initiation of a subsequent oubtkreak.")
ft %>% autofit() %>% fit_to_width(7.5)
```

\pagebreak

```{r, FigOutbreakHistory, fig.cap="Variability of the self-calibrated Palmer Drought Severity Index (SC-PDSI) (A) and WSB outbreaks by site (B) and across the region (C). In panel (A) the thin black line shows a tree-ring based reconstruction of SC-PDSI, while the thick blue line shows a 10-year rolling mean of that time series. In C, the bars show the number of sites recording an outbreak and the dashed line shows the the number of potential tree-ring recording sites. In all panels, periods of regional outbreak are highlighted by light gray shading.", out.width = "504pt", results="show"}
pdsi.out$PDSIroll <- rollapply(pdsi.out$AVG, align="center", width=10, FUN="mean", fill=NA)
p1 <- ggplot(pdsi.out, aes(x=year, y=AVG))+geom_line()+geom_line(aes(y=PDSIroll, x=year), col="blue", linewidth=1.1)+ geom_rect(data=regional.outbreaks.sum, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start, xmax = end), alpha = 0.2, fill = "gray20")+geom_hline(yintercept=0)+xlim(1666,2021)+ylab("SC-PDSI")

p2 <- ggplot(host.outbreak.stats.df, aes(x=start, xend=end, y=SeriesCode, yend=SeriesCode))+geom_segment()+ylab("Site")+xlab("Year")+xlim(1666,2021)+ geom_rect(data=regional.outbreaks.sum, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start, xmax = end), alpha = 0.2, fill = "gray20")

p3 <- ggplot(regional.outbreaks, aes(x=year))+geom_bar(aes(y=noutbreaks), stat="identity",width=1)+geom_line(aes(y=nsites), linetype="dashed")+theme(legend.position = "bottom", legend.title = element_blank())+xlim(1666,2021)+ geom_rect(data=regional.outbreaks.sum, inherit.aes=FALSE, aes(ymin = -Inf, ymax = Inf, xmin = start, xmax = end), alpha = 0.2, fill = "gray20")+scale_y_continuous(name="number of sites",breaks=c(0,5,10))

Fig.file <- here("Results", "Figures", "OutbreakHistory-Combo.jpg")
jpeg(Fig.file, width=fig.width2, height=5.5, units="in", res=300)
p1 + theme(axis.title.x = element_blank(), axis.text.x=element_blank())+ p2+ theme(axis.title.x = element_blank(), axis.text.x=element_blank()) +p3 +plot_layout(nrow=3, heights=c(0.9, 1.5, 0.9)) +plot_annotation(tag_levels = "A")
whatever <- dev.off()


knitr::include_graphics(here("Results", "Figures", "OutbreakHistory-Combo.jpg"))
```

## Synchrony of outbreaks

We found that sites across the study area exhibited similar temporal patterns of WSB outbreak (Fig. \@ref(fig:FigOutbreakHistory) and Fig. \@ref(fig:FigPercDefol)). Over the 1730-1998 period, time series of the percent of trees defoliated at a site were significantly correlated (W = `r kendalls.w %>% filter(subset=="1730-1998") %>% pull(W)`; p `r kendalls.w %>% filter(subset=="1730-1998") %>% pull(p.value)`; mean inter-site r~s~ = `r kendalls.w %>% filter(subset=="1730-1998") %>% pull(r.mean)`; mean inter-site C= `r round(peakz.mean[1],2)*100`%). However, relationships between some pairs of sites were neutral or even negative (range of. inter-site r~s~: `r kendalls.w %>% filter(subset=='1730-1998') %>% pull(r.min) %>% round(2)` - `r kendalls.w %>% filter(subset=='1730-1998') %>% pull(r.max) %>% round(2)`; range of inter-site C: `r peakz[[1]][-1][upper.tri(peakz[[1]][-1])] %>% min() %>% round(2)` - `r peakz[[1]][-1][upper.tri(peakz[[1]][-1])] %>% max() %>% round(2)`), highlighting site-level variation in outbreak dynamics across the study area (Fig. \@ref(fig:FigPairwiseCor)). The spatial dependence of time-series covariance among records of the percent of trees defoliated indicated that significant sychrony existed at distances up to 50 km and that synchrony decreased with increasing distance (Fig. \@ref(fig:FigCovariance)).

```{r FigCovariance, fig.cap="Nonparametric spatial covariance function describing the covarinace among records of the percent of trees defoliated at all 12 sites across study area over the 1730-1998 period. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony).", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance.jpg"))
```

Multivariate event analysis indicated that both years of initiation and cessation were significantly clustered in time, with a higher degree of synchrony for cessation dates (Fig. \@ref(fig:FigMEA)). Years of outbreak initiation were more likely than not to occur within six years of another year of outbreak initiation, while years of outbreak cessation were more likely than not to occur within eight years of another year of outbreak cessation. At lags greater than 14 years, years of outbreak cessation were significantly asynchronous.

```{r FigMEA, fig.cap="Bidirectional multivariate event analysis of temporal synchrony between dates of WSB outbreak initation (A) and cessation (B) at 12 sites over the 1730-2020 period. The solid black line is the L(t) function, a transformation of Ripley’s K such that the mean and variance are stabilized through time t, where values >0 indicate synchrony and values <0 indicate asynchrony. The dashed lines indicate 95% confidence interval.", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "MEA.jpg"))
```

## Effects of Euro-American settlement on outbreak dynamics or effects

We found that Euro-American settlement had little effect on outbreak dynamics or severity at the site-level, but reduced regional synchrony. In the century prior to extensive Euro-American settlement, outbreaks occurred about as frequently but were slightly longer and more severe relative to the century following extensive Euro-American settlement (Fig. \@ref(fig:FigColonization)). However, these differences were not significantly different (Table \@ref(tab:colonizationtab)).

```{r FigColonization, fig.cap="The proportion of years affected by WSB outbreak (A), the duration of outbreak (B), the length of the quiescent period (C), the minimum normalized growth suppression index (D), and the duration of outbreak (E) for the century prior to and proceeding extensive Euro-American colonization (1750-1849 and 1890-1989, respectively). In A, the sample sizes printed above bars show the number of total outbreaks recorded at any site during that period. For boxplots, the bottom and top limits of each box are the lower and upper quartiles, respectively; the thick black line within the box is the median; error bars equal ±1.5 times the interquartile range; and points denote outliers, values outside ±1.5 times the interquartile range.", out.width = "504.8pt", results="show"}

knitr::include_graphics(here("Results", "Figures", "Colonization.jpg"))
```

While outbreak dynamics and effects were similar in the two time periods, regional synchrony was lower in the 1890-1989 period than the 1750-1849 period. The mean inter-site correlation was `r round((spearmans.time$estimate[2]- spearmans.time$estimate[1])/spearmans.time$estimate[2] *100, 0)`% lower in the century following century following extensive Euro-American settlement (mean r~s~ for 1750-1859: `r round(spearmans.time$estimate[2], 2)` and mean r~s~ for 1890-1989: `r round(spearmans.time$estimate[1], 2)`; t=`r round(spearmans.time$statistic, 1)`, p=`r round(spearmans.time$p.value, 2)`) and the mean inter-site concurrency was `r round((peakz.time$estimate[2]- peakz.time$estimate[1])/ peakz.time$estimate[2]*100, 0)`% lower (mean C for 1750-1859: `r round(peakz.time$estimate[2], 3)` and mean C for 1890-1989: `r round(peakz.time$estimate[1], 2)`; t=`r round(peakz.time$statistic, 1)`, p\<0.001). While regional synchrony was lower in the 1890-1989 period, spline correlograms calculated for the 1750-1849 and 1890-1989 time periods showed similar decreases in sychrony with increasing distances as the the 1750-1998 period (Fig. \@ref(fig:FigCovarianceTime)).

## Association between interannual climate variability and outbreaks

Over the 1730-2020, we found periods of regional outbreak were associated with interannual variability in moisture availability, as quantified using the SC-PDSI (Figure \@ref(fig:FigOutbreakHistory)). During periods of outbreak the mean SC-PDSI was greater in quiescent periods than during periods of outbreak (mean SC-PDSI~outbreak~:`r xt$estimate[1] %>% round(2)`; mean SC-PDSI~no outbreak~:`r xt$estimate[2] %>% round(2)`; t = `r xt$statistic %>% round(2)`; p = `r xt$p.value %>% round(3)`). This pattern of greater SC-PDSI in periods of outbreak was apparent in both the century prior to and following extensive Euro-American settlement, although the effect was not significant during the 1890-1989 period (Figure \@ref(fig:FigPDSIbyTimePeriod)).

At the site-level, superposed epoch analyses showed outbreaks were generally more likely to initiate during periods of above-average moisture availability (i.e., positive SC-PDSI), particularly when proceeded by periods of average or below-average moisture availability (Fig. \@ref(fig:FigSEASiteCombo)A and Fig. \@ref(fig:FigSEASiteInitiation)). Outbreaks cessation generally coincided with a switch from above average moisture availability to average or below average moisture availability (Fig. \@ref(fig:FigSEASiteCombo)B and Fig. \@ref(fig:FigSEASiteCessation)). Superposed epoch analyses conducted using the regional record confirmed that periods of outbreak coincided with periods of elevated moisture availability (Fig. \@ref(fig:FigSEARegional)). However, there was less evidence for drought proceeding and following outbreaks. Analyses conducted using data from the century prior to and following Euro-American colonization also showed similar results, however during the 1890-1989 period outbreak initiation events were significantly associated with SC-PDSI at fewer sites (Fig. \@ref(fig:FigSEASiteComboTime)).

```{r FigSEASiteCombo, fig.cap="Summary of site-level superposed epoch analyses summarzing the association between summer SC-PDSI and outbreak initation (A) and cessation (B) over the 1730-2020 period. Red descending bars illustrate the number of sites with a statitcally significant negative association with summer SC-PDSI (i.e., drier conditions), blue ascending bars show the number of sites with a statistically significant positive association with summer SC-PDSI (i.e., wetter conditions).", out.width = "323pt", results="show"}

knitr::include_graphics(here("Results", "Figures","SEA-combo-site.jpg"))
```

```{r FigSEARegional, fig.cap="Superposed epoch analysis results illustrating the departure from the mean SC-PDSI for the years prior, during, and following regional outbreak years over the 1730-2020 period. Descending bars illustrate a negative association with summer SC-PDSI (i.e., drier conditions), ascending bars show a positive association with summer SC-PDSI (i.e., wetter conditions).", out.width = "323pt", results="show"}
 
knitr::include_graphics(here("Results", "Figures", "SEA-Regional.jpg"))
```

We found no significant effect of site aridity (i.e., mean annual CWD) on the association between SC-PDSI and outbreak initiation or cessation (Fig. \@ref(fig:FigSEACWD); Table \@ref(tab:icwdtab) - \@ref(tab:ccwdtab)). However, there was a weak (r=`r sea.cwd.res.cessation %>% filter(lag==-1) %>% pull(coefficient) %>% round(3)` ; p=`r sea.cwd.res.cessation %>% filter(lag==-1) %>% pull(p.value) %>% round(3)`) negative association between site aridity and the mean SC-PDSI in the year proceeding outbreak cessation.

```{r FigSEACWD, fig.cap="Linear regressions between site climatic water deficit (CWD) and mean summer SC-PDSI for the years prior, during, and following outbreak initiation (A) and cessation (B) for the 1730-2020 period. Shading illustrates the 95% confidence interval around the regression.", out.width = "7in", results='show'}
knitr::include_graphics(here("Results", "Figures", "SEA-Combo-cwd.jpg"))
```

Finally, we found that periods of regional outbreak coincided with longer periods of above average moisture availability (mean duration for periods of regional outbreak = 5.7 years; mean for all periods of above average moisture availability = 1.8 years; Fig. \@ref(fig:FigPDSIperiod)). In general these periods were characterized by higher mean JJA SC-PDSI and higher maximum values of JJA SC-PDSI than the average periods of above average JJA SC-PDSI (Fig. \@ref(fig:FigPDSIperiod)).

# Discussion

Here we combined tree-ring and geospatial data to reconstruct periods of WSB outbreak at 12 sites across northern to central Colorado. Notably our results show that (1) WSB outbreaks occur synchronously across sites, suggestive of a regional driver and (2) outbreaks were often initiated by a period of above-average moisture availability that was often proceeded by drought.

## Outbreak histories

We found that periods of regional outbreak occurred from 1761 to 1770, 1792 to 1800, 1833 to 1844, 1890 to 1894, 1897 to 1908, 1920 to 1924, and 1986 to 1990. Notably, all of these periods correspond with periods of outbreak identified in dendroecological studies from Colorado (Table \@ref(tab:historytab)). Further the 1980s outbreak is well documented in observational records from Colorado [@hadleyStandResponseWestern1993; @weber1995DendroecologicalReconstructionWestern] and the 1920s outbreak and is supported by reports from forest entomologists working in northern Idaho and Yellowstone National Park, where observational records of WSB outbreaks began much earlier than in Colorado [@johnson1975OutbreaksWesternSpruce]. This agreement between existing tree-ring and observational records confirms that tree-ring data can provide insights into periods of past WSB outbreak [@swetnam1989].

Across all our sites the mean outbreak duration (`r host.outbreak.stats.df %>% pull(duration) %>% mean() %>% round(1)` years) and mean length of the quiescent period (`r host.outbreak.stats.df %>% pull(q) %>% mean(na.rm=T) %>% round(1)` years) were similar to those previously reported in dendroecological studies conducted in interior Pacific Northwest [mean duration: 12 years; mean quiescent interval: 15 years; @flower2014], the Colorado Front Range [mean duration: 6.9 years; @weber1995DendroecologicalReconstructionWestern], and southern British Columbia [mean duration: 12 years; mean quiescent interval: 29 years; @campbell2006MulticenturyHistoryWestern]. However, outbreaks in our record were notably shorter and quiescent periods were longer than in dendroecological records from northern New Mexico [mean duration: 22 years; mean quiescent interval: 11 years; @swetnam1993] and central British Columbia [mean: 18 years; @harvey2018]. These differences likely reflect variation in tree-ring data collection and processing methods, but also highlight the need for more research that addresses the drivers of outbreak dynamics in space and time, as well as the need for infrastructure for sharing dendroecological data and research that integrates multiple studies.

## Inter-site synchrony

We found that WSB outbreaks occur synchronously across northern to central Colorado, consistent with previous dendroecological research [@swetnam1993; @flower2014; @axelsonMulticenturyReconstructionWestern2015; @ellis2017MulticenturyDendrochronologicalReconstruction]. For population of irruptive insects, temporal synchrony may arise from density-dependent processes (e.g., dispersal, predation) and/or Moran effects [@moran1953StatisticalAnalsisCanadian], where spatial autocorrelation in exogenous drivers, such as climate, leads to synchronicity of density-independent processes [@liebhold2004WithinpopulationSpatialSynchrony]. Here we found that both regional synchrony (`r Regional.synch %>% filter(years=="1730-1998" & dataset=="defoliated") %>% pull(synchrony) %>% round(2)`) and the spatial scale at which synchrony was statistically significant (≤50 km) were lower than we would expect if climate was the only driver. For instance, across the 12 drought-sensitive ponderosa pine chronologies used to remove climate-trends in host ring-width series, we calculated greater regional synchrony (`r Regional.synch %>% filter(years=="1730-1998" & dataset=="RWI") %>% pull(synchrony) %>% round(2)`) and significant correlations at greater distances (i.e, up to 100 km; Fig. \@ref(fig:FigCovarianceNonHost)). While budworms are strong fliers that can dispersing hundreds of kilometers in the right weather conditions [@greenbank1980SPRUCEBUDWORMLEPIDOPTERA; @willhite1983GeneticVariationWestern @sturtevant2013LongdistanceDispersalSpruce], most dispersal is thought to occur at much shorter distances (i.e., kilometers) [@senf2017MultiscaleAnalysisWestern]. These

This supports previous research on spatiotemporal patterns of contemporary WSB outbreak in British Columbia that has suggested that dispersal is key in driving the synchronization of WBS population dynamics [@senf2017MultiscaleAnalysisWestern]. Our records also show that outbreaks can develop concurrently in disjunct populations. For instance, evidence of the 1790s outbreak appears in the tree-ring record first in ca. 1784 at the TI site, the furthest north and west site in our dataset, and the WR site, which is east of the Continental Divide in the southern Front Range. the correspondence between periods of above-average moisture availability and periods of outbreak that we identified here suggests broad-scale climate variability is important in driving synchronicity in WSB population dynamics. Collectively, these findings confirm previous research that has argued that both dispersal and Moran effects are important in driving the synchrony of local populations of WSBs [@senf2017MultiscaleAnalysisWestern; @flower2014].

## Effects of Euro-American colonization on outbreak dynamics

Our results indicate that outbreak duration, frequency, and severity were comparable during the century prior to and following Euro-American colonization, but inter-site synchrony was lower in the 20th century. Additionally, our regional record shows a long quiescent period from 1925 to 1980. While none of the site examined here experienced severe disturbance in the past century, local WSB population dynamics are sensitive to landscape-level availability of host trees [@senf2017MultiscaleAnalysisWestern]. Thus the decrease in regional synchrony may reflect lower availability of hosts at the landscape scale and a reduction in the potential for dispersal to synchronize population development [@veblen1991ColoradoFrontRange; @swetnam1989; @hadleyStandResponseWestern1993; @weber1995DendroecologicalReconstructionWestern].

## Climate effects on outbreak dynamics

Our 300 year record of WSB outbreaks provides support for the idea that above average moisture availability increases forage digestibility and availability and thus higher population growth rates [@Price1991]. SEA analyses showed that WSB outbreaks were more likely to initiate during periods of above average moisture availability and end when moisture became more limiting. These findings are consistent with previously dendroecological research from the American Southwest, which has shown that years of outbreak co-occur with years of above average moisture availability [@swetnam1993].

that were typically proceeded by drought, consistent with the hypothesis that drought events may synchronize the irruption of disjunct populations of WSBs by increasing forage quality . Here we identified significant relationships between outbreak initiation and drought in the proceeding one to five years, as has been previously reported [@flower2014]. This apparent variation in the timing of the inciting drought may emerge for several reasons. First, dispersal between stands may result in a lag, consistent with bidirectional multivariate event analyses that showed that years of outbreak initiation were significantly clustered in a six year period. Second, the effect of defoliation on radial growth may be delayed because trees may use previously stored carbon for growth [@richardson2015DistributionMixingOld]. Indeed, dendrochronological studies of ongoing outbreaks show that the effect of defoliation on radial growth often lag defoliation by one to three years [@alfaroTreeMortalityRadial1982; @swetnam1985]. Third, the cumulative

Contrary to expectations, our results do not support the idea that site aridity drives the

However, we were only able to test this effect using a relative small number of sites. While not statistically significant, we found drought was more likely to proceed outbreak cessation at relatively arid sites.

While our study provides support for the hypothesis that drought followed by average moisture availability supports the development of WSB outbreaks, here we assessed the effect of climate variability on WSB outbreak dynamics using summer SC-PDSI, which is highly correlated with other climate variables (Fig. \@ref(fig:FigPDSIxClimateVar), many of which may also influence WSB outbreak dynamics [@nealis2021EcologyOutbreakPopulations]. For instance, summer SC-PDSI is positively correlated with spring (March-May) temperatures, which may affect WSB mortality due to freezing or destruction of food supplies [@fellinWesternSpruceBudworm1982; @regniereInfluenceTemperatureHistoric2019]. Thus the positive association between periods of above average moisture availability periods of WSB outbreak may in part reflect the effects of warmer temperatures on reduced WSB mortality. Untangling the direct effects versus of climate variation on insect populations versuses the indirect effects of climate variability on plants is critical to forecasting future outbreak dynamics (REF). For instance, in the WSB-Douglas fir system, exceptionally warm spring temperatures may alter the synchrony of WSB larval emergence and the timing of host tree bud burst, negatively impacting WSB population development rates [@chenMechanismsDouglasfirResistance2001; @nealisPhenologicalWindowWestern2012; @regniereInfluenceTemperatureHistoric2019]. Future projections of climate across the region suggest that temperatures may become warmer, thereby

We also highlight the need for more research that examines the effects of temp. Understanding these impacts is challenging given most dendrochonological reconstructions of climate focus on variables o

## Implications

# Acknowledgements

This research was supported the USDA National Institute of Food and Agriculture, McIntire-Stennis project COL00520, accession number 7002894. Additionally, we would like to the thank Colorado State University and the Colorado Mountain Club for supporting O. Santiago.

# References

::: {#refs}
:::

# Appendix A

```{r FigStudyAreaCWD, fig.cap="The study area and WSB reconstruction sample sites. The gray polygon illustrates the distribution of Douglas fir. Climatic water deficit (CWD) is average annual value in millimeters per year for the 1981-2010 period. The study area's location relative to the contiguous western United States is shown in the inset map.", out.width = "244.8pt", results='show'}
knitr::include_graphics(here("Results", "Figures", "FigStudyArea.jpg"))
```

\pagebreak

```{r hostmeta, results="show"}
host.meta.sub.print <- host.meta.sub[,c("SeriesCode", "SiteName", "nseries", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd", "Citation")]
host.meta.sub.print <- host.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
host.meta.sub.print$"Interseries r" <- paste0(host.meta.sub.print$"Interseries r" , ")")

host.meta.sub.print <-host.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
host.meta.sub.print$"Autocorrelation" <- paste0(host.meta.sub.print$"Autocorrelation" , ")")

host.meta.sub.print <- host.meta.sub.print[,c("SeriesCode", "SiteName", "nseries", "Interseries r", "Autocorrelation", "Citation")]

colnames(host.meta.sub.print)<- c("Site ID", "Site Name", "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation", "Citation")

ft <- flextable(host.meta.sub.print) 
ft <- set_caption(ft, caption="Chronology statistics for host sites.")
ft %>% autofit() %>% fit_to_width(7.5)
```

\pagebreak

```{r nonhostmeta, results="show"}
nonhost.meta.sub.print <- nonhost.meta.sub[,c("SeriesCode", "SiteName", "Lat", "Lon", "EarliestYr", "LatestYr", "nseries", "interrbar", "interrbar.sd", "ar1bar", "ar1bar.sd", "Citation")]
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(Lat:Lon), ~round(., 3))
nonhost.meta.sub.print <- nonhost.meta.sub.print %>% mutate_at(vars(interrbar:ar1bar.sd), ~round(., 2))

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Years", EarliestYr:LatestYr, sep="-")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Interseries r", interrbar:interrbar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Interseries r" <- paste0(nonhost.meta.sub.print$"Interseries r" , ")")

nonhost.meta.sub.print <-nonhost.meta.sub.print %>% tidyr::unite("Autocorrelation", ar1bar:ar1bar.sd, sep="\n(sd=")
nonhost.meta.sub.print$"Autocorrelation" <- paste0(nonhost.meta.sub.print$"Autocorrelation" , ")")

nonhost.meta.sub.print <- nonhost.meta.sub.print[,c("SeriesCode", "SiteName", "Lat", "Lon", "Years", "nseries", "Interseries r", "Autocorrelation", "Citation")]

colnames(nonhost.meta.sub.print)<- c("Site ID", "Site Name", "Latitude\n(degrees)", "Longitude\n(degrees)", "Chronology\nlength\n(years)" , "No.\nSeries", "Interseries\ncorrelation", "Autocorrelation", "Citation")

ft <- flextable(nonhost.meta.sub.print) 
ft <- set_caption(ft, caption="Site and chronology statistics for nonhost sites.")
ft %>% autofit() %>% fit_to_width(7.5)
```

\pagebreak

```{r FigPercDefol, fig.cap="Site-level outbreak records expressed as the percent of trees recording an infestation.", out.width="4.48in", results="show"}
knitr::include_graphics(here("Results", "Figures", "Fig-PercentDefoliated.jpg"))
```

\pagebreak

```{r colonizationtab, results='show'}
colnames(colonization.results) <- c("Response", "Coefficient", "p value")
ft <- flextable(colonization.results) 
ft <- set_caption(ft, caption="Summary of modelling results testing the effect of Euro-Americans on WSB outbreak dynamics and ecological effects .")
ft %>% autofit() %>% fit_to_width(7.5)
```

```{r FigPairwiseCor,  fig.cap="Pairwise Spearman's correlation between time series of the percent of trees defoliated at each site.", out.width = "4.48in", out.height="3in", results="show"}
knitr::include_graphics(here("Results", "Figures", "Fig-PairwiseCorrelation.jpg"))
```

```{r FigCovarianceSCPDSI, fig.cap="Nonparametric spatial covariance function describing the covarinace among times series SC-PDSI at all 12 sites across study area. SC-PDSI time series are derived from 4 x 4 km PRISM data for the period 1895-2022. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-SCPDSI.jpg"))
```

```{r FigCovarianceNonHost, fig.cap="Nonparametric spatial covariance function describing the covarinace among the 12 drought-sensitive ponderosa pine chronologies used to reconstruct WSB histories. Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "3.4in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Nonhost.jpg"))
```

```{r FigCovarianceTime, fig.cap="Nonparametric spatial covariance function describing the covarinace among time series of the percent of trees defoliated at site for the 1730-1998 and the centuries prior to and following  extensive Euro-American settlement (1750-1848 and 1890-1989, respectively). Gray shading indicates the 95% confidence interval based on 1,000 bootstrap replications. The dashed horizontal line indicates the average correlation across the study area (regional synchrony)", out.width = "7in", results="show"}
knitr::include_graphics(here("Results", "Figures", "FigCovariance-Multi.jpg"))
```

```{r FigPDSIbyTimePeriod,fig.cap="SC-PDSI values during the centuries prior to and following  extensive Euro-American settlement (1750-1848 and 1890-1989, respectively). Letters above boxes indicate statistically significant differences. The bottom and top limits of each box are the lower and upper quartiles, respectively; the thick black line within the box is the median; error bars equal ±1.5 times the interquartile range; and points denote outliers, values outside ±1.5 times the interquartile range.", out.width = "244.8pt", results="show"}
knitr::include_graphics(here("Results", "Figures", "T-PDSI.jpg"))
```

```{r FigSEASiteInitiation, fig.cap="Superposed epoch analyses results illustrating the departure from the mean SC-PDSI for the years prior, during, and following outbreak initiation by site for the 1730-1998 period. Descending bars illustrate a negative association with SC-PDSI (i.e., drier conditions), ascending bars show a positive association with SC-PDSI (i.e., wetter conditions). Black bars indicate statistically significance at the 95% confidence interval.", out.width = "504pt", results="show"}
knitr::include_graphics(here("Results", "Figures", "SEA-initation-site.jpg"))
```

```{r FigSEASiteCessation, fig.cap="Superposed epoch analysis results illustrating the departure from the mean SC-PDSI for the years prior, during, and following outbreak cessation by site for the 1730-1998 period. Descending bars illustrate a negative association with SC-PDSI (i.e., drier conditions), ascending bars show a positive association with SC-PDSI (i.e., wetter conditions). Black bars indicate statistically significance at the 95% confidence interval.", out.width = "504pt", results="show"}
knitr::include_graphics(here("Results", "Figures", "SEA-cessation-site.jpg"))
```

```{r FigSEASiteComboTime, fig.cap="Summary of site-level superposed epoch analyses illustrating the association between SC-PDSI and outbreak initation (A-C) and cessation (D-E) for the 1730-1998 period and the centuries prior to and following  extensive Euro-American settlement (1750-1848 and 1890-1989, respectively). Red descending bars illustrate the number of sites with a statitcally significant negative association with SC-PDSI (i.e., drier conditions), blue ascending bars show the number of sites with a statistically significant positive association with SC-PDSI (i.e., wetter conditions).", out.width = "7in", results="show"}

knitr::include_graphics(here("Results", "Figures","SEA-combo-site-timeperiod.jpg"))
```

\pagebreak

```{r icwdtab, results="show"}
sea.cwd.res.initiation$coefficient <- round(sea.cwd.res.initiation$coefficient, 3)
sea.cwd.res.initiation$std.error <- round(sea.cwd.res.initiation$std.error,3)
sea.cwd.res.initiation$p.value <- round(sea.cwd.res.initiation$p.value,3)
colnames(sea.cwd.res.initiation) <- c("lag (years)", "coefficient", "standard error", "p value")
ft <- flextable(sea.cwd.res.initiation) 
ft <- set_caption(ft, caption="Summary of linear models that tested if site climatic water deficit (CWD) was related to the departure from the mean SC-PDSI for the years prior, during, and following outbreak initiation.")
ft %>% autofit() %>% set_table_properties(layout = "autofit")
```

\pagebreak

```{r ccwdtab, results="show"}
sea.cwd.res.cessation$coefficient <- round(sea.cwd.res.cessation$coefficient, 3)
sea.cwd.res.cessation$std.error <- round(sea.cwd.res.cessation$std.error,3)
sea.cwd.res.cessation$p.value <- round(sea.cwd.res.cessation$p.value,3)
colnames(sea.cwd.res.cessation) <- c("lag (years)", "coefficient", "standard error", "p value")
ft <- flextable(sea.cwd.res.cessation) 
ft <- set_caption(ft, caption="Summary of linear models that tested if site climatic water deficit (CWD) was related to the departure from the mean SC-PDSI for the years prior, during, and following outbreak cessation.")
ft %>% autofit() %>% set_table_properties(layout = "autofit")
```

```{r FigPDSIperiod, fig.cap="Climate conditions in the dry period prior and wet period coincident with periods of regional outbreak relative to all periods of above average moisture availability.", out.width = "7in", results="show"}
knitr::include_graphics(here("Results", "Figures","outbreak-PDSIperiod.jpg"))
```

\pagebreak

```{r PDSIperiodtab, results="show"}
results.timeperiod <- rbind(results.timeperiod, results.timeperiod2) %>% filter(period %in% c("wet period concurrent with outbreak initiation", "dry period prior to outbreak initiation", "wet period concurrent with outbreak cessation", "dry period following outbreak cessation"))
results.timeperiod <- results.timeperiod[,c("event", "period", "variable", "t", "p.value")]
colnames(results.timeperiod) <- c("Event", "Period", "Metric", "t-statistic", "p-value")
results.timeperiod <- results.timeperiod[,-1]
results.timeperiod %>% as.data.frame() %>%  flextable() %>% set_caption(caption="Results of t-tests comparing the climate conditions in the dry period prior and wet period coincident outbreak initaiton with all periods of above average moisture availability.") %>%  autofit() %>% set_table_properties(layout = "autofit")
```

\pagebreak

```{r FigPDSIxClimateVar,fig.cap="The correlation between regional time series of summer SC-PDSI and monthly total precipitation (PPT), mean daily temperature (TMEAN),  and maximum daily vapour presssure deficit (VPD) (1895-2022).", out.width = "244.8pt", results="show"}
prism.JJA <- read.csv(here("Data", "prism-JJA.csv"))
prism.JJA$AVG <- rowMeans(prism.JJA[, as.character(host.meta.sub$SeriesCode)])
prism.tmean <- read.csv(here("Data", "prism-tmean.csv"))
prism.tmean$AVG <- rowMeans(prism.tmean[, as.character(host.meta.sub$SeriesCode)])

prism.ppt <- read.csv(here("Data", "prism-ppt.csv"))
prism.ppt$AVG <- rowMeans(prism.ppt[, as.character(host.meta.sub$SeriesCode)])
prism.vpdmax <- read.csv(here("Data", "prism-vpdmax.csv"))
 prism.vpdmax$AVG <- rowMeans(prism.vpdmax[, as.character(host.meta.sub$SeriesCode)])


res <- data.frame(variable="TMEAN", month=1:12, r=NA,t=NA, p=NA)
for(j in 1:12){
  x <- cor.test(prism.JJA$AVG, prism.tmean[prism.tmean$month==j & prism.tmean$year %in% prism.JJA$X,]$AVG)
  res[res$month==j, ]$r <- x$estimate
  res[res$month==j, ]$t <- x$statistic
  res[res$month==j, ]$p <- x$p.value
}
res.tmean <- res

res <- data.frame(variable="PPT", month=1:12, r=NA,t=NA, p=NA)
for(j in 1:12){
  x <- cor.test(prism.JJA$AVG, prism.ppt[prism.ppt$month==j & prism.ppt$year %in% prism.JJA$X,]$AVG)
  res[res$month==j, ]$r <- x$estimate
  res[res$month==j, ]$t <- x$statistic
  res[res$month==j, ]$p <- x$p.value
}
res.ppt <- res

res <- data.frame(variable="VPD", month=1:12, r=NA,t=NA, p=NA)
for(j in 1:12){
  x <- cor.test(prism.JJA$AVG, prism.vpdmax[prism.vpdmax$month==j & prism.vpdmax$year %in% prism.JJA$X,]$AVG)
  res[res$month==j, ]$r <- x$estimate
  res[res$month==j, ]$t <- x$statistic
  res[res$month==j, ]$p <- x$p.value
}
res.vpd <- res

res <- rbind(rbind(res.tmean, res.ppt), res.vpd)
  
Fig.file <- here("Results", "Figures", "PDSIxTMEAN.jpg")
jpeg(Fig.file, width=fig.width1, height=3.5, units="in", res=300)
 ggplot(res, aes(x=factor(month), y=r, fill=variable))+geom_bar(stat="identity", position="dodge") +xlab("month")+ylab("correlation")+theme(legend.title=element_blank(),legend.position = 'bottom')+ylim(-0.5, 0.5)+scale_fill_manual(values=c('#0072B2', '#DC3220', 'gray'))
whatever <- dev.off() 

knitr::include_graphics(here("Results", "Figures", "PDSIxTMEAN.jpg"))
```

\pagebreak

# Appendix B

```{r historytab, results='show'}
history.tab <- read_excel(here("Documents", "PublishedOutbreakHistory.xlsx"), sheet=1)
colnames(history.tab) <- c("Start", "End", "Duration\n(years)", "Study area", "Source")

history.tab %>% as.data.frame() %>%  flextable() %>% set_caption(caption="Published periods of WSB outbreak in Colorado.") %>%  autofit() %>% set_table_properties(layout = "autofit")
```

```{r comparedistances, eval=F}

flower <- read.csv(here("Data", "Flower2014-Table1.csv"))
flower.sites <- st_as_sf(x = flower, 
                        coords = c("Longitude", "Latitude"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(5070)
st_distance(flower.sites)[st_distance(flower.sites) %>% upper.tri()] %>% mean()
host.meta.sub <- host.meta %>% filter(SeriesCode %in% hostxnonhost$host)
host.meta.sub.sites <- st_as_sf(x = host.meta.sub, 
                        coords = c("Lon", "Lat"),
                        crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs") %>% st_transform(5070)
st_distance(host.meta.sub.sites)[st_distance(host.meta.sub.sites) %>% upper.tri()] %>% mean()
```
